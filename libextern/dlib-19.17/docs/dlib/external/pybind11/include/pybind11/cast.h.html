<html><!-- Created using the cpp_pretty_printer from the dlib C++ library.  See http://dlib.net for updates. --><head><title>dlib C++ Library - cast.h</title></head><body bgcolor='white'><pre>
<font color='#009900'>/*
    pybind11/cast.h: Partial template specializations to cast between
    C++ and Python types

    Copyright (c) 2016 Wenzel Jakob &lt;wenzel.jakob@epfl.ch&gt;

    All rights reserved. Use of this source code is governed by a
    BSD-style license that can be found in the LICENSE file.
*/</font>

<font color='#0000FF'>#pragma</font> once

<font color='#0000FF'>#include</font> "<a style='text-decoration:none' href='pytypes.h.html'>pytypes.h</a>"
<font color='#0000FF'>#include</font> "<a style='text-decoration:none' href='detail/typeid.h.html'>detail/typeid.h</a>"
<font color='#0000FF'>#include</font> "<a style='text-decoration:none' href='detail/descr.h.html'>detail/descr.h</a>"
<font color='#0000FF'>#include</font> "<a style='text-decoration:none' href='detail/internals.h.html'>detail/internals.h</a>"
<font color='#0000FF'>#include</font> <font color='#5555FF'>&lt;</font>array<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>#include</font> <font color='#5555FF'>&lt;</font>limits<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>#include</font> <font color='#5555FF'>&lt;</font>tuple<font color='#5555FF'>&gt;</font>

<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>PYBIND11_CPP17<font face='Lucida Console'>)</font>
#  <font color='#0000FF'>if</font> <b><a name='defined'></a>defined</b><font face='Lucida Console'>(</font>__has_include<font face='Lucida Console'>)</font>
#    <font color='#0000FF'>if</font> <b><a name='__has_include'></a>__has_include</b><font face='Lucida Console'>(</font><font color='#5555FF'>&lt;</font>string_view<font color='#5555FF'>&gt;</font><font face='Lucida Console'>)</font>
#      define PYBIND11_HAS_STRING_VIEW
#    endif
#  elif <b><a name='defined'></a>defined</b><font face='Lucida Console'>(</font>_MSC_VER<font face='Lucida Console'>)</font>
#    define PYBIND11_HAS_STRING_VIEW
#  endif
<font color='#0000FF'>#endif</font>
<font color='#0000FF'>#ifdef</font> PYBIND11_HAS_STRING_VIEW
<font color='#0000FF'>#include</font> <font color='#5555FF'>&lt;</font>string_view<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>#endif</font>

<b><a name='NAMESPACE_BEGIN'></a>NAMESPACE_BEGIN</b><font face='Lucida Console'>(</font>PYBIND11_NAMESPACE<font face='Lucida Console'>)</font>
<b><a name='NAMESPACE_BEGIN'></a>NAMESPACE_BEGIN</b><font face='Lucida Console'>(</font>detail<font face='Lucida Console'>)</font>

<font color='#009900'>/// A life support system for temporary objects created by `type_caster::load()`.
</font><font color='#009900'>/// Adding a patient will keep it alive up until the enclosing function returns.
</font><font color='#0000FF'>class</font> <b><a name='loader_life_support'></a>loader_life_support</b> <b>{</b>
<font color='#0000FF'>public</font>:
    <font color='#009900'>/// A new patient frame is created when a function is entered
</font>    <b><a name='loader_life_support'></a>loader_life_support</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#BB00BB'>get_internals</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>.loader_patient_stack.<font color='#BB00BB'>push_back</font><font face='Lucida Console'>(</font>nullptr<font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#009900'>/// ... and destroyed after it returns
</font>    ~<b><a name='loader_life_support'></a>loader_life_support</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>auto</font> <font color='#5555FF'>&amp;</font>stack <font color='#5555FF'>=</font> <font color='#BB00BB'>get_internals</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>.loader_patient_stack;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>stack.<font color='#BB00BB'>empty</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
            <font color='#BB00BB'>pybind11_fail</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>loader_life_support: internal error</font>"<font face='Lucida Console'>)</font>;

        <font color='#0000FF'>auto</font> ptr <font color='#5555FF'>=</font> stack.<font color='#BB00BB'>back</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        stack.<font color='#BB00BB'>pop_back</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <font color='#BB00BB'>Py_CLEAR</font><font face='Lucida Console'>(</font>ptr<font face='Lucida Console'>)</font>;

        <font color='#009900'>// A heuristic to reduce the stack's capacity (e.g. after long recursive calls)
</font>        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>stack.<font color='#BB00BB'>capacity</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font> <font color='#979000'>16</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> stack.<font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> stack.<font color='#BB00BB'>capacity</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>/</font> stack.<font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font>
            stack.<font color='#BB00BB'>shrink_to_fit</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#009900'>/// This can only be used inside a pybind11-bound function, either by `argument_loader`
</font>    <font color='#009900'>/// at argument preparation time or by `py::cast()` at execution time.
</font>    PYBIND11_NOINLINE <font color='#0000FF'>static</font> <font color='#0000FF'><u>void</u></font> <b><a name='add_patient'></a>add_patient</b><font face='Lucida Console'>(</font>handle h<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>auto</font> <font color='#5555FF'>&amp;</font>stack <font color='#5555FF'>=</font> <font color='#BB00BB'>get_internals</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>.loader_patient_stack;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>stack.<font color='#BB00BB'>empty</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
            <font color='#0000FF'>throw</font> <font color='#BB00BB'>cast_error</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>When called outside a bound function, py::cast() cannot </font>"
                             "<font color='#CC0000'>do Python -&gt; C++ conversions which require the creation </font>"
                             "<font color='#CC0000'>of temporary values</font>"<font face='Lucida Console'>)</font>;

        <font color='#0000FF'>auto</font> <font color='#5555FF'>&amp;</font>list_ptr <font color='#5555FF'>=</font> stack.<font color='#BB00BB'>back</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>list_ptr <font color='#5555FF'>=</font><font color='#5555FF'>=</font> nullptr<font face='Lucida Console'>)</font> <b>{</b>
            list_ptr <font color='#5555FF'>=</font> <font color='#BB00BB'>PyList_New</font><font face='Lucida Console'>(</font><font color='#979000'>1</font><font face='Lucida Console'>)</font>;
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>list_ptr<font face='Lucida Console'>)</font>
                <font color='#BB00BB'>pybind11_fail</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>loader_life_support: error allocating list</font>"<font face='Lucida Console'>)</font>;
            <font color='#BB00BB'>PyList_SET_ITEM</font><font face='Lucida Console'>(</font>list_ptr, <font color='#979000'>0</font>, h.<font color='#BB00BB'>inc_ref</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        <b>}</b> <font color='#0000FF'>else</font> <b>{</b>
            <font color='#0000FF'>auto</font> result <font color='#5555FF'>=</font> <font color='#BB00BB'>PyList_Append</font><font face='Lucida Console'>(</font>list_ptr, h.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>result <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#5555FF'>-</font><font color='#979000'>1</font><font face='Lucida Console'>)</font>
                <font color='#BB00BB'>pybind11_fail</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>loader_life_support: error adding patient</font>"<font face='Lucida Console'>)</font>;
        <b>}</b>
    <b>}</b>
<b>}</b>;

<font color='#009900'>// Gets the cache entry for the given type, creating it if necessary.  The return value is the pair
</font><font color='#009900'>// returned by emplace, i.e. an iterator for the entry and a bool set to `true` if the entry was
</font><font color='#009900'>// just created.
</font><font color='#0000FF'>inline</font> std::pair<font color='#5555FF'>&lt;</font><b><a name='decltype'></a>decltype</b><font face='Lucida Console'>(</font>internals::registered_types_py<font face='Lucida Console'>)</font>::iterator, <font color='#0000FF'><u>bool</u></font><font color='#5555FF'>&gt;</font> all_type_info_get_cache<font face='Lucida Console'>(</font>PyTypeObject <font color='#5555FF'>*</font>type<font face='Lucida Console'>)</font>;

<font color='#009900'>// Populates a just-created cache entry.
</font>PYBIND11_NOINLINE <font color='#0000FF'>inline</font> <font color='#0000FF'><u>void</u></font> all_type_info_populate<font face='Lucida Console'>(</font>PyTypeObject <font color='#5555FF'>*</font>t, std::vector<font color='#5555FF'>&lt;</font>type_info <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font> <font color='#5555FF'>&amp;</font>bases<font face='Lucida Console'>)</font> <b>{</b>
    std::vector<font color='#5555FF'>&lt;</font>PyTypeObject <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font> check;
    <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>handle parent : reinterpret_borrow<font color='#5555FF'>&lt;</font>tuple<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>t<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>tp_bases<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
        check.<font color='#BB00BB'>push_back</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>PyTypeObject <font color='#5555FF'>*</font><font face='Lucida Console'>)</font> parent.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

    <font color='#0000FF'>auto</font> <font color='#0000FF'>const</font> <font color='#5555FF'>&amp;</font>type_dict <font color='#5555FF'>=</font> <font color='#BB00BB'>get_internals</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>.registered_types_py;
    <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>size_t</u></font> i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> check.<font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>auto</font> type <font color='#5555FF'>=</font> check[i];
        <font color='#009900'>// Ignore Python2 old-style class super type:
</font>        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>PyType_Check</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>PyObject <font color='#5555FF'>*</font><font face='Lucida Console'>)</font> type<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#0000FF'>continue</font>;

        <font color='#009900'>// Check `type` in the current set of registered python types:
</font>        <font color='#0000FF'>auto</font> it <font color='#5555FF'>=</font> type_dict.<font color='#BB00BB'>find</font><font face='Lucida Console'>(</font>type<font face='Lucida Console'>)</font>;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>it <font color='#5555FF'>!</font><font color='#5555FF'>=</font> type_dict.<font color='#BB00BB'>end</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
            <font color='#009900'>// We found a cache entry for it, so it's either pybind-registered or has pre-computed
</font>            <font color='#009900'>// pybind bases, but we have to make sure we haven't already seen the type(s) before: we
</font>            <font color='#009900'>// want to follow Python/virtual C++ rules that there should only be one instance of a
</font>            <font color='#009900'>// common base.
</font>            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font><font color='#0000FF'>auto</font> <font color='#5555FF'>*</font>tinfo : it<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>second<font face='Lucida Console'>)</font> <b>{</b>
                <font color='#009900'>// NB: Could use a second set here, rather than doing a linear search, but since
</font>                <font color='#009900'>// having a large number of immediate pybind11-registered types seems fairly
</font>                <font color='#009900'>// unlikely, that probably isn't worthwhile.
</font>                <font color='#0000FF'><u>bool</u></font> found <font color='#5555FF'>=</font> <font color='#979000'>false</font>;
                <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font><font color='#0000FF'>auto</font> <font color='#5555FF'>*</font>known : bases<font face='Lucida Console'>)</font> <b>{</b>
                    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>known <font color='#5555FF'>=</font><font color='#5555FF'>=</font> tinfo<font face='Lucida Console'>)</font> <b>{</b> found <font color='#5555FF'>=</font> <font color='#979000'>true</font>; <font color='#0000FF'>break</font>; <b>}</b>
                <b>}</b>
                <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>found<font face='Lucida Console'>)</font> bases.<font color='#BB00BB'>push_back</font><font face='Lucida Console'>(</font>tinfo<font face='Lucida Console'>)</font>;
            <b>}</b>
        <b>}</b>
        <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>type<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>tp_bases<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#009900'>// It's some python type, so keep follow its bases classes to look for one or more
</font>            <font color='#009900'>// registered types
</font>            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>+</font> <font color='#979000'>1</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> check.<font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
                <font color='#009900'>// When we're at the end, we can pop off the current element to avoid growing
</font>                <font color='#009900'>// `check` when adding just one base (which is typical--i.e. when there is no
</font>                <font color='#009900'>// multiple inheritance)
</font>                check.<font color='#BB00BB'>pop_back</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
                i<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
            <b>}</b>
            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>handle parent : reinterpret_borrow<font color='#5555FF'>&lt;</font>tuple<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>type<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>tp_bases<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
                check.<font color='#BB00BB'>push_back</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>PyTypeObject <font color='#5555FF'>*</font><font face='Lucida Console'>)</font> parent.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        <b>}</b>
    <b>}</b>
<b>}</b>

<font color='#009900'>/**
 * Extracts vector of type_info pointers of pybind-registered roots of the given Python type.  Will
 * be just 1 pybind type for the Python type of a pybind-registered class, or for any Python-side
 * derived class that uses single inheritance.  Will contain as many types as required for a Python
 * class that uses multiple inheritance to inherit (directly or indirectly) from multiple
 * pybind-registered classes.  Will be empty if neither the type nor any base classes are
 * pybind-registered.
 *
 * The value is cached for the lifetime of the Python type.
 */</font>
<font color='#0000FF'>inline</font> <font color='#0000FF'>const</font> std::vector<font color='#5555FF'>&lt;</font>detail::type_info <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font> <font color='#5555FF'>&amp;</font><b><a name='all_type_info'></a>all_type_info</b><font face='Lucida Console'>(</font>PyTypeObject <font color='#5555FF'>*</font>type<font face='Lucida Console'>)</font> <b>{</b>
    <font color='#0000FF'>auto</font> ins <font color='#5555FF'>=</font> <font color='#BB00BB'>all_type_info_get_cache</font><font face='Lucida Console'>(</font>type<font face='Lucida Console'>)</font>;
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>ins.second<font face='Lucida Console'>)</font>
        <font color='#009900'>// New cache entry: populate it
</font>        <font color='#BB00BB'>all_type_info_populate</font><font face='Lucida Console'>(</font>type, ins.first<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>second<font face='Lucida Console'>)</font>;

    <font color='#0000FF'>return</font> ins.first<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>second;
<b>}</b>

<font color='#009900'>/**
 * Gets a single pybind11 type info for a python type.  Returns nullptr if neither the type nor any
 * ancestors are pybind11-registered.  Throws an exception if there are multiple bases--use
 * `all_type_info` instead if you want to support multiple bases.
 */</font>
PYBIND11_NOINLINE <font color='#0000FF'>inline</font> detail::type_info<font color='#5555FF'>*</font> <b><a name='get_type_info'></a>get_type_info</b><font face='Lucida Console'>(</font>PyTypeObject <font color='#5555FF'>*</font>type<font face='Lucida Console'>)</font> <b>{</b>
    <font color='#0000FF'>auto</font> <font color='#5555FF'>&amp;</font>bases <font color='#5555FF'>=</font> <font color='#BB00BB'>all_type_info</font><font face='Lucida Console'>(</font>type<font face='Lucida Console'>)</font>;
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>bases.<font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
        <font color='#0000FF'>return</font> nullptr;
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>bases.<font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>
        <font color='#BB00BB'>pybind11_fail</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>pybind11::detail::get_type_info: type has multiple pybind11-registered bases</font>"<font face='Lucida Console'>)</font>;
    <font color='#0000FF'>return</font> bases.<font color='#BB00BB'>front</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#0000FF'>inline</font> detail::type_info <font color='#5555FF'>*</font><b><a name='get_local_type_info'></a>get_local_type_info</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> std::type_index <font color='#5555FF'>&amp;</font>tp<font face='Lucida Console'>)</font> <b>{</b>
    <font color='#0000FF'>auto</font> <font color='#5555FF'>&amp;</font>locals <font color='#5555FF'>=</font> <font color='#BB00BB'>registered_local_types_cpp</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
    <font color='#0000FF'>auto</font> it <font color='#5555FF'>=</font> locals.<font color='#BB00BB'>find</font><font face='Lucida Console'>(</font>tp<font face='Lucida Console'>)</font>;
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>it <font color='#5555FF'>!</font><font color='#5555FF'>=</font> locals.<font color='#BB00BB'>end</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
        <font color='#0000FF'>return</font> it<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>second;
    <font color='#0000FF'>return</font> nullptr;
<b>}</b>

<font color='#0000FF'>inline</font> detail::type_info <font color='#5555FF'>*</font><b><a name='get_global_type_info'></a>get_global_type_info</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> std::type_index <font color='#5555FF'>&amp;</font>tp<font face='Lucida Console'>)</font> <b>{</b>
    <font color='#0000FF'>auto</font> <font color='#5555FF'>&amp;</font>types <font color='#5555FF'>=</font> <font color='#BB00BB'>get_internals</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>.registered_types_cpp;
    <font color='#0000FF'>auto</font> it <font color='#5555FF'>=</font> types.<font color='#BB00BB'>find</font><font face='Lucida Console'>(</font>tp<font face='Lucida Console'>)</font>;
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>it <font color='#5555FF'>!</font><font color='#5555FF'>=</font> types.<font color='#BB00BB'>end</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
        <font color='#0000FF'>return</font> it<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>second;
    <font color='#0000FF'>return</font> nullptr;
<b>}</b>

<font color='#009900'>/// Return the type info for a given C++ type; on lookup failure can either throw or return nullptr.
</font>PYBIND11_NOINLINE <font color='#0000FF'>inline</font> detail::type_info <font color='#5555FF'>*</font><b><a name='get_type_info'></a>get_type_info</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> std::type_index <font color='#5555FF'>&amp;</font>tp,
                                                          <font color='#0000FF'><u>bool</u></font> throw_if_missing <font color='#5555FF'>=</font> <font color='#979000'>false</font><font face='Lucida Console'>)</font> <b>{</b>
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#0000FF'>auto</font> ltype <font color='#5555FF'>=</font> <font color='#BB00BB'>get_local_type_info</font><font face='Lucida Console'>(</font>tp<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
        <font color='#0000FF'>return</font> ltype;
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#0000FF'>auto</font> gtype <font color='#5555FF'>=</font> <font color='#BB00BB'>get_global_type_info</font><font face='Lucida Console'>(</font>tp<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
        <font color='#0000FF'>return</font> gtype;

    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>throw_if_missing<font face='Lucida Console'>)</font> <b>{</b>
        std::string tname <font color='#5555FF'>=</font> tp.<font color='#BB00BB'>name</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        detail::<font color='#BB00BB'>clean_type_id</font><font face='Lucida Console'>(</font>tname<font face='Lucida Console'>)</font>;
        <font color='#BB00BB'>pybind11_fail</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>pybind11::detail::get_type_info: unable to find type info for \"</font>" <font color='#5555FF'>+</font> tname <font color='#5555FF'>+</font> "<font color='#CC0000'>\"</font>"<font face='Lucida Console'>)</font>;
    <b>}</b>
    <font color='#0000FF'>return</font> nullptr;
<b>}</b>

PYBIND11_NOINLINE <font color='#0000FF'>inline</font> handle <b><a name='get_type_handle'></a>get_type_handle</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> std::type_info <font color='#5555FF'>&amp;</font>tp, <font color='#0000FF'><u>bool</u></font> throw_if_missing<font face='Lucida Console'>)</font> <b>{</b>
    detail::type_info <font color='#5555FF'>*</font>type_info <font color='#5555FF'>=</font> <font color='#BB00BB'>get_type_info</font><font face='Lucida Console'>(</font>tp, throw_if_missing<font face='Lucida Console'>)</font>;
    <font color='#0000FF'>return</font> <font color='#BB00BB'>handle</font><font face='Lucida Console'>(</font>type_info ? <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>PyObject <font color='#5555FF'>*</font><font face='Lucida Console'>)</font> type_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>type<font face='Lucida Console'>)</font> : nullptr<font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#0000FF'>struct</font> <b><a name='value_and_holder'></a>value_and_holder</b> <b>{</b>
    instance <font color='#5555FF'>*</font>inst;
    <font color='#0000FF'><u>size_t</u></font> index;
    <font color='#0000FF'>const</font> detail::type_info <font color='#5555FF'>*</font>type;
    <font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font><font color='#5555FF'>*</font>vh;

    <font color='#009900'>// Main constructor for a found value/holder:
</font>    <b><a name='value_and_holder'></a>value_and_holder</b><font face='Lucida Console'>(</font>instance <font color='#5555FF'>*</font>i, <font color='#0000FF'>const</font> detail::type_info <font color='#5555FF'>*</font>type, <font color='#0000FF'><u>size_t</u></font> vpos, <font color='#0000FF'><u>size_t</u></font> index<font face='Lucida Console'>)</font> :
        inst<b>{</b>i<b>}</b>, index<b>{</b>index<b>}</b>, type<b>{</b>type<b>}</b>,
        vh<b>{</b>inst<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>simple_layout ? inst<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>simple_value_holder : <font color='#5555FF'>&amp;</font>inst<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>nonsimple.values_and_holders[vpos]<b>}</b>
    <b>{</b><b>}</b>

    <font color='#009900'>// Default constructor (used to signal a value-and-holder not found by get_value_and_holder())
</font>    <b><a name='value_and_holder'></a>value_and_holder</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> : inst<b>{</b>nullptr<b>}</b> <b>{</b><b>}</b>

    <font color='#009900'>// Used for past-the-end iterator
</font>    <b><a name='value_and_holder'></a>value_and_holder</b><font face='Lucida Console'>(</font><font color='#0000FF'><u>size_t</u></font> index<font face='Lucida Console'>)</font> : index<b>{</b>index<b>}</b> <b>{</b><b>}</b>

    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> V <font color='#5555FF'>=</font> <font color='#0000FF'><u>void</u></font><font color='#5555FF'>&gt;</font> V <font color='#5555FF'>*</font><font color='#5555FF'>&amp;</font><b><a name='value_ptr'></a>value_ptr</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b>
        <font color='#0000FF'>return</font> <font color='#0000FF'>reinterpret_cast</font><font color='#5555FF'>&lt;</font>V <font color='#5555FF'>*</font><font color='#5555FF'>&amp;</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>vh[<font color='#979000'>0</font>]<font face='Lucida Console'>)</font>;
    <b>}</b>
    <font color='#009900'>// True if this `value_and_holder` has a non-null value pointer
</font>    <font color='#0000FF'>explicit</font> <b><a name='operator'></a>operator</b> <font color='#0000FF'><u>bool</u></font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b> <font color='#0000FF'>return</font> <font color='#BB00BB'>value_ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>; <b>}</b>

    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> H<font color='#5555FF'>&gt;</font> H <font color='#5555FF'>&amp;</font><b><a name='holder'></a>holder</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b>
        <font color='#0000FF'>return</font> <font color='#0000FF'>reinterpret_cast</font><font color='#5555FF'>&lt;</font>H <font color='#5555FF'>&amp;</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>vh[<font color='#979000'>1</font>]<font face='Lucida Console'>)</font>;
    <b>}</b>
    <font color='#0000FF'><u>bool</u></font> <b><a name='holder_constructed'></a>holder_constructed</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b>
        <font color='#0000FF'>return</font> inst<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>simple_layout
            ? inst<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>simple_holder_constructed
            : inst<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>nonsimple.status[index] <font color='#5555FF'>&amp;</font> instance::status_holder_constructed;
    <b>}</b>
    <font color='#0000FF'><u>void</u></font> <b><a name='set_holder_constructed'></a>set_holder_constructed</b><font face='Lucida Console'>(</font><font color='#0000FF'><u>bool</u></font> v <font color='#5555FF'>=</font> <font color='#979000'>true</font><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>inst<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>simple_layout<font face='Lucida Console'>)</font>
            inst<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>simple_holder_constructed <font color='#5555FF'>=</font> v;
        <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>v<font face='Lucida Console'>)</font>
            inst<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>nonsimple.status[index] <font color='#5555FF'>|</font><font color='#5555FF'>=</font> instance::status_holder_constructed;
        <font color='#0000FF'>else</font>
            inst<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>nonsimple.status[index] <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>uint8_t<font face='Lucida Console'>)</font> ~instance::status_holder_constructed;
    <b>}</b>
    <font color='#0000FF'><u>bool</u></font> <b><a name='instance_registered'></a>instance_registered</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b>
        <font color='#0000FF'>return</font> inst<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>simple_layout
            ? inst<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>simple_instance_registered
            : inst<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>nonsimple.status[index] <font color='#5555FF'>&amp;</font> instance::status_instance_registered;
    <b>}</b>
    <font color='#0000FF'><u>void</u></font> <b><a name='set_instance_registered'></a>set_instance_registered</b><font face='Lucida Console'>(</font><font color='#0000FF'><u>bool</u></font> v <font color='#5555FF'>=</font> <font color='#979000'>true</font><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>inst<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>simple_layout<font face='Lucida Console'>)</font>
            inst<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>simple_instance_registered <font color='#5555FF'>=</font> v;
        <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>v<font face='Lucida Console'>)</font>
            inst<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>nonsimple.status[index] <font color='#5555FF'>|</font><font color='#5555FF'>=</font> instance::status_instance_registered;
        <font color='#0000FF'>else</font>
            inst<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>nonsimple.status[index] <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>uint8_t<font face='Lucida Console'>)</font> ~instance::status_instance_registered;
    <b>}</b>
<b>}</b>;

<font color='#009900'>// Container for accessing and iterating over an instance's values/holders
</font><font color='#0000FF'>struct</font> <b><a name='values_and_holders'></a>values_and_holders</b> <b>{</b>
<font color='#0000FF'>private</font>:
    instance <font color='#5555FF'>*</font>inst;
    <font color='#0000FF'>using</font> type_vec <font color='#5555FF'>=</font> std::vector<font color='#5555FF'>&lt;</font>detail::type_info <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font>;
    <font color='#0000FF'>const</font> type_vec <font color='#5555FF'>&amp;</font>tinfo;

<font color='#0000FF'>public</font>:
    <b><a name='values_and_holders'></a>values_and_holders</b><font face='Lucida Console'>(</font>instance <font color='#5555FF'>*</font>inst<font face='Lucida Console'>)</font> : inst<b>{</b>inst<b>}</b>, <b><a name='tinfo'></a>tinfo</b><font face='Lucida Console'>(</font><font color='#BB00BB'>all_type_info</font><font face='Lucida Console'>(</font><font color='#BB00BB'>Py_TYPE</font><font face='Lucida Console'>(</font>inst<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b><b>}</b>

    <font color='#0000FF'>struct</font> <b><a name='iterator'></a>iterator</b> <b>{</b>
    <font color='#0000FF'>private</font>:
        instance <font color='#5555FF'>*</font>inst;
        <font color='#0000FF'>const</font> type_vec <font color='#5555FF'>*</font>types;
        value_and_holder curr;
        <font color='#0000FF'>friend</font> <font color='#0000FF'>struct</font> values_and_holders;
        <b><a name='iterator'></a>iterator</b><font face='Lucida Console'>(</font>instance <font color='#5555FF'>*</font>inst, <font color='#0000FF'>const</font> type_vec <font color='#5555FF'>*</font>tinfo<font face='Lucida Console'>)</font>
            : inst<b>{</b>inst<b>}</b>, types<b>{</b>tinfo<b>}</b>,
            <b><a name='curr'></a>curr</b><font face='Lucida Console'>(</font>inst <font color='#009900'>/* instance */</font>,
                 types<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font><font color='#BB00BB'>empty</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> ? nullptr : <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>types<font face='Lucida Console'>)</font>[<font color='#979000'>0</font>] <font color='#009900'>/* type info */</font>,
                 <font color='#979000'>0</font>, <font color='#009900'>/* vpos: (non-simple types only): the first vptr comes first */</font>
                 <font color='#979000'>0</font> <font color='#009900'>/* index */</font><font face='Lucida Console'>)</font>
        <b>{</b><b>}</b>
        <font color='#009900'>// Past-the-end iterator:
</font>        <b><a name='iterator'></a>iterator</b><font face='Lucida Console'>(</font><font color='#0000FF'><u>size_t</u></font> end<font face='Lucida Console'>)</font> : curr<font face='Lucida Console'>(</font>end<font face='Lucida Console'>)</font> <b>{</b><b>}</b>
    <font color='#0000FF'>public</font>:
        <font color='#0000FF'><u>bool</u></font> <b><a name='operator'></a>operator</b><font color='#5555FF'>=</font><font color='#5555FF'>=</font><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> iterator <font color='#5555FF'>&amp;</font>other<font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> curr.index <font color='#5555FF'>=</font><font color='#5555FF'>=</font> other.curr.index; <b>}</b>
        <font color='#0000FF'><u>bool</u></font> <b><a name='operator'></a>operator</b><font color='#5555FF'>!</font><font color='#5555FF'>=</font><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> iterator <font color='#5555FF'>&amp;</font>other<font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> curr.index <font color='#5555FF'>!</font><font color='#5555FF'>=</font> other.curr.index; <b>}</b>
        iterator <font color='#5555FF'>&amp;</font><b><a name='operator'></a>operator</b><font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>inst<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>simple_layout<font face='Lucida Console'>)</font>
                curr.vh <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>1</font> <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>types<font face='Lucida Console'>)</font>[curr.index]<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>holder_size_in_ptrs;
            <font color='#5555FF'>+</font><font color='#5555FF'>+</font>curr.index;
            curr.type <font color='#5555FF'>=</font> curr.index <font color='#5555FF'>&lt;</font> types<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font><font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> ? <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>types<font face='Lucida Console'>)</font>[curr.index] : nullptr;
            <font color='#0000FF'>return</font> <font color='#5555FF'>*</font><font color='#0000FF'>this</font>;
        <b>}</b>
        value_and_holder <font color='#5555FF'>&amp;</font><b><a name='operator'></a>operator</b><font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> curr; <b>}</b>
        value_and_holder <font color='#5555FF'>*</font><b><a name='operator'></a>operator</b><font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> <font color='#5555FF'>&amp;</font>curr; <b>}</b>
    <b>}</b>;

    iterator <b><a name='begin'></a>begin</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> <font color='#BB00BB'>iterator</font><font face='Lucida Console'>(</font>inst, <font color='#5555FF'>&amp;</font>tinfo<font face='Lucida Console'>)</font>; <b>}</b>
    iterator <b><a name='end'></a>end</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> <font color='#BB00BB'>iterator</font><font face='Lucida Console'>(</font>tinfo.<font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>; <b>}</b>

    iterator <b><a name='find'></a>find</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> type_info <font color='#5555FF'>*</font>find_type<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>auto</font> it <font color='#5555FF'>=</font> <font color='#BB00BB'>begin</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, endit <font color='#5555FF'>=</font> <font color='#BB00BB'>end</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>it <font color='#5555FF'>!</font><font color='#5555FF'>=</font> endit <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> it<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>type <font color='#5555FF'>!</font><font color='#5555FF'>=</font> find_type<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font><font color='#5555FF'>+</font>it;
        <font color='#0000FF'>return</font> it;
    <b>}</b>

    <font color='#0000FF'><u>size_t</u></font> <b><a name='size'></a>size</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> tinfo.<font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>; <b>}</b>
<b>}</b>;

<font color='#009900'>/**
 * Extracts C++ value and holder pointer references from an instance (which may contain multiple
 * values/holders for python-side multiple inheritance) that match the given type.  Throws an error
 * if the given type (or ValueType, if omitted) is not a pybind11 base of the given instance.  If
 * `find_type` is omitted (or explicitly specified as nullptr) the first value/holder are returned,
 * regardless of type (and the resulting .type will be nullptr).
 *
 * The returned object should be short-lived: in particular, it must not outlive the called-upon
 * instance.
 */</font>
PYBIND11_NOINLINE <font color='#0000FF'>inline</font> value_and_holder instance::<b><a name='get_value_and_holder'></a>get_value_and_holder</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> type_info <font color='#5555FF'>*</font>find_type <font color='#009900'>/*= nullptr default in common.h*/</font>, <font color='#0000FF'><u>bool</u></font> throw_if_missing <font color='#009900'>/*= true in common.h*/</font><font face='Lucida Console'>)</font> <b>{</b>
    <font color='#009900'>// Optimize common case:
</font>    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>find_type <font color='#5555FF'>|</font><font color='#5555FF'>|</font> <font color='#BB00BB'>Py_TYPE</font><font face='Lucida Console'>(</font><font color='#0000FF'>this</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> find_type<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>type<font face='Lucida Console'>)</font>
        <font color='#0000FF'>return</font> <font color='#BB00BB'>value_and_holder</font><font face='Lucida Console'>(</font><font color='#0000FF'>this</font>, find_type, <font color='#979000'>0</font>, <font color='#979000'>0</font><font face='Lucida Console'>)</font>;

    detail::values_and_holders <font color='#BB00BB'>vhs</font><font face='Lucida Console'>(</font><font color='#0000FF'>this</font><font face='Lucida Console'>)</font>;
    <font color='#0000FF'>auto</font> it <font color='#5555FF'>=</font> vhs.<font color='#BB00BB'>find</font><font face='Lucida Console'>(</font>find_type<font face='Lucida Console'>)</font>;
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>it <font color='#5555FF'>!</font><font color='#5555FF'>=</font> vhs.<font color='#BB00BB'>end</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
        <font color='#0000FF'>return</font> <font color='#5555FF'>*</font>it;

    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>throw_if_missing<font face='Lucida Console'>)</font>
        <font color='#0000FF'>return</font> <font color='#BB00BB'>value_and_holder</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;

<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>NDEBUG<font face='Lucida Console'>)</font>
    <font color='#BB00BB'>pybind11_fail</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>pybind11::detail::instance::get_value_and_holder: </font>"
            "<font color='#CC0000'>type is not a pybind11 base of the given instance </font>"
            "<font color='#CC0000'>(compile in debug mode for type details)</font>"<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#else</font>
    <font color='#BB00BB'>pybind11_fail</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>pybind11::detail::instance::get_value_and_holder: `</font>" <font color='#5555FF'>+</font>
            std::<font color='#BB00BB'>string</font><font face='Lucida Console'>(</font>find_type<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>type<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>tp_name<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> "<font color='#CC0000'>' is not a pybind11 base of the given `</font>" <font color='#5555FF'>+</font>
            std::<font color='#BB00BB'>string</font><font face='Lucida Console'>(</font><font color='#BB00BB'>Py_TYPE</font><font face='Lucida Console'>(</font><font color='#0000FF'>this</font><font face='Lucida Console'>)</font><font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>tp_name<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> "<font color='#CC0000'>' instance</font>"<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>
<b>}</b>

PYBIND11_NOINLINE <font color='#0000FF'>inline</font> <font color='#0000FF'><u>void</u></font> instance::<b><a name='allocate_layout'></a>allocate_layout</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b>
    <font color='#0000FF'>auto</font> <font color='#5555FF'>&amp;</font>tinfo <font color='#5555FF'>=</font> <font color='#BB00BB'>all_type_info</font><font face='Lucida Console'>(</font><font color='#BB00BB'>Py_TYPE</font><font face='Lucida Console'>(</font><font color='#0000FF'>this</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

    <font color='#0000FF'>const</font> <font color='#0000FF'><u>size_t</u></font> n_types <font color='#5555FF'>=</font> tinfo.<font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;

    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>n_types <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
        <font color='#BB00BB'>pybind11_fail</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>instance allocation failed: new instance has no pybind11-registered base types</font>"<font face='Lucida Console'>)</font>;

    simple_layout <font color='#5555FF'>=</font>
        n_types <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>1</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> tinfo.<font color='#BB00BB'>front</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>holder_size_in_ptrs <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#BB00BB'>instance_simple_holder_in_ptrs</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;

    <font color='#009900'>// Simple path: no python-side multiple inheritance, and a small-enough holder
</font>    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>simple_layout<font face='Lucida Console'>)</font> <b>{</b>
        simple_value_holder[<font color='#979000'>0</font>] <font color='#5555FF'>=</font> nullptr;
        simple_holder_constructed <font color='#5555FF'>=</font> <font color='#979000'>false</font>;
        simple_instance_registered <font color='#5555FF'>=</font> <font color='#979000'>false</font>;
    <b>}</b>
    <font color='#0000FF'>else</font> <b>{</b> <font color='#009900'>// multiple base types or a too-large holder
</font>        <font color='#009900'>// Allocate space to hold: [v1*][h1][v2*][h2]...[bb...] where [vN*] is a value pointer,
</font>        <font color='#009900'>// [hN] is the (uninitialized) holder instance for value N, and [bb...] is a set of bool
</font>        <font color='#009900'>// values that tracks whether each associated holder has been initialized.  Each [block] is
</font>        <font color='#009900'>// padded, if necessary, to an integer multiple of sizeof(void *).
</font>        <font color='#0000FF'><u>size_t</u></font> space <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
        <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font><font color='#0000FF'>auto</font> t : tinfo<font face='Lucida Console'>)</font> <b>{</b>
            space <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>1</font>; <font color='#009900'>// value pointer
</font>            space <font color='#5555FF'>+</font><font color='#5555FF'>=</font> t<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>holder_size_in_ptrs; <font color='#009900'>// holder instance
</font>        <b>}</b>
        <font color='#0000FF'><u>size_t</u></font> flags_at <font color='#5555FF'>=</font> space;
        space <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#BB00BB'>size_in_ptrs</font><font face='Lucida Console'>(</font>n_types<font face='Lucida Console'>)</font>; <font color='#009900'>// status bytes (holder_constructed and instance_registered)
</font>
        <font color='#009900'>// Allocate space for flags, values, and holders, and initialize it to 0 (flags and values,
</font>        <font color='#009900'>// in particular, need to be 0).  Use Python's memory allocation functions: in Python 3.6
</font>        <font color='#009900'>// they default to using pymalloc, which is designed to be efficient for small allocations
</font>        <font color='#009900'>// like the one we're doing here; in earlier versions (and for larger allocations) they are
</font>        <font color='#009900'>// just wrappers around malloc.
</font><font color='#0000FF'>#if</font> PY_VERSION_HEX <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>0x03050000</font>
        nonsimple.values_and_holders <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font><font color='#5555FF'>*</font><font face='Lucida Console'>)</font> <font color='#BB00BB'>PyMem_Calloc</font><font face='Lucida Console'>(</font>space, <font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>nonsimple.values_and_holders<font face='Lucida Console'>)</font> <font color='#0000FF'>throw</font> std::<font color='#BB00BB'>bad_alloc</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
<font color='#0000FF'>#else</font>
        nonsimple.values_and_holders <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font><font color='#5555FF'>*</font><font face='Lucida Console'>)</font> <font color='#BB00BB'>PyMem_New</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font>, space<font face='Lucida Console'>)</font>;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>nonsimple.values_and_holders<font face='Lucida Console'>)</font> <font color='#0000FF'>throw</font> std::<font color='#BB00BB'>bad_alloc</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        std::<font color='#BB00BB'>memset</font><font face='Lucida Console'>(</font>nonsimple.values_and_holders, <font color='#979000'>0</font>, space <font color='#5555FF'>*</font> <font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>
        nonsimple.status <font color='#5555FF'>=</font> <font color='#0000FF'>reinterpret_cast</font><font color='#5555FF'>&lt;</font>uint8_t <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>nonsimple.values_and_holders[flags_at]<font face='Lucida Console'>)</font>;
    <b>}</b>
    owned <font color='#5555FF'>=</font> <font color='#979000'>true</font>;
<b>}</b>

PYBIND11_NOINLINE <font color='#0000FF'>inline</font> <font color='#0000FF'><u>void</u></font> instance::<b><a name='deallocate_layout'></a>deallocate_layout</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b>
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>simple_layout<font face='Lucida Console'>)</font>
        <font color='#BB00BB'>PyMem_Free</font><font face='Lucida Console'>(</font>nonsimple.values_and_holders<font face='Lucida Console'>)</font>;
<b>}</b>

PYBIND11_NOINLINE <font color='#0000FF'>inline</font> <font color='#0000FF'><u>bool</u></font> <b><a name='isinstance_generic'></a>isinstance_generic</b><font face='Lucida Console'>(</font>handle obj, <font color='#0000FF'>const</font> std::type_info <font color='#5555FF'>&amp;</font>tp<font face='Lucida Console'>)</font> <b>{</b>
    handle type <font color='#5555FF'>=</font> detail::<font color='#BB00BB'>get_type_handle</font><font face='Lucida Console'>(</font>tp, <font color='#979000'>false</font><font face='Lucida Console'>)</font>;
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>type<font face='Lucida Console'>)</font>
        <font color='#0000FF'>return</font> <font color='#979000'>false</font>;
    <font color='#0000FF'>return</font> <font color='#BB00BB'>isinstance</font><font face='Lucida Console'>(</font>obj, type<font face='Lucida Console'>)</font>;
<b>}</b>

PYBIND11_NOINLINE <font color='#0000FF'>inline</font> std::string <b><a name='error_string'></a>error_string</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b>
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>PyErr_Occurred</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#BB00BB'>PyErr_SetString</font><font face='Lucida Console'>(</font>PyExc_RuntimeError, "<font color='#CC0000'>Unknown internal error occurred</font>"<font face='Lucida Console'>)</font>;
        <font color='#0000FF'>return</font> "<font color='#CC0000'>Unknown internal error occurred</font>";
    <b>}</b>

    error_scope scope; <font color='#009900'>// Preserve error state
</font>
    std::string errorString;
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>scope.type<font face='Lucida Console'>)</font> <b>{</b>
        errorString <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#BB00BB'>handle</font><font face='Lucida Console'>(</font>scope.type<font face='Lucida Console'>)</font>.<font color='#BB00BB'>attr</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>__name__</font>"<font face='Lucida Console'>)</font>.cast<font color='#5555FF'>&lt;</font>std::string<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        errorString <font color='#5555FF'>+</font><font color='#5555FF'>=</font> "<font color='#CC0000'>: </font>";
    <b>}</b>
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>scope.value<font face='Lucida Console'>)</font>
        errorString <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>std::string<font face='Lucida Console'>)</font> <font color='#BB00BB'>str</font><font face='Lucida Console'>(</font>scope.value<font face='Lucida Console'>)</font>;

    <font color='#BB00BB'>PyErr_NormalizeException</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>scope.type, <font color='#5555FF'>&amp;</font>scope.value, <font color='#5555FF'>&amp;</font>scope.trace<font face='Lucida Console'>)</font>;

<font color='#0000FF'>#if</font> PY_MAJOR_VERSION <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>3</font>
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>scope.trace <font color='#5555FF'>!</font><font color='#5555FF'>=</font> nullptr<font face='Lucida Console'>)</font>
        <font color='#BB00BB'>PyException_SetTraceback</font><font face='Lucida Console'>(</font>scope.value, scope.trace<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#if</font> <font color='#5555FF'>!</font>defined<font face='Lucida Console'>(</font>PYPY_VERSION<font face='Lucida Console'>)</font>
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>scope.trace<font face='Lucida Console'>)</font> <b>{</b>
        PyTracebackObject <font color='#5555FF'>*</font>trace <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>PyTracebackObject <font color='#5555FF'>*</font><font face='Lucida Console'>)</font> scope.trace;

        <font color='#009900'>/* Get the deepest trace possible */</font>
        <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>trace<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>tb_next<font face='Lucida Console'>)</font>
            trace <font color='#5555FF'>=</font> trace<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>tb_next;

        PyFrameObject <font color='#5555FF'>*</font>frame <font color='#5555FF'>=</font> trace<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>tb_frame;
        errorString <font color='#5555FF'>+</font><font color='#5555FF'>=</font> "<font color='#CC0000'>\n\nAt:\n</font>";
        <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>frame<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'><u>int</u></font> lineno <font color='#5555FF'>=</font> <font color='#BB00BB'>PyFrame_GetLineNumber</font><font face='Lucida Console'>(</font>frame<font face='Lucida Console'>)</font>;
            errorString <font color='#5555FF'>+</font><font color='#5555FF'>=</font>
                "<font color='#CC0000'>  </font>" <font color='#5555FF'>+</font> <font color='#BB00BB'>handle</font><font face='Lucida Console'>(</font>frame<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>f_code<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>co_filename<font face='Lucida Console'>)</font>.cast<font color='#5555FF'>&lt;</font>std::string<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>+</font>
                "<font color='#CC0000'>(</font>" <font color='#5555FF'>+</font> std::<font color='#BB00BB'>to_string</font><font face='Lucida Console'>(</font>lineno<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> "<font color='#CC0000'>): </font>" <font color='#5555FF'>+</font>
                <font color='#BB00BB'>handle</font><font face='Lucida Console'>(</font>frame<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>f_code<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>co_name<font face='Lucida Console'>)</font>.cast<font color='#5555FF'>&lt;</font>std::string<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> "<font color='#CC0000'>\n</font>";
            frame <font color='#5555FF'>=</font> frame<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>f_back;
        <b>}</b>
    <b>}</b>
<font color='#0000FF'>#endif</font>

    <font color='#0000FF'>return</font> errorString;
<b>}</b>

PYBIND11_NOINLINE <font color='#0000FF'>inline</font> handle <b><a name='get_object_handle'></a>get_object_handle</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> <font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font>ptr, <font color='#0000FF'>const</font> detail::type_info <font color='#5555FF'>*</font>type <font face='Lucida Console'>)</font> <b>{</b>
    <font color='#0000FF'>auto</font> <font color='#5555FF'>&amp;</font>instances <font color='#5555FF'>=</font> <font color='#BB00BB'>get_internals</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>.registered_instances;
    <font color='#0000FF'>auto</font> range <font color='#5555FF'>=</font> instances.<font color='#BB00BB'>equal_range</font><font face='Lucida Console'>(</font>ptr<font face='Lucida Console'>)</font>;
    <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font><font color='#0000FF'>auto</font> it <font color='#5555FF'>=</font> range.first; it <font color='#5555FF'>!</font><font color='#5555FF'>=</font> range.second; <font color='#5555FF'>+</font><font color='#5555FF'>+</font>it<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font><font color='#0000FF'>auto</font> vh : <font color='#BB00BB'>values_and_holders</font><font face='Lucida Console'>(</font>it<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>second<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>vh.type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> type<font face='Lucida Console'>)</font>
                <font color='#0000FF'>return</font> <font color='#BB00BB'>handle</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>PyObject <font color='#5555FF'>*</font><font face='Lucida Console'>)</font> it<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>second<font face='Lucida Console'>)</font>;
        <b>}</b>
    <b>}</b>
    <font color='#0000FF'>return</font> <font color='#BB00BB'>handle</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#0000FF'>inline</font> PyThreadState <font color='#5555FF'>*</font><b><a name='get_thread_state_unchecked'></a>get_thread_state_unchecked</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b>
<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>PYPY_VERSION<font face='Lucida Console'>)</font>
    <font color='#0000FF'>return</font> <font color='#BB00BB'>PyThreadState_GET</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
<font color='#0000FF'>#elif</font> PY_VERSION_HEX <font color='#5555FF'>&lt;</font> <font color='#979000'>0x03000000</font>
    <font color='#0000FF'>return</font> _PyThreadState_Current;
<font color='#0000FF'>#elif</font> PY_VERSION_HEX <font color='#5555FF'>&lt;</font> <font color='#979000'>0x03050000</font>
    <font color='#0000FF'>return</font> <font face='Lucida Console'>(</font>PyThreadState<font color='#5555FF'>*</font><font face='Lucida Console'>)</font> <font color='#BB00BB'>_Py_atomic_load_relaxed</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>_PyThreadState_Current<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#elif</font> PY_VERSION_HEX <font color='#5555FF'>&lt;</font> <font color='#979000'>0x03050200</font>
    <font color='#0000FF'>return</font> <font face='Lucida Console'>(</font>PyThreadState<font color='#5555FF'>*</font><font face='Lucida Console'>)</font> _PyThreadState_Current.value;
<font color='#0000FF'>#else</font>
    <font color='#0000FF'>return</font> <font color='#BB00BB'>_PyThreadState_UncheckedGet</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>
<b>}</b>

<font color='#009900'>// Forward declarations
</font><font color='#0000FF'>inline</font> <font color='#0000FF'><u>void</u></font> <b><a name='keep_alive_impl'></a>keep_alive_impl</b><font face='Lucida Console'>(</font>handle nurse, handle patient<font face='Lucida Console'>)</font>;
<font color='#0000FF'>inline</font> PyObject <font color='#5555FF'>*</font><b><a name='make_new_instance'></a>make_new_instance</b><font face='Lucida Console'>(</font>PyTypeObject <font color='#5555FF'>*</font>type<font face='Lucida Console'>)</font>;

<font color='#0000FF'>class</font> <b><a name='type_caster_generic'></a>type_caster_generic</b> <b>{</b>
<font color='#0000FF'>public</font>:
    PYBIND11_NOINLINE <b><a name='type_caster_generic'></a>type_caster_generic</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> std::type_info <font color='#5555FF'>&amp;</font>type_info<font face='Lucida Console'>)</font>
        : typeinfo<font face='Lucida Console'>(</font>get_type_info<font face='Lucida Console'>(</font>type_info<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>, cpptype<font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>type_info<font face='Lucida Console'>)</font> <b>{</b> <b>}</b>

    <b><a name='type_caster_generic'></a>type_caster_generic</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> type_info <font color='#5555FF'>*</font>typeinfo<font face='Lucida Console'>)</font>
        : typeinfo<font face='Lucida Console'>(</font>typeinfo<font face='Lucida Console'>)</font>, cpptype<font face='Lucida Console'>(</font>typeinfo ? typeinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>cpptype : nullptr<font face='Lucida Console'>)</font> <b>{</b> <b>}</b>

    <font color='#0000FF'><u>bool</u></font> <b><a name='load'></a>load</b><font face='Lucida Console'>(</font>handle src, <font color='#0000FF'><u>bool</u></font> convert<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>return</font> load_impl<font color='#5555FF'>&lt;</font>type_caster_generic<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>src, convert<font face='Lucida Console'>)</font>;
    <b>}</b>

    PYBIND11_NOINLINE <font color='#0000FF'>static</font> handle <b><a name='cast'></a>cast</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> <font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font>_src, return_value_policy policy, handle parent,
                                         <font color='#0000FF'>const</font> detail::type_info <font color='#5555FF'>*</font>tinfo,
                                         <font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>copy_constructor<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> <font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font><font face='Lucida Console'>)</font>,
                                         <font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>move_constructor<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> <font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font><font face='Lucida Console'>)</font>,
                                         <font color='#0000FF'>const</font> <font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font>existing_holder <font color='#5555FF'>=</font> nullptr<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>tinfo<font face='Lucida Console'>)</font> <font color='#009900'>// no type info: error will be set already
</font>            <font color='#0000FF'>return</font> <font color='#BB00BB'>handle</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;

        <font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font>src <font color='#5555FF'>=</font> <font color='#0000FF'>const_cast</font><font color='#5555FF'>&lt;</font><font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>_src<font face='Lucida Console'>)</font>;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>src <font color='#5555FF'>=</font><font color='#5555FF'>=</font> nullptr<font face='Lucida Console'>)</font>
            <font color='#0000FF'>return</font> <font color='#BB00BB'>none</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>.<font color='#BB00BB'>release</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;

        <font color='#0000FF'>auto</font> it_instances <font color='#5555FF'>=</font> <font color='#BB00BB'>get_internals</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>.registered_instances.<font color='#BB00BB'>equal_range</font><font face='Lucida Console'>(</font>src<font face='Lucida Console'>)</font>;
        <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font><font color='#0000FF'>auto</font> it_i <font color='#5555FF'>=</font> it_instances.first; it_i <font color='#5555FF'>!</font><font color='#5555FF'>=</font> it_instances.second; <font color='#5555FF'>+</font><font color='#5555FF'>+</font>it_i<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font><font color='#0000FF'>auto</font> instance_type : detail::<font color='#BB00BB'>all_type_info</font><font face='Lucida Console'>(</font><font color='#BB00BB'>Py_TYPE</font><font face='Lucida Console'>(</font>it_i<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>second<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
                <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>instance_type <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#BB00BB'>same_type</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>instance_type<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>cpptype, <font color='#5555FF'>*</font>tinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>cpptype<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
                    <font color='#0000FF'>return</font> <font color='#BB00BB'>handle</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>PyObject <font color='#5555FF'>*</font><font face='Lucida Console'>)</font> it_i<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>second<font face='Lucida Console'>)</font>.<font color='#BB00BB'>inc_ref</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
            <b>}</b>
        <b>}</b>

        <font color='#0000FF'>auto</font> inst <font color='#5555FF'>=</font> reinterpret_steal<font color='#5555FF'>&lt;</font>object<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font color='#BB00BB'>make_new_instance</font><font face='Lucida Console'>(</font>tinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>type<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>auto</font> wrapper <font color='#5555FF'>=</font> <font color='#0000FF'>reinterpret_cast</font><font color='#5555FF'>&lt;</font>instance <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>inst.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        wrapper<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>owned <font color='#5555FF'>=</font> <font color='#979000'>false</font>;
        <font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font><font color='#5555FF'>&amp;</font>valueptr <font color='#5555FF'>=</font> <font color='#BB00BB'>values_and_holders</font><font face='Lucida Console'>(</font>wrapper<font face='Lucida Console'>)</font>.<font color='#BB00BB'>begin</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font><font color='#BB00BB'>value_ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;

        <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font>policy<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>case</font> return_value_policy::automatic:
            <font color='#0000FF'>case</font> return_value_policy::take_ownership:
                valueptr <font color='#5555FF'>=</font> src;
                wrapper<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>owned <font color='#5555FF'>=</font> <font color='#979000'>true</font>;
                <font color='#0000FF'>break</font>;

            <font color='#0000FF'>case</font> return_value_policy::automatic_reference:
            <font color='#0000FF'>case</font> return_value_policy::reference:
                valueptr <font color='#5555FF'>=</font> src;
                wrapper<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>owned <font color='#5555FF'>=</font> <font color='#979000'>false</font>;
                <font color='#0000FF'>break</font>;

            <font color='#0000FF'>case</font> return_value_policy::copy:
                <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>copy_constructor<font face='Lucida Console'>)</font>
                    valueptr <font color='#5555FF'>=</font> <font color='#BB00BB'>copy_constructor</font><font face='Lucida Console'>(</font>src<font face='Lucida Console'>)</font>;
                <font color='#0000FF'>else</font>
                    <font color='#0000FF'>throw</font> <font color='#BB00BB'>cast_error</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>return_value_policy = copy, but the </font>"
                                     "<font color='#CC0000'>object is non-copyable!</font>"<font face='Lucida Console'>)</font>;
                wrapper<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>owned <font color='#5555FF'>=</font> <font color='#979000'>true</font>;
                <font color='#0000FF'>break</font>;

            <font color='#0000FF'>case</font> return_value_policy::move:
                <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>move_constructor<font face='Lucida Console'>)</font>
                    valueptr <font color='#5555FF'>=</font> <font color='#BB00BB'>move_constructor</font><font face='Lucida Console'>(</font>src<font face='Lucida Console'>)</font>;
                <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>copy_constructor<font face='Lucida Console'>)</font>
                    valueptr <font color='#5555FF'>=</font> <font color='#BB00BB'>copy_constructor</font><font face='Lucida Console'>(</font>src<font face='Lucida Console'>)</font>;
                <font color='#0000FF'>else</font>
                    <font color='#0000FF'>throw</font> <font color='#BB00BB'>cast_error</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>return_value_policy = move, but the </font>"
                                     "<font color='#CC0000'>object is neither movable nor copyable!</font>"<font face='Lucida Console'>)</font>;
                wrapper<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>owned <font color='#5555FF'>=</font> <font color='#979000'>true</font>;
                <font color='#0000FF'>break</font>;

            <font color='#0000FF'>case</font> return_value_policy::reference_internal:
                valueptr <font color='#5555FF'>=</font> src;
                wrapper<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>owned <font color='#5555FF'>=</font> <font color='#979000'>false</font>;
                <font color='#BB00BB'>keep_alive_impl</font><font face='Lucida Console'>(</font>inst, parent<font face='Lucida Console'>)</font>;
                <font color='#0000FF'>break</font>;

            <font color='#0000FF'>default</font>:
                <font color='#0000FF'>throw</font> <font color='#BB00BB'>cast_error</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>unhandled return_value_policy: should not happen!</font>"<font face='Lucida Console'>)</font>;
        <b>}</b>

        tinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font><font color='#BB00BB'>init_instance</font><font face='Lucida Console'>(</font>wrapper, existing_holder<font face='Lucida Console'>)</font>;

        <font color='#0000FF'>return</font> inst.<font color='#BB00BB'>release</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#009900'>// Base methods for generic caster; there are overridden in copyable_holder_caster
</font>    <font color='#0000FF'><u>void</u></font> <b><a name='load_value'></a>load_value</b><font face='Lucida Console'>(</font>value_and_holder <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>v_h<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>auto</font> <font color='#5555FF'>*</font><font color='#5555FF'>&amp;</font>vptr <font color='#5555FF'>=</font> v_h.<font color='#BB00BB'>value_ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <font color='#009900'>// Lazy allocation for unallocated values:
</font>        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>vptr <font color='#5555FF'>=</font><font color='#5555FF'>=</font> nullptr<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>auto</font> <font color='#5555FF'>*</font>type <font color='#5555FF'>=</font> v_h.type ? v_h.type : typeinfo;
            vptr <font color='#5555FF'>=</font> type<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font><font color='#BB00BB'>operator_new</font><font face='Lucida Console'>(</font>type<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>type_size<font face='Lucida Console'>)</font>;
        <b>}</b>
        value <font color='#5555FF'>=</font> vptr;
    <b>}</b>
    <font color='#0000FF'><u>bool</u></font> <b><a name='try_implicit_casts'></a>try_implicit_casts</b><font face='Lucida Console'>(</font>handle src, <font color='#0000FF'><u>bool</u></font> convert<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font><font color='#0000FF'>auto</font> <font color='#5555FF'>&amp;</font>cast : typeinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>implicit_casts<font face='Lucida Console'>)</font> <b>{</b>
            type_caster_generic <font color='#BB00BB'>sub_caster</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>cast.first<font face='Lucida Console'>)</font>;
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>sub_caster.<font color='#BB00BB'>load</font><font face='Lucida Console'>(</font>src, convert<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
                value <font color='#5555FF'>=</font> cast.<font color='#BB00BB'>second</font><font face='Lucida Console'>(</font>sub_caster.value<font face='Lucida Console'>)</font>;
                <font color='#0000FF'>return</font> <font color='#979000'>true</font>;
            <b>}</b>
        <b>}</b>
        <font color='#0000FF'>return</font> <font color='#979000'>false</font>;
    <b>}</b>
    <font color='#0000FF'><u>bool</u></font> <b><a name='try_direct_conversions'></a>try_direct_conversions</b><font face='Lucida Console'>(</font>handle src<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font><font color='#0000FF'>auto</font> <font color='#5555FF'>&amp;</font>converter : <font color='#5555FF'>*</font>typeinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>direct_conversions<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>converter</font><font face='Lucida Console'>(</font>src.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, value<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
                <font color='#0000FF'>return</font> <font color='#979000'>true</font>;
        <b>}</b>
        <font color='#0000FF'>return</font> <font color='#979000'>false</font>;
    <b>}</b>
    <font color='#0000FF'><u>void</u></font> <b><a name='check_holder_compat'></a>check_holder_compat</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b><b>}</b>

    PYBIND11_NOINLINE <font color='#0000FF'>static</font> <font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font><b><a name='local_load'></a>local_load</b><font face='Lucida Console'>(</font>PyObject <font color='#5555FF'>*</font>src, <font color='#0000FF'>const</font> type_info <font color='#5555FF'>*</font>ti<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>auto</font> caster <font color='#5555FF'>=</font> <font color='#BB00BB'>type_caster_generic</font><font face='Lucida Console'>(</font>ti<font face='Lucida Console'>)</font>;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>caster.<font color='#BB00BB'>load</font><font face='Lucida Console'>(</font>src, <font color='#979000'>false</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
            <font color='#0000FF'>return</font> caster.value;
        <font color='#0000FF'>return</font> nullptr;
    <b>}</b>

    <font color='#009900'>/// Try to load with foreign typeinfo, if available. Used when there is no
</font>    <font color='#009900'>/// native typeinfo, or when the native one wasn't able to produce a value.
</font>    PYBIND11_NOINLINE <font color='#0000FF'><u>bool</u></font> <b><a name='try_load_foreign_module_local'></a>try_load_foreign_module_local</b><font face='Lucida Console'>(</font>handle src<font face='Lucida Console'>)</font> <b>{</b>
        constexpr <font color='#0000FF'>auto</font> <font color='#5555FF'>*</font>local_key <font color='#5555FF'>=</font> PYBIND11_MODULE_LOCAL_ID;
        <font color='#0000FF'>const</font> <font color='#0000FF'>auto</font> pytype <font color='#5555FF'>=</font> src.<font color='#BB00BB'>get_type</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>hasattr</font><font face='Lucida Console'>(</font>pytype, local_key<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
            <font color='#0000FF'>return</font> <font color='#979000'>false</font>;

        type_info <font color='#5555FF'>*</font>foreign_typeinfo <font color='#5555FF'>=</font> reinterpret_borrow<font color='#5555FF'>&lt;</font>capsule<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font color='#BB00BB'>getattr</font><font face='Lucida Console'>(</font>pytype, local_key<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        <font color='#009900'>// Only consider this foreign loader if actually foreign and is a loader of the correct cpp type
</font>        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>foreign_typeinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>module_local_load <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#5555FF'>&amp;</font>local_load
            <font color='#5555FF'>|</font><font color='#5555FF'>|</font> <font face='Lucida Console'>(</font>cpptype <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#5555FF'>!</font><font color='#BB00BB'>same_type</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>cpptype, <font color='#5555FF'>*</font>foreign_typeinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>cpptype<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
            <font color='#0000FF'>return</font> <font color='#979000'>false</font>;

        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#0000FF'>auto</font> result <font color='#5555FF'>=</font> foreign_typeinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font><font color='#BB00BB'>module_local_load</font><font face='Lucida Console'>(</font>src.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, foreign_typeinfo<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
            value <font color='#5555FF'>=</font> result;
            <font color='#0000FF'>return</font> <font color='#979000'>true</font>;
        <b>}</b>
        <font color='#0000FF'>return</font> <font color='#979000'>false</font>;
    <b>}</b>

    <font color='#009900'>// Implementation of `load`; this takes the type of `this` so that it can dispatch the relevant
</font>    <font color='#009900'>// bits of code between here and copyable_holder_caster where the two classes need different
</font>    <font color='#009900'>// logic (without having to resort to virtual inheritance).
</font>    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> ThisT<font color='#5555FF'>&gt;</font>
    PYBIND11_NOINLINE <font color='#0000FF'><u>bool</u></font> <b><a name='load_impl'></a>load_impl</b><font face='Lucida Console'>(</font>handle src, <font color='#0000FF'><u>bool</u></font> convert<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>src<font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> <font color='#979000'>false</font>;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>typeinfo<font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> <font color='#BB00BB'>try_load_foreign_module_local</font><font face='Lucida Console'>(</font>src<font face='Lucida Console'>)</font>;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>src.<font color='#BB00BB'>is_none</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
            <font color='#009900'>// Defer accepting None to other overloads (if we aren't in convert mode):
</font>            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>convert<font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> <font color='#979000'>false</font>;
            value <font color='#5555FF'>=</font> nullptr;
            <font color='#0000FF'>return</font> <font color='#979000'>true</font>;
        <b>}</b>

        <font color='#0000FF'>auto</font> <font color='#5555FF'>&amp;</font>this_ <font color='#5555FF'>=</font> <font color='#0000FF'>static_cast</font><font color='#5555FF'>&lt;</font>ThisT <font color='#5555FF'>&amp;</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font color='#0000FF'>this</font><font face='Lucida Console'>)</font>;
        this_.<font color='#BB00BB'>check_holder_compat</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;

        PyTypeObject <font color='#5555FF'>*</font>srctype <font color='#5555FF'>=</font> <font color='#BB00BB'>Py_TYPE</font><font face='Lucida Console'>(</font>src.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

        <font color='#009900'>// Case 1: If src is an exact type match for the target type then we can reinterpret_cast
</font>        <font color='#009900'>// the instance's value pointer to the target type:
</font>        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>srctype <font color='#5555FF'>=</font><font color='#5555FF'>=</font> typeinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>type<font face='Lucida Console'>)</font> <b>{</b>
            this_.<font color='#BB00BB'>load_value</font><font face='Lucida Console'>(</font><font color='#0000FF'>reinterpret_cast</font><font color='#5555FF'>&lt;</font>instance <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>src.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font><font color='#BB00BB'>get_value_and_holder</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
            <font color='#0000FF'>return</font> <font color='#979000'>true</font>;
        <b>}</b>
        <font color='#009900'>// Case 2: We have a derived class
</font>        <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>PyType_IsSubtype</font><font face='Lucida Console'>(</font>srctype, typeinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>type<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>auto</font> <font color='#5555FF'>&amp;</font>bases <font color='#5555FF'>=</font> <font color='#BB00BB'>all_type_info</font><font face='Lucida Console'>(</font>srctype<font face='Lucida Console'>)</font>;
            <font color='#0000FF'><u>bool</u></font> no_cpp_mi <font color='#5555FF'>=</font> typeinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>simple_type;

            <font color='#009900'>// Case 2a: the python type is a Python-inherited derived class that inherits from just
</font>            <font color='#009900'>// one simple (no MI) pybind11 class, or is an exact match, so the C++ instance is of
</font>            <font color='#009900'>// the right type and we can use reinterpret_cast.
</font>            <font color='#009900'>// (This is essentially the same as case 2b, but because not using multiple inheritance
</font>            <font color='#009900'>// is extremely common, we handle it specially to avoid the loop iterator and type
</font>            <font color='#009900'>// pointer lookup overhead)
</font>            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>bases.<font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>1</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font>no_cpp_mi <font color='#5555FF'>|</font><font color='#5555FF'>|</font> bases.<font color='#BB00BB'>front</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> typeinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>type<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
                this_.<font color='#BB00BB'>load_value</font><font face='Lucida Console'>(</font><font color='#0000FF'>reinterpret_cast</font><font color='#5555FF'>&lt;</font>instance <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>src.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font><font color='#BB00BB'>get_value_and_holder</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
                <font color='#0000FF'>return</font> <font color='#979000'>true</font>;
            <b>}</b>
            <font color='#009900'>// Case 2b: the python type inherits from multiple C++ bases.  Check the bases to see if
</font>            <font color='#009900'>// we can find an exact match (or, for a simple C++ type, an inherited match); if so, we
</font>            <font color='#009900'>// can safely reinterpret_cast to the relevant pointer.
</font>            <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>bases.<font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <b>{</b>
                <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font><font color='#0000FF'>auto</font> base : bases<font face='Lucida Console'>)</font> <b>{</b>
                    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>no_cpp_mi ? <font color='#BB00BB'>PyType_IsSubtype</font><font face='Lucida Console'>(</font>base<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>type, typeinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>type<font face='Lucida Console'>)</font> : base<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> typeinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>type<font face='Lucida Console'>)</font> <b>{</b>
                        this_.<font color='#BB00BB'>load_value</font><font face='Lucida Console'>(</font><font color='#0000FF'>reinterpret_cast</font><font color='#5555FF'>&lt;</font>instance <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>src.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font><font color='#BB00BB'>get_value_and_holder</font><font face='Lucida Console'>(</font>base<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
                        <font color='#0000FF'>return</font> <font color='#979000'>true</font>;
                    <b>}</b>
                <b>}</b>
            <b>}</b>

            <font color='#009900'>// Case 2c: C++ multiple inheritance is involved and we couldn't find an exact type match
</font>            <font color='#009900'>// in the registered bases, above, so try implicit casting (needed for proper C++ casting
</font>            <font color='#009900'>// when MI is involved).
</font>            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>this_.<font color='#BB00BB'>try_implicit_casts</font><font face='Lucida Console'>(</font>src, convert<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
                <font color='#0000FF'>return</font> <font color='#979000'>true</font>;
        <b>}</b>

        <font color='#009900'>// Perform an implicit conversion
</font>        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>convert<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font><font color='#0000FF'>auto</font> <font color='#5555FF'>&amp;</font>converter : typeinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>implicit_conversions<font face='Lucida Console'>)</font> <b>{</b>
                <font color='#0000FF'>auto</font> temp <font color='#5555FF'>=</font> reinterpret_steal<font color='#5555FF'>&lt;</font>object<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font color='#BB00BB'>converter</font><font face='Lucida Console'>(</font>src.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, typeinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>type<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
                <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>load_impl<font color='#5555FF'>&lt;</font>ThisT<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>temp, <font color='#979000'>false</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
                    loader_life_support::<font color='#BB00BB'>add_patient</font><font face='Lucida Console'>(</font>temp<font face='Lucida Console'>)</font>;
                    <font color='#0000FF'>return</font> <font color='#979000'>true</font>;
                <b>}</b>
            <b>}</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>this_.<font color='#BB00BB'>try_direct_conversions</font><font face='Lucida Console'>(</font>src<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
                <font color='#0000FF'>return</font> <font color='#979000'>true</font>;
        <b>}</b>

        <font color='#009900'>// Failed to match local typeinfo. Try again with global.
</font>        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>typeinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>module_local<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#0000FF'>auto</font> gtype <font color='#5555FF'>=</font> <font color='#BB00BB'>get_global_type_info</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>typeinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>cpptype<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
                typeinfo <font color='#5555FF'>=</font> gtype;
                <font color='#0000FF'>return</font> <font color='#BB00BB'>load</font><font face='Lucida Console'>(</font>src, <font color='#979000'>false</font><font face='Lucida Console'>)</font>;
            <b>}</b>
        <b>}</b>

        <font color='#009900'>// Global typeinfo has precedence over foreign module_local
</font>        <font color='#0000FF'>return</font> <font color='#BB00BB'>try_load_foreign_module_local</font><font face='Lucida Console'>(</font>src<font face='Lucida Console'>)</font>;
    <b>}</b>


    <font color='#009900'>// Called to do type lookup and wrap the pointer and type in a pair when a dynamic_cast
</font>    <font color='#009900'>// isn't needed or can't be used.  If the type is unknown, sets the error and returns a pair
</font>    <font color='#009900'>// with .second = nullptr.  (p.first = nullptr is not an error: it becomes None).
</font>    PYBIND11_NOINLINE <font color='#0000FF'>static</font> std::pair<font color='#5555FF'>&lt;</font><font color='#0000FF'>const</font> <font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font>, <font color='#0000FF'>const</font> type_info <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font> <b><a name='src_and_type'></a>src_and_type</b><font face='Lucida Console'>(</font>
            <font color='#0000FF'>const</font> <font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font>src, <font color='#0000FF'>const</font> std::type_info <font color='#5555FF'>&amp;</font>cast_type, <font color='#0000FF'>const</font> std::type_info <font color='#5555FF'>*</font>rtti_type <font color='#5555FF'>=</font> nullptr<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#0000FF'>auto</font> <font color='#5555FF'>*</font>tpi <font color='#5555FF'>=</font> <font color='#BB00BB'>get_type_info</font><font face='Lucida Console'>(</font>cast_type<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
            <font color='#0000FF'>return</font> <b>{</b>src, <font color='#0000FF'>const_cast</font><font color='#5555FF'>&lt;</font><font color='#0000FF'>const</font> type_info <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>tpi<font face='Lucida Console'>)</font><b>}</b>;

        <font color='#009900'>// Not found, set error:
</font>        std::string tname <font color='#5555FF'>=</font> rtti_type ? rtti_type<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font><font color='#BB00BB'>name</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> : cast_type.<font color='#BB00BB'>name</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        detail::<font color='#BB00BB'>clean_type_id</font><font face='Lucida Console'>(</font>tname<font face='Lucida Console'>)</font>;
        std::string msg <font color='#5555FF'>=</font> "<font color='#CC0000'>Unregistered type : </font>" <font color='#5555FF'>+</font> tname;
        <font color='#BB00BB'>PyErr_SetString</font><font face='Lucida Console'>(</font>PyExc_TypeError, msg.<font color='#BB00BB'>c_str</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>return</font> <b>{</b>nullptr, nullptr<b>}</b>;
    <b>}</b>

    <font color='#0000FF'>const</font> type_info <font color='#5555FF'>*</font>typeinfo <font color='#5555FF'>=</font> nullptr;
    <font color='#0000FF'>const</font> std::type_info <font color='#5555FF'>*</font>cpptype <font color='#5555FF'>=</font> nullptr;
    <font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font>value <font color='#5555FF'>=</font> nullptr;
<b>}</b>;

<font color='#009900'>/**
 * Determine suitable casting operator for pointer-or-lvalue-casting type casters.  The type caster
 * needs to provide `operator T*()` and `operator T&amp;()` operators.
 *
 * If the type supports moving the value away via an `operator T&amp;&amp;() &amp;&amp;` method, it should use
 * `movable_cast_op_type` instead.
 */</font>
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>using</font> cast_op_type <font color='#5555FF'>=</font>
    conditional_t<font color='#5555FF'>&lt;</font>std::is_pointer<font color='#5555FF'>&lt;</font>remove_reference_t<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>::value,
        <font color='#0000FF'>typename</font> std::add_pointer<font color='#5555FF'>&lt;</font>intrinsic_t<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>::type,
        <font color='#0000FF'>typename</font> std::add_lvalue_reference<font color='#5555FF'>&lt;</font>intrinsic_t<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>::type<font color='#5555FF'>&gt;</font>;

<font color='#009900'>/**
 * Determine suitable casting operator for a type caster with a movable value.  Such a type caster
 * needs to provide `operator T*()`, `operator T&amp;()`, and `operator T&amp;&amp;() &amp;&amp;`.  The latter will be
 * called in appropriate contexts where the value can be moved rather than copied.
 *
 * These operator are automatically provided when using the PYBIND11_TYPE_CASTER macro.
 */</font>
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>using</font> movable_cast_op_type <font color='#5555FF'>=</font>
    conditional_t<font color='#5555FF'>&lt;</font>std::is_pointer<font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> std::remove_reference<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::type<font color='#5555FF'>&gt;</font>::value,
        <font color='#0000FF'>typename</font> std::add_pointer<font color='#5555FF'>&lt;</font>intrinsic_t<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>::type,
    conditional_t<font color='#5555FF'>&lt;</font>std::is_rvalue_reference<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::value,
        <font color='#0000FF'>typename</font> std::add_rvalue_reference<font color='#5555FF'>&lt;</font>intrinsic_t<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>::type,
        <font color='#0000FF'>typename</font> std::add_lvalue_reference<font color='#5555FF'>&lt;</font>intrinsic_t<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>::type<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>;

<font color='#009900'>// std::is_copy_constructible isn't quite enough: it lets std::vector&lt;T&gt; (and similar) through when
</font><font color='#009900'>// T is non-copyable, but code containing such a copy constructor fails to actually compile.
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T, <font color='#0000FF'>typename</font> SFINAE <font color='#5555FF'>=</font> <font color='#0000FF'><u>void</u></font><font color='#5555FF'>&gt;</font> <font color='#0000FF'>struct</font> <b><a name='is_copy_constructible'></a>is_copy_constructible</b> : std::is_copy_constructible<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font> <b>{</b><b>}</b>;

<font color='#009900'>// Specialization for types that appear to be copy constructible but also look like stl containers
</font><font color='#009900'>// (we specifically check for: has `value_type` and `reference` with `reference = value_type&amp;`): if
</font><font color='#009900'>// so, copy constructability depends on whether the value_type is copy constructible.
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> Container<font color='#5555FF'>&gt;</font> <font color='#0000FF'>struct</font> <b><a name='is_copy_constructible'></a>is_copy_constructible</b><font color='#5555FF'>&lt;</font>Container, enable_if_t<font color='#5555FF'>&lt;</font>all_of<font color='#5555FF'>&lt;</font>
        std::is_copy_constructible<font color='#5555FF'>&lt;</font>Container<font color='#5555FF'>&gt;</font>,
        std::is_same<font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> Container::value_type <font color='#5555FF'>&amp;</font>, <font color='#0000FF'>typename</font> Container::reference<font color='#5555FF'>&gt;</font>
    <font color='#5555FF'>&gt;</font>::value<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> : is_copy_constructible<font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> Container::value_type<font color='#5555FF'>&gt;</font> <b>{</b><b>}</b>;

<font color='#0000FF'>#if</font> <font color='#5555FF'>!</font>defined<font face='Lucida Console'>(</font>PYBIND11_CPP17<font face='Lucida Console'>)</font>
<font color='#009900'>// Likewise for std::pair before C++17 (which mandates that the copy constructor not exist when the
</font><font color='#009900'>// two types aren't themselves copy constructible).
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T1, <font color='#0000FF'>typename</font> T2<font color='#5555FF'>&gt;</font> <font color='#0000FF'>struct</font> <b><a name='is_copy_constructible'></a>is_copy_constructible</b><font color='#5555FF'>&lt;</font>std::pair<font color='#5555FF'>&lt;</font>T1, T2<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
    : all_of<font color='#5555FF'>&lt;</font>is_copy_constructible<font color='#5555FF'>&lt;</font>T1<font color='#5555FF'>&gt;</font>, is_copy_constructible<font color='#5555FF'>&lt;</font>T2<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <b>{</b><b>}</b>;
<font color='#0000FF'>#endif</font>

<font color='#009900'>/// Generic type caster for objects stored on the heap
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> type<font color='#5555FF'>&gt;</font> <font color='#0000FF'>class</font> <b><a name='type_caster_base'></a>type_caster_base</b> : <font color='#0000FF'>public</font> type_caster_generic <b>{</b>
    <font color='#0000FF'>using</font> itype <font color='#5555FF'>=</font> intrinsic_t<font color='#5555FF'>&lt;</font>type<font color='#5555FF'>&gt;</font>;
<font color='#0000FF'>public</font>:
    <font color='#0000FF'>static</font> PYBIND11_DESCR <b><a name='name'></a>name</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> <font color='#BB00BB'>type_descr</font><font face='Lucida Console'>(</font>_<font color='#5555FF'>&lt;</font>type<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>; <b>}</b>

    <b><a name='type_caster_base'></a>type_caster_base</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> : type_caster_base<font face='Lucida Console'>(</font><font color='#0000FF'>typeid</font><font face='Lucida Console'>(</font>type<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b> <b>}</b>
    <font color='#0000FF'>explicit</font> <b><a name='type_caster_base'></a>type_caster_base</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> std::type_info <font color='#5555FF'>&amp;</font>info<font face='Lucida Console'>)</font> : type_caster_generic<font face='Lucida Console'>(</font>info<font face='Lucida Console'>)</font> <b>{</b> <b>}</b>

    <font color='#0000FF'>static</font> handle <b><a name='cast'></a>cast</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> itype <font color='#5555FF'>&amp;</font>src, return_value_policy policy, handle parent<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>policy <font color='#5555FF'>=</font><font color='#5555FF'>=</font> return_value_policy::automatic <font color='#5555FF'>|</font><font color='#5555FF'>|</font> policy <font color='#5555FF'>=</font><font color='#5555FF'>=</font> return_value_policy::automatic_reference<font face='Lucida Console'>)</font>
            policy <font color='#5555FF'>=</font> return_value_policy::copy;
        <font color='#0000FF'>return</font> <font color='#BB00BB'>cast</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>src, policy, parent<font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#0000FF'>static</font> handle <b><a name='cast'></a>cast</b><font face='Lucida Console'>(</font>itype <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>src, return_value_policy, handle parent<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>return</font> <font color='#BB00BB'>cast</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>src, return_value_policy::move, parent<font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#009900'>// Returns a (pointer, type_info) pair taking care of necessary RTTI type lookup for a
</font>    <font color='#009900'>// polymorphic type.  If the instance isn't derived, returns the non-RTTI base version.
</font>    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T <font color='#5555FF'>=</font> itype, enable_if_t<font color='#5555FF'>&lt;</font>std::is_polymorphic<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::value, <font color='#0000FF'><u>int</u></font><font color='#5555FF'>&gt;</font> <font color='#5555FF'>=</font> <font color='#979000'>0</font><font color='#5555FF'>&gt;</font>
    <font color='#0000FF'>static</font> std::pair<font color='#5555FF'>&lt;</font><font color='#0000FF'>const</font> <font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font>, <font color='#0000FF'>const</font> type_info <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font> <b><a name='src_and_type'></a>src_and_type</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> itype <font color='#5555FF'>*</font>src<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>const</font> <font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font>vsrc <font color='#5555FF'>=</font> src;
        <font color='#0000FF'>auto</font> <font color='#5555FF'>&amp;</font>cast_type <font color='#5555FF'>=</font> <font color='#0000FF'>typeid</font><font face='Lucida Console'>(</font>itype<font face='Lucida Console'>)</font>;
        <font color='#0000FF'>const</font> std::type_info <font color='#5555FF'>*</font>instance_type <font color='#5555FF'>=</font> nullptr;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>vsrc<font face='Lucida Console'>)</font> <b>{</b>
            instance_type <font color='#5555FF'>=</font> <font color='#5555FF'>&amp;</font><font color='#0000FF'>typeid</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>src<font face='Lucida Console'>)</font>;
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>same_type</font><font face='Lucida Console'>(</font>cast_type, <font color='#5555FF'>*</font>instance_type<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
                <font color='#009900'>// This is a base pointer to a derived type; if it is a pybind11-registered type, we
</font>                <font color='#009900'>// can get the correct derived pointer (which may be != base pointer) by a
</font>                <font color='#009900'>// dynamic_cast to most derived type:
</font>                <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#0000FF'>auto</font> <font color='#5555FF'>*</font>tpi <font color='#5555FF'>=</font> <font color='#BB00BB'>get_type_info</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>instance_type<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
                    <font color='#0000FF'>return</font> <b>{</b><font color='#0000FF'>dynamic_cast</font><font color='#5555FF'>&lt;</font><font color='#0000FF'>const</font> <font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>src<font face='Lucida Console'>)</font>, <font color='#0000FF'>const_cast</font><font color='#5555FF'>&lt;</font><font color='#0000FF'>const</font> type_info <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>tpi<font face='Lucida Console'>)</font><b>}</b>;
            <b>}</b>
        <b>}</b>
        <font color='#009900'>// Otherwise we have either a nullptr, an `itype` pointer, or an unknown derived pointer, so
</font>        <font color='#009900'>// don't do a cast
</font>        <font color='#0000FF'>return</font> type_caster_generic::<font color='#BB00BB'>src_and_type</font><font face='Lucida Console'>(</font>vsrc, cast_type, instance_type<font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#009900'>// Non-polymorphic type, so no dynamic casting; just call the generic version directly
</font>    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T <font color='#5555FF'>=</font> itype, enable_if_t<font color='#5555FF'>&lt;</font><font color='#5555FF'>!</font>std::is_polymorphic<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::value, <font color='#0000FF'><u>int</u></font><font color='#5555FF'>&gt;</font> <font color='#5555FF'>=</font> <font color='#979000'>0</font><font color='#5555FF'>&gt;</font>
    <font color='#0000FF'>static</font> std::pair<font color='#5555FF'>&lt;</font><font color='#0000FF'>const</font> <font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font>, <font color='#0000FF'>const</font> type_info <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font> <b><a name='src_and_type'></a>src_and_type</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> itype <font color='#5555FF'>*</font>src<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>return</font> type_caster_generic::<font color='#BB00BB'>src_and_type</font><font face='Lucida Console'>(</font>src, <font color='#0000FF'>typeid</font><font face='Lucida Console'>(</font>itype<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#0000FF'>static</font> handle <b><a name='cast'></a>cast</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> itype <font color='#5555FF'>*</font>src, return_value_policy policy, handle parent<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>auto</font> st <font color='#5555FF'>=</font> <font color='#BB00BB'>src_and_type</font><font face='Lucida Console'>(</font>src<font face='Lucida Console'>)</font>;
        <font color='#0000FF'>return</font> type_caster_generic::<font color='#BB00BB'>cast</font><font face='Lucida Console'>(</font>
            st.first, policy, parent, st.second,
            <font color='#BB00BB'>make_copy_constructor</font><font face='Lucida Console'>(</font>src<font face='Lucida Console'>)</font>, <font color='#BB00BB'>make_move_constructor</font><font face='Lucida Console'>(</font>src<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#0000FF'>static</font> handle <b><a name='cast_holder'></a>cast_holder</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> itype <font color='#5555FF'>*</font>src, <font color='#0000FF'>const</font> <font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font>holder<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>auto</font> st <font color='#5555FF'>=</font> <font color='#BB00BB'>src_and_type</font><font face='Lucida Console'>(</font>src<font face='Lucida Console'>)</font>;
        <font color='#0000FF'>return</font> type_caster_generic::<font color='#BB00BB'>cast</font><font face='Lucida Console'>(</font>
            st.first, return_value_policy::take_ownership, <b>{</b><b>}</b>, st.second,
            nullptr, nullptr, holder<font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font> <font color='#0000FF'>using</font> cast_op_type <font color='#5555FF'>=</font> cast_op_type<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>;

    <b><a name='operator'></a>operator</b> itype<font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> <font face='Lucida Console'>(</font>type <font color='#5555FF'>*</font><font face='Lucida Console'>)</font> value; <b>}</b>
    <b><a name='operator'></a>operator</b> itype<font color='#5555FF'>&amp;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>value<font face='Lucida Console'>)</font> <font color='#0000FF'>throw</font> <font color='#BB00BB'>reference_cast_error</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>; <font color='#0000FF'>return</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>itype <font color='#5555FF'>*</font><font face='Lucida Console'>)</font> value<font face='Lucida Console'>)</font>; <b>}</b>

<font color='#0000FF'>protected</font>:
    <font color='#0000FF'>using</font> Constructor <font color='#5555FF'>=</font> <font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> <font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font><font face='Lucida Console'>)</font>;

    <font color='#009900'>/* Only enabled when the types are {copy,move}-constructible *and* when the type
       does not have a private operator new implementation. */</font>
    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T, <font color='#0000FF'>typename</font> <font color='#5555FF'>=</font> enable_if_t<font color='#5555FF'>&lt;</font>is_copy_constructible<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::value<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
    <font color='#0000FF'>static</font> <font color='#0000FF'>auto</font> <b><a name='make_copy_constructor'></a>make_copy_constructor</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> T <font color='#5555FF'>*</font>x<font face='Lucida Console'>)</font> <font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font> <b><a name='decltype'></a>decltype</b><font face='Lucida Console'>(</font><font color='#0000FF'>new</font> <font color='#BB00BB'>T</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>x<font face='Lucida Console'>)</font>, Constructor<b>{</b><b>}</b><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>return</font> []<font face='Lucida Console'>(</font><font color='#0000FF'>const</font> <font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font>arg<font face='Lucida Console'>)</font> <font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font> <font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font> <b>{</b>
            <font color='#0000FF'>return</font> <font color='#0000FF'>new</font> <font color='#BB00BB'>T</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font color='#0000FF'>reinterpret_cast</font><font color='#5555FF'>&lt;</font><font color='#0000FF'>const</font> T <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>arg<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        <b>}</b>;
    <b>}</b>

    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T, <font color='#0000FF'>typename</font> <font color='#5555FF'>=</font> enable_if_t<font color='#5555FF'>&lt;</font>std::is_move_constructible<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::value<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
    <font color='#0000FF'>static</font> <font color='#0000FF'>auto</font> <b><a name='make_move_constructor'></a>make_move_constructor</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> T <font color='#5555FF'>*</font>x<font face='Lucida Console'>)</font> <font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font> <b><a name='decltype'></a>decltype</b><font face='Lucida Console'>(</font><font color='#0000FF'>new</font> <font color='#BB00BB'>T</font><font face='Lucida Console'>(</font>std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font color='#0000FF'>const_cast</font><font color='#5555FF'>&lt;</font>T <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>x<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>, Constructor<b>{</b><b>}</b><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>return</font> []<font face='Lucida Console'>(</font><font color='#0000FF'>const</font> <font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font>arg<font face='Lucida Console'>)</font> <font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font> <font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font> <b>{</b>
            <font color='#0000FF'>return</font> <font color='#0000FF'>new</font> <font color='#BB00BB'>T</font><font face='Lucida Console'>(</font>std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font color='#0000FF'>const_cast</font><font color='#5555FF'>&lt;</font>T <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font color='#0000FF'>reinterpret_cast</font><font color='#5555FF'>&lt;</font><font color='#0000FF'>const</font> T <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>arg<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        <b>}</b>;
    <b>}</b>

    <font color='#0000FF'>static</font> Constructor <b><a name='make_copy_constructor'></a>make_copy_constructor</b><font face='Lucida Console'>(</font>...<font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> nullptr; <b>}</b>
    <font color='#0000FF'>static</font> Constructor <b><a name='make_move_constructor'></a>make_move_constructor</b><font face='Lucida Console'>(</font>...<font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> nullptr; <b>}</b>
<b>}</b>;

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> type, <font color='#0000FF'>typename</font> SFINAE <font color='#5555FF'>=</font> <font color='#0000FF'><u>void</u></font><font color='#5555FF'>&gt;</font> <font color='#0000FF'>class</font> <b><a name='type_caster'></a>type_caster</b> : <font color='#0000FF'>public</font> type_caster_base<font color='#5555FF'>&lt;</font>type<font color='#5555FF'>&gt;</font> <b>{</b> <b>}</b>;
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> type<font color='#5555FF'>&gt;</font> <font color='#0000FF'>using</font> make_caster <font color='#5555FF'>=</font> type_caster<font color='#5555FF'>&lt;</font>intrinsic_t<font color='#5555FF'>&lt;</font>type<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>;

<font color='#009900'>// Shortcut for calling a caster's `cast_op_type` cast operator for casting a type_caster to a T
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font> <font color='#0000FF'>typename</font> make_caster<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::<font color='#0000FF'>template</font> cast_op_type<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font> <b><a name='cast_op'></a>cast_op</b><font face='Lucida Console'>(</font>make_caster<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font> <font color='#5555FF'>&amp;</font>caster<font face='Lucida Console'>)</font> <b>{</b>
    <font color='#0000FF'>return</font> caster.<font color='#0000FF'>operator</font> <font color='#0000FF'>typename</font> make_caster<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::<font color='#0000FF'>template</font> cast_op_type<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
<b>}</b>
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font> <font color='#0000FF'>typename</font> make_caster<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::<font color='#0000FF'>template</font> cast_op_type<font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> std::add_rvalue_reference<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::type<font color='#5555FF'>&gt;</font>
<b><a name='cast_op'></a>cast_op</b><font face='Lucida Console'>(</font>make_caster<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>caster<font face='Lucida Console'>)</font> <b>{</b>
    <font color='#0000FF'>return</font> std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font>caster<font face='Lucida Console'>)</font>.<font color='#0000FF'>operator</font>
        <font color='#0000FF'>typename</font> make_caster<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::<font color='#0000FF'>template</font> cast_op_type<font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> std::add_rvalue_reference<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::type<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> type<font color='#5555FF'>&gt;</font> <font color='#0000FF'>class</font> <b><a name='type_caster'></a>type_caster</b><font color='#5555FF'>&lt;</font>std::reference_wrapper<font color='#5555FF'>&lt;</font>type<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <b>{</b>
<font color='#0000FF'>private</font>:
    <font color='#0000FF'>using</font> caster_t <font color='#5555FF'>=</font> make_caster<font color='#5555FF'>&lt;</font>type<font color='#5555FF'>&gt;</font>;
    caster_t subcaster;
    <font color='#0000FF'>using</font> subcaster_cast_op_type <font color='#5555FF'>=</font> <font color='#0000FF'>typename</font> caster_t::<font color='#0000FF'>template</font> cast_op_type<font color='#5555FF'>&lt;</font>type<font color='#5555FF'>&gt;</font>;
    <b><a name='static_assert'></a>static_assert</b><font face='Lucida Console'>(</font>std::is_same<font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> std::remove_const<font color='#5555FF'>&lt;</font>type<font color='#5555FF'>&gt;</font>::type <font color='#5555FF'>&amp;</font>, subcaster_cast_op_type<font color='#5555FF'>&gt;</font>::value,
            "<font color='#CC0000'>std::reference_wrapper&lt;T&gt; caster requires T to have a caster with an `T &amp;` operator</font>"<font face='Lucida Console'>)</font>;
<font color='#0000FF'>public</font>:
    <font color='#0000FF'><u>bool</u></font> <b><a name='load'></a>load</b><font face='Lucida Console'>(</font>handle src, <font color='#0000FF'><u>bool</u></font> convert<font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> subcaster.<font color='#BB00BB'>load</font><font face='Lucida Console'>(</font>src, convert<font face='Lucida Console'>)</font>; <b>}</b>
    <font color='#0000FF'>static</font> PYBIND11_DESCR <b><a name='name'></a>name</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> caster_t::<font color='#BB00BB'>name</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>; <b>}</b>
    <font color='#0000FF'>static</font> handle <b><a name='cast'></a>cast</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> std::reference_wrapper<font color='#5555FF'>&lt;</font>type<font color='#5555FF'>&gt;</font> <font color='#5555FF'>&amp;</font>src, return_value_policy policy, handle parent<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#009900'>// It is definitely wrong to take ownership of this pointer, so mask that rvp
</font>        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>policy <font color='#5555FF'>=</font><font color='#5555FF'>=</font> return_value_policy::take_ownership <font color='#5555FF'>|</font><font color='#5555FF'>|</font> policy <font color='#5555FF'>=</font><font color='#5555FF'>=</font> return_value_policy::automatic<font face='Lucida Console'>)</font>
            policy <font color='#5555FF'>=</font> return_value_policy::automatic_reference;
        <font color='#0000FF'>return</font> caster_t::<font color='#BB00BB'>cast</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>src.<font color='#BB00BB'>get</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, policy, parent<font face='Lucida Console'>)</font>;
    <b>}</b>
    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font> <font color='#0000FF'>using</font> cast_op_type <font color='#5555FF'>=</font> std::reference_wrapper<font color='#5555FF'>&lt;</font>type<font color='#5555FF'>&gt;</font>;
    <b><a name='operator'></a>operator</b> std::reference_wrapper<font color='#5555FF'>&lt;</font>type<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> subcaster.<font color='#0000FF'>operator</font> subcaster_cast_op_type<font color='#5555FF'>&amp;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>; <b>}</b>
<b>}</b>;

<font color='#0000FF'>#define</font> PYBIND11_TYPE_CASTER<font face='Lucida Console'>(</font>type, py_name<font face='Lucida Console'>)</font> \
    <font color='#0000FF'>protected</font>: \
        type value; \
    <font color='#0000FF'>public</font>: \
        <font color='#0000FF'>static</font> PYBIND11_DESCR <b><a name='name'></a>name</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> <font color='#BB00BB'>type_descr</font><font face='Lucida Console'>(</font>py_name<font face='Lucida Console'>)</font>; <b>}</b> \
        <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T_, enable_if_t<font color='#5555FF'>&lt;</font>std::is_same<font color='#5555FF'>&lt;</font>type, remove_cv_t<font color='#5555FF'>&lt;</font>T_<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>::value, <font color='#0000FF'><u>int</u></font><font color='#5555FF'>&gt;</font> <font color='#5555FF'>=</font> <font color='#979000'>0</font><font color='#5555FF'>&gt;</font> \
        <font color='#0000FF'>static</font> handle <b><a name='cast'></a>cast</b><font face='Lucida Console'>(</font>T_ <font color='#5555FF'>*</font>src, return_value_policy policy, handle parent<font face='Lucida Console'>)</font> <b>{</b> \
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>src<font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> <font color='#BB00BB'>none</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>.<font color='#BB00BB'>release</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>; \
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>policy <font color='#5555FF'>=</font><font color='#5555FF'>=</font> return_value_policy::take_ownership<font face='Lucida Console'>)</font> <b>{</b> \
                <font color='#0000FF'>auto</font> h <font color='#5555FF'>=</font> <font color='#BB00BB'>cast</font><font face='Lucida Console'>(</font>std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>src<font face='Lucida Console'>)</font>, policy, parent<font face='Lucida Console'>)</font>; <font color='#0000FF'>delete</font> src; <font color='#0000FF'>return</font> h; \
            <b>}</b> <font color='#0000FF'>else</font> <b>{</b> \
                <font color='#0000FF'>return</font> <font color='#BB00BB'>cast</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>src, policy, parent<font face='Lucida Console'>)</font>; \
            <b>}</b> \
        <b>}</b> \
        <b><a name='operator'></a>operator</b> type<font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> <font color='#5555FF'>&amp;</font>value; <b>}</b> \
        <b><a name='operator'></a>operator</b> type<font color='#5555FF'>&amp;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> value; <b>}</b> \
        <b><a name='operator'></a>operator</b> type<font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <b>{</b> <font color='#0000FF'>return</font> std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font>value<font face='Lucida Console'>)</font>; <b>}</b> \
        <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T_<font color='#5555FF'>&gt;</font> <font color='#0000FF'>using</font> cast_op_type <font color='#5555FF'>=</font> pybind11::detail::movable_cast_op_type<font color='#5555FF'>&lt;</font>T_<font color='#5555FF'>&gt;</font>


<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> CharT<font color='#5555FF'>&gt;</font> <font color='#0000FF'>using</font> is_std_char_type <font color='#5555FF'>=</font> any_of<font color='#5555FF'>&lt;</font>
    std::is_same<font color='#5555FF'>&lt;</font>CharT, <font color='#0000FF'><u>char</u></font><font color='#5555FF'>&gt;</font>, <font color='#009900'>/* std::string */</font>
    std::is_same<font color='#5555FF'>&lt;</font>CharT, char16_t<font color='#5555FF'>&gt;</font>, <font color='#009900'>/* std::u16string */</font>
    std::is_same<font color='#5555FF'>&lt;</font>CharT, char32_t<font color='#5555FF'>&gt;</font>, <font color='#009900'>/* std::u32string */</font>
    std::is_same<font color='#5555FF'>&lt;</font>CharT, <font color='#0000FF'><u>wchar_t</u></font><font color='#5555FF'>&gt;</font> <font color='#009900'>/* std::wstring */</font>
<font color='#5555FF'>&gt;</font>;

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>struct</font> <b><a name='type_caster'></a>type_caster</b><font color='#5555FF'>&lt;</font>T, enable_if_t<font color='#5555FF'>&lt;</font>std::is_arithmetic<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::value <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#5555FF'>!</font>is_std_char_type<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::value<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <b>{</b>
    <font color='#0000FF'>using</font> _py_type_0 <font color='#5555FF'>=</font> conditional_t<font color='#5555FF'>&lt;</font><font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font>T<font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>long</u></font><font face='Lucida Console'>)</font>, <font color='#0000FF'><u>long</u></font>, <font color='#0000FF'><u>long</u></font> <font color='#0000FF'><u>long</u></font><font color='#5555FF'>&gt;</font>;
    <font color='#0000FF'>using</font> _py_type_1 <font color='#5555FF'>=</font> conditional_t<font color='#5555FF'>&lt;</font>std::is_signed<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::value, _py_type_0, <font color='#0000FF'>typename</font> std::make_unsigned<font color='#5555FF'>&lt;</font>_py_type_0<font color='#5555FF'>&gt;</font>::type<font color='#5555FF'>&gt;</font>;
    <font color='#0000FF'>using</font> py_type <font color='#5555FF'>=</font> conditional_t<font color='#5555FF'>&lt;</font>std::is_floating_point<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::value, <font color='#0000FF'><u>double</u></font>, _py_type_1<font color='#5555FF'>&gt;</font>;
<font color='#0000FF'>public</font>:

    <font color='#0000FF'><u>bool</u></font> <b><a name='load'></a>load</b><font face='Lucida Console'>(</font>handle src, <font color='#0000FF'><u>bool</u></font> convert<font face='Lucida Console'>)</font> <b>{</b>
        py_type py_value;

        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>src<font face='Lucida Console'>)</font>
            <font color='#0000FF'>return</font> <font color='#979000'>false</font>;

        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>std::is_floating_point<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::value<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>convert <font color='#5555FF'>|</font><font color='#5555FF'>|</font> <font color='#BB00BB'>PyFloat_Check</font><font face='Lucida Console'>(</font>src.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
                py_value <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>py_type<font face='Lucida Console'>)</font> <font color='#BB00BB'>PyFloat_AsDouble</font><font face='Lucida Console'>(</font>src.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
            <font color='#0000FF'>else</font>
                <font color='#0000FF'>return</font> <font color='#979000'>false</font>;
        <b>}</b> <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>PyFloat_Check</font><font face='Lucida Console'>(</font>src.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>return</font> <font color='#979000'>false</font>;
        <b>}</b> <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>std::is_unsigned<font color='#5555FF'>&lt;</font>py_type<font color='#5555FF'>&gt;</font>::value<font face='Lucida Console'>)</font> <b>{</b>
            py_value <font color='#5555FF'>=</font> as_unsigned<font color='#5555FF'>&lt;</font>py_type<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>src.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        <b>}</b> <font color='#0000FF'>else</font> <b>{</b> <font color='#009900'>// signed integer:
</font>            py_value <font color='#5555FF'>=</font> <font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font>T<font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>long</u></font><font face='Lucida Console'>)</font>
                ? <font face='Lucida Console'>(</font>py_type<font face='Lucida Console'>)</font> <font color='#BB00BB'>PyLong_AsLong</font><font face='Lucida Console'>(</font>src.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
                : <font face='Lucida Console'>(</font>py_type<font face='Lucida Console'>)</font> <font color='#BB00BB'>PYBIND11_LONG_AS_LONGLONG</font><font face='Lucida Console'>(</font>src.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        <b>}</b>

        <font color='#0000FF'><u>bool</u></font> py_err <font color='#5555FF'>=</font> py_value <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>py_type<font face='Lucida Console'>)</font> <font color='#5555FF'>-</font><font color='#979000'>1</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#BB00BB'>PyErr_Occurred</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>py_err <font color='#5555FF'>|</font><font color='#5555FF'>|</font> <font face='Lucida Console'>(</font>std::is_integral<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::value <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font>py_type<font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font>T<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                       <font face='Lucida Console'>(</font>py_value <font color='#5555FF'>&lt;</font> <font face='Lucida Console'>(</font>py_type<font face='Lucida Console'>)</font> std::numeric_limits<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::<font color='#BB00BB'>min</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
                        py_value <font color='#5555FF'>&gt;</font> <font face='Lucida Console'>(</font>py_type<font face='Lucida Console'>)</font> std::numeric_limits<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::<font color='#BB00BB'>max</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'><u>bool</u></font> type_error <font color='#5555FF'>=</font> py_err <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#BB00BB'>PyErr_ExceptionMatches</font><font face='Lucida Console'>(</font>
<font color='#0000FF'>#if</font> PY_VERSION_HEX <font color='#5555FF'>&lt;</font> <font color='#979000'>0x03000000</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#5555FF'>!</font>defined<font face='Lucida Console'>(</font>PYPY_VERSION<font face='Lucida Console'>)</font>
                PyExc_SystemError
<font color='#0000FF'>#else</font>
                PyExc_TypeError
<font color='#0000FF'>#endif</font>
            <font face='Lucida Console'>)</font>;
            <font color='#BB00BB'>PyErr_Clear</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>type_error <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> convert <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#BB00BB'>PyNumber_Check</font><font face='Lucida Console'>(</font>src.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
                <font color='#0000FF'>auto</font> tmp <font color='#5555FF'>=</font> reinterpret_steal<font color='#5555FF'>&lt;</font>object<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>std::is_floating_point<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::value
                                                     ? <font color='#BB00BB'>PyNumber_Float</font><font face='Lucida Console'>(</font>src.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
                                                     : <font color='#BB00BB'>PyNumber_Long</font><font face='Lucida Console'>(</font>src.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
                <font color='#BB00BB'>PyErr_Clear</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
                <font color='#0000FF'>return</font> <font color='#BB00BB'>load</font><font face='Lucida Console'>(</font>tmp, <font color='#979000'>false</font><font face='Lucida Console'>)</font>;
            <b>}</b>
            <font color='#0000FF'>return</font> <font color='#979000'>false</font>;
        <b>}</b>

        value <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>T<font face='Lucida Console'>)</font> py_value;
        <font color='#0000FF'>return</font> <font color='#979000'>true</font>;
    <b>}</b>

    <font color='#0000FF'>static</font> handle <b><a name='cast'></a>cast</b><font face='Lucida Console'>(</font>T src, return_value_policy <font color='#009900'>/* policy */</font>, handle <font color='#009900'>/* parent */</font><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>std::is_floating_point<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::value<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>return</font> <font color='#BB00BB'>PyFloat_FromDouble</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>double</u></font><font face='Lucida Console'>)</font> src<font face='Lucida Console'>)</font>;
        <b>}</b> <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font>T<font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>long</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>std::is_signed<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::value<font face='Lucida Console'>)</font>
                <font color='#0000FF'>return</font> <font color='#BB00BB'>PyLong_FromLong</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>long</u></font><font face='Lucida Console'>)</font> src<font face='Lucida Console'>)</font>;
            <font color='#0000FF'>else</font>
                <font color='#0000FF'>return</font> <font color='#BB00BB'>PyLong_FromUnsignedLong</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>long</u></font><font face='Lucida Console'>)</font> src<font face='Lucida Console'>)</font>;
        <b>}</b> <font color='#0000FF'>else</font> <b>{</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>std::is_signed<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::value<font face='Lucida Console'>)</font>
                <font color='#0000FF'>return</font> <font color='#BB00BB'>PyLong_FromLongLong</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>long</u></font> <font color='#0000FF'><u>long</u></font><font face='Lucida Console'>)</font> src<font face='Lucida Console'>)</font>;
            <font color='#0000FF'>else</font>
                <font color='#0000FF'>return</font> <font color='#BB00BB'>PyLong_FromUnsignedLongLong</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>long</u></font> <font color='#0000FF'><u>long</u></font><font face='Lucida Console'>)</font> src<font face='Lucida Console'>)</font>;
        <b>}</b>
    <b>}</b>

    <b><a name='PYBIND11_TYPE_CASTER'></a>PYBIND11_TYPE_CASTER</b><font face='Lucida Console'>(</font>T, _<font color='#5555FF'>&lt;</font>std::is_integral<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::value<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>int</font>", "<font color='#CC0000'>float</font>"<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
<b>}</b>;

<font color='#0000FF'>template</font><font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font> <font color='#0000FF'>struct</font> <b><a name='void_caster'></a>void_caster</b> <b>{</b>
<font color='#0000FF'>public</font>:
    <font color='#0000FF'><u>bool</u></font> <b><a name='load'></a>load</b><font face='Lucida Console'>(</font>handle src, <font color='#0000FF'><u>bool</u></font><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>src <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> src.<font color='#BB00BB'>is_none</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
            <font color='#0000FF'>return</font> <font color='#979000'>true</font>;
        <font color='#0000FF'>return</font> <font color='#979000'>false</font>;
    <b>}</b>
    <font color='#0000FF'>static</font> handle <b><a name='cast'></a>cast</b><font face='Lucida Console'>(</font>T, return_value_policy <font color='#009900'>/* policy */</font>, handle <font color='#009900'>/* parent */</font><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>return</font> <font color='#BB00BB'>none</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>.<font color='#BB00BB'>inc_ref</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
    <b>}</b>
    <b><a name='PYBIND11_TYPE_CASTER'></a>PYBIND11_TYPE_CASTER</b><font face='Lucida Console'>(</font>T, <font color='#BB00BB'>_</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>None</font>"<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
<b>}</b>;

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&gt;</font> <font color='#0000FF'>class</font> <b><a name='type_caster'></a>type_caster</b><font color='#5555FF'>&lt;</font>void_type<font color='#5555FF'>&gt;</font> : <font color='#0000FF'>public</font> void_caster<font color='#5555FF'>&lt;</font>void_type<font color='#5555FF'>&gt;</font> <b>{</b><b>}</b>;

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&gt;</font> <font color='#0000FF'>class</font> <b><a name='type_caster'></a>type_caster</b><font color='#5555FF'>&lt;</font><font color='#0000FF'><u>void</u></font><font color='#5555FF'>&gt;</font> : <font color='#0000FF'>public</font> type_caster<font color='#5555FF'>&lt;</font>void_type<font color='#5555FF'>&gt;</font> <b>{</b>
<font color='#0000FF'>public</font>:
    <font color='#0000FF'>using</font> type_caster<font color='#5555FF'>&lt;</font>void_type<font color='#5555FF'>&gt;</font>::cast;

    <font color='#0000FF'><u>bool</u></font> <b><a name='load'></a>load</b><font face='Lucida Console'>(</font>handle h, <font color='#0000FF'><u>bool</u></font><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>h<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>return</font> <font color='#979000'>false</font>;
        <b>}</b> <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>h.<font color='#BB00BB'>is_none</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
            value <font color='#5555FF'>=</font> nullptr;
            <font color='#0000FF'>return</font> <font color='#979000'>true</font>;
        <b>}</b>

        <font color='#009900'>/* Check if this is a capsule */</font>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>isinstance<font color='#5555FF'>&lt;</font>capsule<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>h<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
            value <font color='#5555FF'>=</font> reinterpret_borrow<font color='#5555FF'>&lt;</font>capsule<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>h<font face='Lucida Console'>)</font>;
            <font color='#0000FF'>return</font> <font color='#979000'>true</font>;
        <b>}</b>

        <font color='#009900'>/* Check if this is a C++ type */</font>
        <font color='#0000FF'>auto</font> <font color='#5555FF'>&amp;</font>bases <font color='#5555FF'>=</font> <font color='#BB00BB'>all_type_info</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>PyTypeObject <font color='#5555FF'>*</font><font face='Lucida Console'>)</font> h.<font color='#BB00BB'>get_type</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>bases.<font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <b>{</b> <font color='#009900'>// Only allowing loading from a single-value type
</font>            value <font color='#5555FF'>=</font> <font color='#BB00BB'>values_and_holders</font><font face='Lucida Console'>(</font><font color='#0000FF'>reinterpret_cast</font><font color='#5555FF'>&lt;</font>instance <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>h.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>.<font color='#BB00BB'>begin</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font><font color='#BB00BB'>value_ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
            <font color='#0000FF'>return</font> <font color='#979000'>true</font>;
        <b>}</b>

        <font color='#009900'>/* Fail */</font>
        <font color='#0000FF'>return</font> <font color='#979000'>false</font>;
    <b>}</b>

    <font color='#0000FF'>static</font> handle <b><a name='cast'></a>cast</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> <font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font>ptr, return_value_policy <font color='#009900'>/* policy */</font>, handle <font color='#009900'>/* parent */</font><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>ptr<font face='Lucida Console'>)</font>
            <font color='#0000FF'>return</font> <font color='#BB00BB'>capsule</font><font face='Lucida Console'>(</font>ptr<font face='Lucida Console'>)</font>.<font color='#BB00BB'>release</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>else</font>
            <font color='#0000FF'>return</font> <font color='#BB00BB'>none</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>.<font color='#BB00BB'>inc_ref</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font> <font color='#0000FF'>using</font> cast_op_type <font color='#5555FF'>=</font> <font color='#0000FF'><u>void</u></font><font color='#5555FF'>*</font><font color='#5555FF'>&amp;</font>;
    <b><a name='operator'></a>operator</b> <font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font><font color='#5555FF'>&amp;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> value; <b>}</b>
    <font color='#0000FF'>static</font> PYBIND11_DESCR <b><a name='name'></a>name</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> <font color='#BB00BB'>type_descr</font><font face='Lucida Console'>(</font><font color='#BB00BB'>_</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>capsule</font>"<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>; <b>}</b>
<font color='#0000FF'>private</font>:
    <font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font>value <font color='#5555FF'>=</font> nullptr;
<b>}</b>;

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&gt;</font> <font color='#0000FF'>class</font> <b><a name='type_caster'></a>type_caster</b><font color='#5555FF'>&lt;</font>std::nullptr_t<font color='#5555FF'>&gt;</font> : <font color='#0000FF'>public</font> void_caster<font color='#5555FF'>&lt;</font>std::nullptr_t<font color='#5555FF'>&gt;</font> <b>{</b> <b>}</b>;

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&gt;</font> <font color='#0000FF'>class</font> <b><a name='type_caster'></a>type_caster</b><font color='#5555FF'>&lt;</font><font color='#0000FF'><u>bool</u></font><font color='#5555FF'>&gt;</font> <b>{</b>
<font color='#0000FF'>public</font>:
    <font color='#0000FF'><u>bool</u></font> <b><a name='load'></a>load</b><font face='Lucida Console'>(</font>handle src, <font color='#0000FF'><u>bool</u></font> convert<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>src<font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> <font color='#979000'>false</font>;
        <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>src.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Py_True<font face='Lucida Console'>)</font> <b>{</b> value <font color='#5555FF'>=</font> <font color='#979000'>true</font>; <font color='#0000FF'>return</font> <font color='#979000'>true</font>; <b>}</b>
        <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>src.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Py_False<font face='Lucida Console'>)</font> <b>{</b> value <font color='#5555FF'>=</font> <font color='#979000'>false</font>; <font color='#0000FF'>return</font> <font color='#979000'>true</font>; <b>}</b>
        <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>convert <font color='#5555FF'>|</font><font color='#5555FF'>|</font> <font color='#5555FF'>!</font><font color='#BB00BB'>strcmp</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>numpy.bool_</font>", <font color='#BB00BB'>Py_TYPE</font><font face='Lucida Console'>(</font>src.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>tp_name<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
            <font color='#009900'>// (allow non-implicit conversion for numpy booleans)
</font>
            Py_ssize_t res <font color='#5555FF'>=</font> <font color='#5555FF'>-</font><font color='#979000'>1</font>;
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>src.<font color='#BB00BB'>is_none</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
                res <font color='#5555FF'>=</font> <font color='#979000'>0</font>;  <font color='#009900'>// None is implicitly converted to False
</font>            <b>}</b>
            <font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>PYPY_VERSION<font face='Lucida Console'>)</font>
            <font color='#009900'>// On PyPy, check that "__bool__" (or "__nonzero__" on Python 2.7) attr exists
</font>            <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>hasattr</font><font face='Lucida Console'>(</font>src, PYBIND11_BOOL_ATTR<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
                res <font color='#5555FF'>=</font> <font color='#BB00BB'>PyObject_IsTrue</font><font face='Lucida Console'>(</font>src.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
            <b>}</b>
            <font color='#0000FF'>#else</font>
            <font color='#009900'>// Alternate approach for CPython: this does the same as the above, but optimized
</font>            <font color='#009900'>// using the CPython API so as to avoid an unneeded attribute lookup.
</font>            <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#0000FF'>auto</font> tp_as_number <font color='#5555FF'>=</font> src.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>ob_type<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>tp_as_number<font face='Lucida Console'>)</font> <b>{</b>
                <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>PYBIND11_NB_BOOL</font><font face='Lucida Console'>(</font>tp_as_number<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
                    res <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font color='#BB00BB'>PYBIND11_NB_BOOL</font><font face='Lucida Console'>(</font>tp_as_number<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>src.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
                <b>}</b>
            <b>}</b>
            <font color='#0000FF'>#endif</font>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>res <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> res <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <b>{</b>
                value <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>bool</u></font><font face='Lucida Console'>)</font> res;
                <font color='#0000FF'>return</font> <font color='#979000'>true</font>;
            <b>}</b>
        <b>}</b>
        <font color='#0000FF'>return</font> <font color='#979000'>false</font>;
    <b>}</b>
    <font color='#0000FF'>static</font> handle <b><a name='cast'></a>cast</b><font face='Lucida Console'>(</font><font color='#0000FF'><u>bool</u></font> src, return_value_policy <font color='#009900'>/* policy */</font>, handle <font color='#009900'>/* parent */</font><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>return</font> <font color='#BB00BB'>handle</font><font face='Lucida Console'>(</font>src ? Py_True : Py_False<font face='Lucida Console'>)</font>.<font color='#BB00BB'>inc_ref</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
    <b>}</b>
    <b><a name='PYBIND11_TYPE_CASTER'></a>PYBIND11_TYPE_CASTER</b><font face='Lucida Console'>(</font><font color='#0000FF'><u>bool</u></font>, <font color='#BB00BB'>_</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>bool</font>"<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
<b>}</b>;

<font color='#009900'>// Helper class for UTF-{8,16,32} C++ stl strings:
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> StringType, <font color='#0000FF'><u>bool</u></font> IsView <font color='#5555FF'>=</font> <font color='#979000'>false</font><font color='#5555FF'>&gt;</font> <font color='#0000FF'>struct</font> <b><a name='string_caster'></a>string_caster</b> <b>{</b>
    <font color='#0000FF'>using</font> CharT <font color='#5555FF'>=</font> <font color='#0000FF'>typename</font> StringType::value_type;

    <font color='#009900'>// Simplify life by being able to assume standard char sizes (the standard only guarantees
</font>    <font color='#009900'>// minimums, but Python requires exact sizes)
</font>    <b><a name='static_assert'></a>static_assert</b><font face='Lucida Console'>(</font><font color='#5555FF'>!</font>std::is_same<font color='#5555FF'>&lt;</font>CharT, <font color='#0000FF'><u>char</u></font><font color='#5555FF'>&gt;</font>::value <font color='#5555FF'>|</font><font color='#5555FF'>|</font> <font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font>CharT<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>1</font>, "<font color='#CC0000'>Unsupported char size != 1</font>"<font face='Lucida Console'>)</font>;
    <b><a name='static_assert'></a>static_assert</b><font face='Lucida Console'>(</font><font color='#5555FF'>!</font>std::is_same<font color='#5555FF'>&lt;</font>CharT, char16_t<font color='#5555FF'>&gt;</font>::value <font color='#5555FF'>|</font><font color='#5555FF'>|</font> <font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font>CharT<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>2</font>, "<font color='#CC0000'>Unsupported char16_t size != 2</font>"<font face='Lucida Console'>)</font>;
    <b><a name='static_assert'></a>static_assert</b><font face='Lucida Console'>(</font><font color='#5555FF'>!</font>std::is_same<font color='#5555FF'>&lt;</font>CharT, char32_t<font color='#5555FF'>&gt;</font>::value <font color='#5555FF'>|</font><font color='#5555FF'>|</font> <font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font>CharT<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>4</font>, "<font color='#CC0000'>Unsupported char32_t size != 4</font>"<font face='Lucida Console'>)</font>;
    <font color='#009900'>// wchar_t can be either 16 bits (Windows) or 32 (everywhere else)
</font>    <b><a name='static_assert'></a>static_assert</b><font face='Lucida Console'>(</font><font color='#5555FF'>!</font>std::is_same<font color='#5555FF'>&lt;</font>CharT, <font color='#0000FF'><u>wchar_t</u></font><font color='#5555FF'>&gt;</font>::value <font color='#5555FF'>|</font><font color='#5555FF'>|</font> <font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font>CharT<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>2</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> <font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font>CharT<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>4</font>,
            "<font color='#CC0000'>Unsupported wchar_t size != 2/4</font>"<font face='Lucida Console'>)</font>;
    <font color='#0000FF'>static</font> constexpr <font color='#0000FF'><u>size_t</u></font> UTF_N <font color='#5555FF'>=</font> <font color='#979000'>8</font> <font color='#5555FF'>*</font> <font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font>CharT<font face='Lucida Console'>)</font>;

    <font color='#0000FF'><u>bool</u></font> <b><a name='load'></a>load</b><font face='Lucida Console'>(</font>handle src, <font color='#0000FF'><u>bool</u></font><font face='Lucida Console'>)</font> <b>{</b>
<font color='#0000FF'>#if</font> PY_MAJOR_VERSION <font color='#5555FF'>&lt;</font> <font color='#979000'>3</font>
        object temp;
<font color='#0000FF'>#endif</font>
        handle load_src <font color='#5555FF'>=</font> src;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>src<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>return</font> <font color='#979000'>false</font>;
        <b>}</b> <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>PyUnicode_Check</font><font face='Lucida Console'>(</font>load_src.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
<font color='#0000FF'>#if</font> PY_MAJOR_VERSION <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>3</font>
            <font color='#0000FF'>return</font> <font color='#BB00BB'>load_bytes</font><font face='Lucida Console'>(</font>load_src<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#else</font>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font>CharT<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <b>{</b>
                <font color='#0000FF'>return</font> <font color='#BB00BB'>load_bytes</font><font face='Lucida Console'>(</font>load_src<font face='Lucida Console'>)</font>;
            <b>}</b>

            <font color='#009900'>// The below is a guaranteed failure in Python 3 when PyUnicode_Check returns false
</font>            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>PYBIND11_BYTES_CHECK</font><font face='Lucida Console'>(</font>load_src.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
                <font color='#0000FF'>return</font> <font color='#979000'>false</font>;

            temp <font color='#5555FF'>=</font> reinterpret_steal<font color='#5555FF'>&lt;</font>object<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font color='#BB00BB'>PyUnicode_FromObject</font><font face='Lucida Console'>(</font>load_src.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>temp<font face='Lucida Console'>)</font> <b>{</b> <font color='#BB00BB'>PyErr_Clear</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>; <font color='#0000FF'>return</font> <font color='#979000'>false</font>; <b>}</b>
            load_src <font color='#5555FF'>=</font> temp;
<font color='#0000FF'>#endif</font>
        <b>}</b>

        object utfNbytes <font color='#5555FF'>=</font> reinterpret_steal<font color='#5555FF'>&lt;</font>object<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font color='#BB00BB'>PyUnicode_AsEncodedString</font><font face='Lucida Console'>(</font>
            load_src.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, UTF_N <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>8</font> ? "<font color='#CC0000'>utf-8</font>" : UTF_N <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>16</font> ? "<font color='#CC0000'>utf-16</font>" : "<font color='#CC0000'>utf-32</font>", nullptr<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>utfNbytes<font face='Lucida Console'>)</font> <b>{</b> <font color='#BB00BB'>PyErr_Clear</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>; <font color='#0000FF'>return</font> <font color='#979000'>false</font>; <b>}</b>

        <font color='#0000FF'>const</font> CharT <font color='#5555FF'>*</font>buffer <font color='#5555FF'>=</font> <font color='#0000FF'>reinterpret_cast</font><font color='#5555FF'>&lt;</font><font color='#0000FF'>const</font> CharT <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font color='#BB00BB'>PYBIND11_BYTES_AS_STRING</font><font face='Lucida Console'>(</font>utfNbytes.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'><u>size_t</u></font> length <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>size_t</u></font><font face='Lucida Console'>)</font> <font color='#BB00BB'>PYBIND11_BYTES_SIZE</font><font face='Lucida Console'>(</font>utfNbytes.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>/</font> <font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font>CharT<font face='Lucida Console'>)</font>;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>UTF_N <font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <b>{</b> buffer<font color='#5555FF'>+</font><font color='#5555FF'>+</font>; length<font color='#5555FF'>-</font><font color='#5555FF'>-</font>; <b>}</b> <font color='#009900'>// Skip BOM for UTF-16/32
</font>        value <font color='#5555FF'>=</font> <font color='#BB00BB'>StringType</font><font face='Lucida Console'>(</font>buffer, length<font face='Lucida Console'>)</font>;

        <font color='#009900'>// If we're loading a string_view we need to keep the encoded Python object alive:
</font>        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>IsView<font face='Lucida Console'>)</font>
            loader_life_support::<font color='#BB00BB'>add_patient</font><font face='Lucida Console'>(</font>utfNbytes<font face='Lucida Console'>)</font>;

        <font color='#0000FF'>return</font> <font color='#979000'>true</font>;
    <b>}</b>

    <font color='#0000FF'>static</font> handle <b><a name='cast'></a>cast</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> StringType <font color='#5555FF'>&amp;</font>src, return_value_policy <font color='#009900'>/* policy */</font>, handle <font color='#009900'>/* parent */</font><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>const</font> <font color='#0000FF'><u>char</u></font> <font color='#5555FF'>*</font>buffer <font color='#5555FF'>=</font> <font color='#0000FF'>reinterpret_cast</font><font color='#5555FF'>&lt;</font><font color='#0000FF'>const</font> <font color='#0000FF'><u>char</u></font> <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>src.<font color='#BB00BB'>data</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        ssize_t nbytes <font color='#5555FF'>=</font> <font color='#BB00BB'>ssize_t</font><font face='Lucida Console'>(</font>src.<font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>*</font> <font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font>CharT<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        handle s <font color='#5555FF'>=</font> <font color='#BB00BB'>decode_utfN</font><font face='Lucida Console'>(</font>buffer, nbytes<font face='Lucida Console'>)</font>;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>s<font face='Lucida Console'>)</font> <font color='#0000FF'>throw</font> <font color='#BB00BB'>error_already_set</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>return</font> s;
    <b>}</b>

    <b><a name='PYBIND11_TYPE_CASTER'></a>PYBIND11_TYPE_CASTER</b><font face='Lucida Console'>(</font>StringType, <font color='#BB00BB'>_</font><font face='Lucida Console'>(</font>PYBIND11_STRING_NAME<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

<font color='#0000FF'>private</font>:
    <font color='#0000FF'>static</font> handle <b><a name='decode_utfN'></a>decode_utfN</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> <font color='#0000FF'><u>char</u></font> <font color='#5555FF'>*</font>buffer, ssize_t nbytes<font face='Lucida Console'>)</font> <b>{</b>
<font color='#0000FF'>#if</font> <font color='#5555FF'>!</font>defined<font face='Lucida Console'>(</font>PYPY_VERSION<font face='Lucida Console'>)</font>
        <font color='#0000FF'>return</font>
            UTF_N <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>8</font>  ? <font color='#BB00BB'>PyUnicode_DecodeUTF8</font><font face='Lucida Console'>(</font>buffer, nbytes, nullptr<font face='Lucida Console'>)</font> :
            UTF_N <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>16</font> ? <font color='#BB00BB'>PyUnicode_DecodeUTF16</font><font face='Lucida Console'>(</font>buffer, nbytes, nullptr, nullptr<font face='Lucida Console'>)</font> :
                          <font color='#BB00BB'>PyUnicode_DecodeUTF32</font><font face='Lucida Console'>(</font>buffer, nbytes, nullptr, nullptr<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#else</font>
        <font color='#009900'>// PyPy seems to have multiple problems related to PyUnicode_UTF*: the UTF8 version
</font>        <font color='#009900'>// sometimes segfaults for unknown reasons, while the UTF16 and 32 versions require a
</font>        <font color='#009900'>// non-const char * arguments, which is also a nuissance, so bypass the whole thing by just
</font>        <font color='#009900'>// passing the encoding as a string value, which works properly:
</font>        <font color='#0000FF'>return</font> <font color='#BB00BB'>PyUnicode_Decode</font><font face='Lucida Console'>(</font>buffer, nbytes, UTF_N <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>8</font> ? "<font color='#CC0000'>utf-8</font>" : UTF_N <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>16</font> ? "<font color='#CC0000'>utf-16</font>" : "<font color='#CC0000'>utf-32</font>", nullptr<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>
    <b>}</b>

    <font color='#009900'>// When loading into a std::string or char*, accept a bytes object as-is (i.e.
</font>    <font color='#009900'>// without any encoding/decoding attempt).  For other C++ char sizes this is a no-op.
</font>    <font color='#009900'>// which supports loading a unicode from a str, doesn't take this path.
</font>    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> C <font color='#5555FF'>=</font> CharT<font color='#5555FF'>&gt;</font>
    <font color='#0000FF'><u>bool</u></font> <b><a name='load_bytes'></a>load_bytes</b><font face='Lucida Console'>(</font>enable_if_t<font color='#5555FF'>&lt;</font><font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font>C<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>1</font>, handle<font color='#5555FF'>&gt;</font> src<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>PYBIND11_BYTES_CHECK</font><font face='Lucida Console'>(</font>src.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
            <font color='#009900'>// We were passed a Python 3 raw bytes; accept it into a std::string or char*
</font>            <font color='#009900'>// without any encoding attempt.
</font>            <font color='#0000FF'>const</font> <font color='#0000FF'><u>char</u></font> <font color='#5555FF'>*</font>bytes <font color='#5555FF'>=</font> <font color='#BB00BB'>PYBIND11_BYTES_AS_STRING</font><font face='Lucida Console'>(</font>src.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>bytes<font face='Lucida Console'>)</font> <b>{</b>
                value <font color='#5555FF'>=</font> <font color='#BB00BB'>StringType</font><font face='Lucida Console'>(</font>bytes, <font face='Lucida Console'>(</font><font color='#0000FF'><u>size_t</u></font><font face='Lucida Console'>)</font> <font color='#BB00BB'>PYBIND11_BYTES_SIZE</font><font face='Lucida Console'>(</font>src.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
                <font color='#0000FF'>return</font> <font color='#979000'>true</font>;
            <b>}</b>
        <b>}</b>

        <font color='#0000FF'>return</font> <font color='#979000'>false</font>;
    <b>}</b>

    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> C <font color='#5555FF'>=</font> CharT<font color='#5555FF'>&gt;</font>
    <font color='#0000FF'><u>bool</u></font> <b><a name='load_bytes'></a>load_bytes</b><font face='Lucida Console'>(</font>enable_if_t<font color='#5555FF'>&lt;</font><font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font>C<font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>1</font>, handle<font color='#5555FF'>&gt;</font><font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> <font color='#979000'>false</font>; <b>}</b>
<b>}</b>;

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> CharT, <font color='#0000FF'>class</font> <b><a name='Traits'></a>Traits</b>, <font color='#0000FF'>class</font> <b><a name='Allocator'></a>Allocator</b><font color='#5555FF'>&gt;</font>
<font color='#0000FF'>struct</font> <b><a name='type_caster'></a>type_caster</b><font color='#5555FF'>&lt;</font>std::basic_string<font color='#5555FF'>&lt;</font>CharT, Traits, Allocator<font color='#5555FF'>&gt;</font>, enable_if_t<font color='#5555FF'>&lt;</font>is_std_char_type<font color='#5555FF'>&lt;</font>CharT<font color='#5555FF'>&gt;</font>::value<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
    : string_caster<font color='#5555FF'>&lt;</font>std::basic_string<font color='#5555FF'>&lt;</font>CharT, Traits, Allocator<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <b>{</b><b>}</b>;

<font color='#0000FF'>#ifdef</font> PYBIND11_HAS_STRING_VIEW
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> CharT, <font color='#0000FF'>class</font> <b><a name='Traits'></a>Traits</b><font color='#5555FF'>&gt;</font>
<font color='#0000FF'>struct</font> <b><a name='type_caster'></a>type_caster</b><font color='#5555FF'>&lt;</font>std::basic_string_view<font color='#5555FF'>&lt;</font>CharT, Traits<font color='#5555FF'>&gt;</font>, enable_if_t<font color='#5555FF'>&lt;</font>is_std_char_type<font color='#5555FF'>&lt;</font>CharT<font color='#5555FF'>&gt;</font>::value<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
    : string_caster<font color='#5555FF'>&lt;</font>std::basic_string_view<font color='#5555FF'>&lt;</font>CharT, Traits<font color='#5555FF'>&gt;</font>, <font color='#979000'>true</font><font color='#5555FF'>&gt;</font> <b>{</b><b>}</b>;
<font color='#0000FF'>#endif</font>

<font color='#009900'>// Type caster for C-style strings.  We basically use a std::string type caster, but also add the
</font><font color='#009900'>// ability to use None as a nullptr char* (which the string caster doesn't allow).
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> CharT<font color='#5555FF'>&gt;</font> <font color='#0000FF'>struct</font> <b><a name='type_caster'></a>type_caster</b><font color='#5555FF'>&lt;</font>CharT, enable_if_t<font color='#5555FF'>&lt;</font>is_std_char_type<font color='#5555FF'>&lt;</font>CharT<font color='#5555FF'>&gt;</font>::value<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <b>{</b>
    <font color='#0000FF'>using</font> StringType <font color='#5555FF'>=</font> std::basic_string<font color='#5555FF'>&lt;</font>CharT<font color='#5555FF'>&gt;</font>;
    <font color='#0000FF'>using</font> StringCaster <font color='#5555FF'>=</font> type_caster<font color='#5555FF'>&lt;</font>StringType<font color='#5555FF'>&gt;</font>;
    StringCaster str_caster;
    <font color='#0000FF'><u>bool</u></font> none <font color='#5555FF'>=</font> <font color='#979000'>false</font>;
    CharT one_char <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
<font color='#0000FF'>public</font>:
    <font color='#0000FF'><u>bool</u></font> <b><a name='load'></a>load</b><font face='Lucida Console'>(</font>handle src, <font color='#0000FF'><u>bool</u></font> convert<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>src<font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> <font color='#979000'>false</font>;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>src.<font color='#BB00BB'>is_none</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
            <font color='#009900'>// Defer accepting None to other overloads (if we aren't in convert mode):
</font>            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>convert<font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> <font color='#979000'>false</font>;
            none <font color='#5555FF'>=</font> <font color='#979000'>true</font>;
            <font color='#0000FF'>return</font> <font color='#979000'>true</font>;
        <b>}</b>
        <font color='#0000FF'>return</font> str_caster.<font color='#BB00BB'>load</font><font face='Lucida Console'>(</font>src, convert<font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#0000FF'>static</font> handle <b><a name='cast'></a>cast</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> CharT <font color='#5555FF'>*</font>src, return_value_policy policy, handle parent<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>src <font color='#5555FF'>=</font><font color='#5555FF'>=</font> nullptr<font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> pybind11::<font color='#BB00BB'>none</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>.<font color='#BB00BB'>inc_ref</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>return</font> StringCaster::<font color='#BB00BB'>cast</font><font face='Lucida Console'>(</font><font color='#BB00BB'>StringType</font><font face='Lucida Console'>(</font>src<font face='Lucida Console'>)</font>, policy, parent<font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#0000FF'>static</font> handle <b><a name='cast'></a>cast</b><font face='Lucida Console'>(</font>CharT src, return_value_policy policy, handle parent<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>std::is_same<font color='#5555FF'>&lt;</font><font color='#0000FF'><u>char</u></font>, CharT<font color='#5555FF'>&gt;</font>::value<font face='Lucida Console'>)</font> <b>{</b>
            handle s <font color='#5555FF'>=</font> <font color='#BB00BB'>PyUnicode_DecodeLatin1</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> <font color='#0000FF'><u>char</u></font> <font color='#5555FF'>*</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font>src, <font color='#979000'>1</font>, nullptr<font face='Lucida Console'>)</font>;
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>s<font face='Lucida Console'>)</font> <font color='#0000FF'>throw</font> <font color='#BB00BB'>error_already_set</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
            <font color='#0000FF'>return</font> s;
        <b>}</b>
        <font color='#0000FF'>return</font> StringCaster::<font color='#BB00BB'>cast</font><font face='Lucida Console'>(</font><font color='#BB00BB'>StringType</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, src<font face='Lucida Console'>)</font>, policy, parent<font face='Lucida Console'>)</font>;
    <b>}</b>

    <b><a name='operator'></a>operator</b> CharT<font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> none ? nullptr : <font color='#0000FF'>const_cast</font><font color='#5555FF'>&lt;</font>CharT <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font color='#0000FF'>static_cast</font><font color='#5555FF'>&lt;</font>StringType <font color='#5555FF'>&amp;</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>str_caster<font face='Lucida Console'>)</font>.<font color='#BB00BB'>c_str</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>; <b>}</b>
    <b><a name='operator'></a>operator</b> CharT<font color='#5555FF'>&amp;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>none<font face='Lucida Console'>)</font>
            <font color='#0000FF'>throw</font> <font color='#BB00BB'>value_error</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>Cannot convert None to a character</font>"<font face='Lucida Console'>)</font>;

        <font color='#0000FF'>auto</font> <font color='#5555FF'>&amp;</font>value <font color='#5555FF'>=</font> <font color='#0000FF'>static_cast</font><font color='#5555FF'>&lt;</font>StringType <font color='#5555FF'>&amp;</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>str_caster<font face='Lucida Console'>)</font>;
        <font color='#0000FF'><u>size_t</u></font> str_len <font color='#5555FF'>=</font> value.<font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>str_len <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
            <font color='#0000FF'>throw</font> <font color='#BB00BB'>value_error</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>Cannot convert empty string to a character</font>"<font face='Lucida Console'>)</font>;

        <font color='#009900'>// If we're in UTF-8 mode, we have two possible failures: one for a unicode character that
</font>        <font color='#009900'>// is too high, and one for multiple unicode characters (caught later), so we need to figure
</font>        <font color='#009900'>// out how long the first encoded character is in bytes to distinguish between these two
</font>        <font color='#009900'>// errors.  We also allow want to allow unicode characters U+0080 through U+00FF, as those
</font>        <font color='#009900'>// can fit into a single char value.
</font>        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>StringCaster::UTF_N <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>8</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> str_len <font color='#5555FF'>&gt;</font> <font color='#979000'>1</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> str_len <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>char</u></font> v0 <font color='#5555FF'>=</font> <font color='#0000FF'>static_cast</font><font color='#5555FF'>&lt;</font><font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>char</u></font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>value[<font color='#979000'>0</font>]<font face='Lucida Console'>)</font>;
            <font color='#0000FF'><u>size_t</u></font> char0_bytes <font color='#5555FF'>=</font> <font color='#5555FF'>!</font><font face='Lucida Console'>(</font>v0 <font color='#5555FF'>&amp;</font> <font color='#979000'>0x80</font><font face='Lucida Console'>)</font> ? <font color='#979000'>1</font> : <font color='#009900'>// low bits only: 0-127
</font>                <font face='Lucida Console'>(</font>v0 <font color='#5555FF'>&amp;</font> <font color='#979000'>0xE0</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0xC0</font> ? <font color='#979000'>2</font> : <font color='#009900'>// 0b110xxxxx - start of 2-byte sequence
</font>                <font face='Lucida Console'>(</font>v0 <font color='#5555FF'>&amp;</font> <font color='#979000'>0xF0</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0xE0</font> ? <font color='#979000'>3</font> : <font color='#009900'>// 0b1110xxxx - start of 3-byte sequence
</font>                <font color='#979000'>4</font>; <font color='#009900'>// 0b11110xxx - start of 4-byte sequence
</font>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>char0_bytes <font color='#5555FF'>=</font><font color='#5555FF'>=</font> str_len<font face='Lucida Console'>)</font> <b>{</b>
                <font color='#009900'>// If we have a 128-255 value, we can decode it into a single char:
</font>                <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>char0_bytes <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>2</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font>v0 <font color='#5555FF'>&amp;</font> <font color='#979000'>0xFC</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0xC0</font><font face='Lucida Console'>)</font> <b>{</b> <font color='#009900'>// 0x110000xx 0x10xxxxxx
</font>                    one_char <font color='#5555FF'>=</font> <font color='#0000FF'>static_cast</font><font color='#5555FF'>&lt;</font>CharT<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>v0 <font color='#5555FF'>&amp;</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>6</font><font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font><font color='#0000FF'>static_cast</font><font color='#5555FF'>&lt;</font><font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>char</u></font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>value[<font color='#979000'>1</font>]<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0x3F</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
                    <font color='#0000FF'>return</font> one_char;
                <b>}</b>
                <font color='#009900'>// Otherwise we have a single character, but it's &gt; U+00FF
</font>                <font color='#0000FF'>throw</font> <font color='#BB00BB'>value_error</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>Character code point not in range(0x100)</font>"<font face='Lucida Console'>)</font>;
            <b>}</b>
        <b>}</b>

        <font color='#009900'>// UTF-16 is much easier: we can only have a surrogate pair for values above U+FFFF, thus a
</font>        <font color='#009900'>// surrogate pair with total length 2 instantly indicates a range error (but not a "your
</font>        <font color='#009900'>// string was too long" error).
</font>        <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>StringCaster::UTF_N <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>16</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> str_len <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font> <b>{</b>
            one_char <font color='#5555FF'>=</font> <font color='#0000FF'>static_cast</font><font color='#5555FF'>&lt;</font>CharT<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>value[<font color='#979000'>0</font>]<font face='Lucida Console'>)</font>;
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>one_char <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>0xD800</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> one_char <font color='#5555FF'>&lt;</font> <font color='#979000'>0xE000</font><font face='Lucida Console'>)</font>
                <font color='#0000FF'>throw</font> <font color='#BB00BB'>value_error</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>Character code point not in range(0x10000)</font>"<font face='Lucida Console'>)</font>;
        <b>}</b>

        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>str_len <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>
            <font color='#0000FF'>throw</font> <font color='#BB00BB'>value_error</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>Expected a character, but multi-character string found</font>"<font face='Lucida Console'>)</font>;

        one_char <font color='#5555FF'>=</font> value[<font color='#979000'>0</font>];
        <font color='#0000FF'>return</font> one_char;
    <b>}</b>

    <font color='#0000FF'>static</font> PYBIND11_DESCR <b><a name='name'></a>name</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> <font color='#BB00BB'>type_descr</font><font face='Lucida Console'>(</font><font color='#BB00BB'>_</font><font face='Lucida Console'>(</font>PYBIND11_STRING_NAME<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>; <b>}</b>
    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> _T<font color='#5555FF'>&gt;</font> <font color='#0000FF'>using</font> cast_op_type <font color='#5555FF'>=</font> pybind11::detail::cast_op_type<font color='#5555FF'>&lt;</font>_T<font color='#5555FF'>&gt;</font>;
<b>}</b>;

<font color='#009900'>// Base implementation for std::tuple and std::pair
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>template</font><font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font>...<font color='#5555FF'>&gt;</font> <font color='#0000FF'>class</font> <b><a name='Tuple'></a>Tuple</b>, <font color='#0000FF'>typename</font>... Ts<font color='#5555FF'>&gt;</font> <font color='#0000FF'>class</font> <b><a name='tuple_caster'></a>tuple_caster</b> <b>{</b>
    <font color='#0000FF'>using</font> type <font color='#5555FF'>=</font> Tuple<font color='#5555FF'>&lt;</font>Ts...<font color='#5555FF'>&gt;</font>;
    <font color='#0000FF'>static</font> constexpr <font color='#0000FF'>auto</font> size <font color='#5555FF'>=</font> <font color='#0000FF'>sizeof</font>...<font face='Lucida Console'>(</font>Ts<font face='Lucida Console'>)</font>;
    <font color='#0000FF'>using</font> indices <font color='#5555FF'>=</font> make_index_sequence<font color='#5555FF'>&lt;</font>size<font color='#5555FF'>&gt;</font>;
<font color='#0000FF'>public</font>:

    <font color='#0000FF'><u>bool</u></font> <b><a name='load'></a>load</b><font face='Lucida Console'>(</font>handle src, <font color='#0000FF'><u>bool</u></font> convert<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>isinstance<font color='#5555FF'>&lt;</font>sequence<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>src<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
            <font color='#0000FF'>return</font> <font color='#979000'>false</font>;
        <font color='#0000FF'>const</font> <font color='#0000FF'>auto</font> seq <font color='#5555FF'>=</font> reinterpret_borrow<font color='#5555FF'>&lt;</font>sequence<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>src<font face='Lucida Console'>)</font>;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>seq.<font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> size<font face='Lucida Console'>)</font>
            <font color='#0000FF'>return</font> <font color='#979000'>false</font>;
        <font color='#0000FF'>return</font> <font color='#BB00BB'>load_impl</font><font face='Lucida Console'>(</font>seq, convert, indices<b>{</b><b>}</b><font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font>
    <font color='#0000FF'>static</font> handle <b><a name='cast'></a>cast</b><font face='Lucida Console'>(</font>T <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>src, return_value_policy policy, handle parent<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>return</font> <font color='#BB00BB'>cast_impl</font><font face='Lucida Console'>(</font>std::forward<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>src<font face='Lucida Console'>)</font>, policy, parent, indices<b>{</b><b>}</b><font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#0000FF'>static</font> PYBIND11_DESCR <b><a name='name'></a>name</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>return</font> <font color='#BB00BB'>type_descr</font><font face='Lucida Console'>(</font><font color='#BB00BB'>_</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>Tuple[</font>"<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> detail::<font color='#BB00BB'>concat</font><font face='Lucida Console'>(</font>make_caster<font color='#5555FF'>&lt;</font>Ts<font color='#5555FF'>&gt;</font>::<font color='#BB00BB'>name</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>...<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> <font color='#BB00BB'>_</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>]</font>"<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font> <font color='#0000FF'>using</font> cast_op_type <font color='#5555FF'>=</font> type;

    <b><a name='operator'></a>operator</b> <b><a name='type'></a>type</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <b>{</b> <font color='#0000FF'>return</font> <font color='#BB00BB'>implicit_cast</font><font face='Lucida Console'>(</font>indices<b>{</b><b>}</b><font face='Lucida Console'>)</font>; <b>}</b>
    <b><a name='operator'></a>operator</b> <b><a name='type'></a>type</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <b>{</b> <font color='#0000FF'>return</font> std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font color='#0000FF'>this</font><font face='Lucida Console'>)</font>.<font color='#BB00BB'>implicit_cast</font><font face='Lucida Console'>(</font>indices<b>{</b><b>}</b><font face='Lucida Console'>)</font>; <b>}</b>

<font color='#0000FF'>protected</font>:
    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'><u>size_t</u></font>... Is<font color='#5555FF'>&gt;</font>
    type <b><a name='implicit_cast'></a>implicit_cast</b><font face='Lucida Console'>(</font>index_sequence<font color='#5555FF'>&lt;</font>Is...<font color='#5555FF'>&gt;</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <b>{</b> <font color='#0000FF'>return</font> <font color='#BB00BB'>type</font><font face='Lucida Console'>(</font>cast_op<font color='#5555FF'>&lt;</font>Ts<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>std::get<font color='#5555FF'>&lt;</font>Is<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>subcasters<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>...<font face='Lucida Console'>)</font>; <b>}</b>
    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'><u>size_t</u></font>... Is<font color='#5555FF'>&gt;</font>
    type <b><a name='implicit_cast'></a>implicit_cast</b><font face='Lucida Console'>(</font>index_sequence<font color='#5555FF'>&lt;</font>Is...<font color='#5555FF'>&gt;</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <b>{</b> <font color='#0000FF'>return</font> <font color='#BB00BB'>type</font><font face='Lucida Console'>(</font>cast_op<font color='#5555FF'>&lt;</font>Ts<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font>std::get<font color='#5555FF'>&lt;</font>Is<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>subcasters<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>...<font face='Lucida Console'>)</font>; <b>}</b>

    <font color='#0000FF'>static</font> constexpr <font color='#0000FF'><u>bool</u></font> <b><a name='load_impl'></a>load_impl</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> sequence <font color='#5555FF'>&amp;</font>, <font color='#0000FF'><u>bool</u></font>, index_sequence<font color='#5555FF'>&lt;</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> <font color='#979000'>true</font>; <b>}</b>

    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'><u>size_t</u></font>... Is<font color='#5555FF'>&gt;</font>
    <font color='#0000FF'><u>bool</u></font> <b><a name='load_impl'></a>load_impl</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> sequence <font color='#5555FF'>&amp;</font>seq, <font color='#0000FF'><u>bool</u></font> convert, index_sequence<font color='#5555FF'>&lt;</font>Is...<font color='#5555FF'>&gt;</font><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>bool</u></font> r : <b>{</b>std::get<font color='#5555FF'>&lt;</font>Is<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>subcasters<font face='Lucida Console'>)</font>.<font color='#BB00BB'>load</font><font face='Lucida Console'>(</font>seq[Is], convert<font face='Lucida Console'>)</font>...<b>}</b><font face='Lucida Console'>)</font>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>r<font face='Lucida Console'>)</font>
                <font color='#0000FF'>return</font> <font color='#979000'>false</font>;
        <font color='#0000FF'>return</font> <font color='#979000'>true</font>;
    <b>}</b>

    <font color='#009900'>/* Implementation: Convert a C++ tuple into a Python tuple */</font>
    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T, <font color='#0000FF'><u>size_t</u></font>... Is<font color='#5555FF'>&gt;</font>
    <font color='#0000FF'>static</font> handle <b><a name='cast_impl'></a>cast_impl</b><font face='Lucida Console'>(</font>T <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>src, return_value_policy policy, handle parent, index_sequence<font color='#5555FF'>&lt;</font>Is...<font color='#5555FF'>&gt;</font><font face='Lucida Console'>)</font> <b>{</b>
        std::array<font color='#5555FF'>&lt;</font>object, size<font color='#5555FF'>&gt;</font> entries<b>{</b><b>{</b>
            reinterpret_steal<font color='#5555FF'>&lt;</font>object<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>make_caster<font color='#5555FF'>&lt;</font>Ts<font color='#5555FF'>&gt;</font>::<font color='#BB00BB'>cast</font><font face='Lucida Console'>(</font>std::get<font color='#5555FF'>&lt;</font>Is<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>std::forward<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>src<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>, policy, parent<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>...
        <b>}</b><b>}</b>;
        <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font><font color='#0000FF'>const</font> <font color='#0000FF'>auto</font> <font color='#5555FF'>&amp;</font>entry: entries<font face='Lucida Console'>)</font>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>entry<font face='Lucida Console'>)</font>
                <font color='#0000FF'>return</font> <font color='#BB00BB'>handle</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        tuple <font color='#BB00BB'>result</font><font face='Lucida Console'>(</font>size<font face='Lucida Console'>)</font>;
        <font color='#0000FF'><u>int</u></font> counter <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
        <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font><font color='#0000FF'>auto</font> <font color='#5555FF'>&amp;</font> entry: entries<font face='Lucida Console'>)</font>
            <font color='#BB00BB'>PyTuple_SET_ITEM</font><font face='Lucida Console'>(</font>result.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, counter<font color='#5555FF'>+</font><font color='#5555FF'>+</font>, entry.<font color='#BB00BB'>release</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>return</font> result.<font color='#BB00BB'>release</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
    <b>}</b>

    Tuple<font color='#5555FF'>&lt;</font>make_caster<font color='#5555FF'>&lt;</font>Ts<font color='#5555FF'>&gt;</font>...<font color='#5555FF'>&gt;</font> subcasters;
<b>}</b>;

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T1, <font color='#0000FF'>typename</font> T2<font color='#5555FF'>&gt;</font> <font color='#0000FF'>class</font> <b><a name='type_caster'></a>type_caster</b><font color='#5555FF'>&lt;</font>std::pair<font color='#5555FF'>&lt;</font>T1, T2<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
    : <font color='#0000FF'>public</font> tuple_caster<font color='#5555FF'>&lt;</font>std::pair, T1, T2<font color='#5555FF'>&gt;</font> <b>{</b><b>}</b>;

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font>... Ts<font color='#5555FF'>&gt;</font> <font color='#0000FF'>class</font> <b><a name='type_caster'></a>type_caster</b><font color='#5555FF'>&lt;</font>std::tuple<font color='#5555FF'>&lt;</font>Ts...<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
    : <font color='#0000FF'>public</font> tuple_caster<font color='#5555FF'>&lt;</font>std::tuple, Ts...<font color='#5555FF'>&gt;</font> <b>{</b><b>}</b>;

<font color='#009900'>/// Helper class which abstracts away certain actions. Users can provide specializations for
</font><font color='#009900'>/// custom holders, but it's only necessary if the type has a non-standard interface.
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>struct</font> <b><a name='holder_helper'></a>holder_helper</b> <b>{</b>
    <font color='#0000FF'>static</font> <font color='#0000FF'>auto</font> <b><a name='get'></a>get</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> T <font color='#5555FF'>&amp;</font>p<font face='Lucida Console'>)</font> <font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font> <b><a name='decltype'></a>decltype</b><font face='Lucida Console'>(</font>p.<font color='#BB00BB'>get</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> p.<font color='#BB00BB'>get</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>; <b>}</b>
<b>}</b>;

<font color='#009900'>/// Type caster for holder types like std::shared_ptr, etc.
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> type, <font color='#0000FF'>typename</font> holder_type<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>struct</font> <b><a name='copyable_holder_caster'></a>copyable_holder_caster</b> : <font color='#0000FF'>public</font> type_caster_base<font color='#5555FF'>&lt;</font>type<font color='#5555FF'>&gt;</font> <b>{</b>
<font color='#0000FF'>public</font>:
    <font color='#0000FF'>using</font> base <font color='#5555FF'>=</font> type_caster_base<font color='#5555FF'>&lt;</font>type<font color='#5555FF'>&gt;</font>;
    <b><a name='static_assert'></a>static_assert</b><font face='Lucida Console'>(</font>std::is_base_of<font color='#5555FF'>&lt;</font>base, type_caster<font color='#5555FF'>&lt;</font>type<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>::value,
            "<font color='#CC0000'>Holder classes are only supported for custom types</font>"<font face='Lucida Console'>)</font>;
    <font color='#0000FF'>using</font> base::base;
    <font color='#0000FF'>using</font> base::cast;
    <font color='#0000FF'>using</font> base::typeinfo;
    <font color='#0000FF'>using</font> base::value;

    <font color='#0000FF'><u>bool</u></font> <b><a name='load'></a>load</b><font face='Lucida Console'>(</font>handle src, <font color='#0000FF'><u>bool</u></font> convert<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>return</font> base::<font color='#0000FF'>template</font> load_impl<font color='#5555FF'>&lt;</font>copyable_holder_caster<font color='#5555FF'>&lt;</font>type, holder_type<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>src, convert<font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#0000FF'>explicit</font> <b><a name='operator'></a>operator</b> type<font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> <font color='#0000FF'>this</font><font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>value; <b>}</b>
    <font color='#0000FF'>explicit</font> <b><a name='operator'></a>operator</b> type<font color='#5555FF'>&amp;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#0000FF'>this</font><font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>value<font face='Lucida Console'>)</font>; <b>}</b>
    <font color='#0000FF'>explicit</font> <b><a name='operator'></a>operator</b> holder_type<font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> <font color='#5555FF'>&amp;</font>holder; <b>}</b>

    <font color='#009900'>// Workaround for Intel compiler bug
</font>    <font color='#009900'>// see pybind11 issue 94
</font>    <font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>__ICC<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> defined<font face='Lucida Console'>(</font>__INTEL_COMPILER<font face='Lucida Console'>)</font>
    <b><a name='operator'></a>operator</b> holder_type<font color='#5555FF'>&amp;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> holder; <b>}</b>
    <font color='#0000FF'>#else</font>
    <font color='#0000FF'>explicit</font> <b><a name='operator'></a>operator</b> holder_type<font color='#5555FF'>&amp;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> holder; <b>}</b>
    <font color='#0000FF'>#endif</font>

    <font color='#0000FF'>static</font> handle <b><a name='cast'></a>cast</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> holder_type <font color='#5555FF'>&amp;</font>src, return_value_policy, handle<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>const</font> <font color='#0000FF'>auto</font> <font color='#5555FF'>*</font>ptr <font color='#5555FF'>=</font> holder_helper<font color='#5555FF'>&lt;</font>holder_type<font color='#5555FF'>&gt;</font>::<font color='#BB00BB'>get</font><font face='Lucida Console'>(</font>src<font face='Lucida Console'>)</font>;
        <font color='#0000FF'>return</font> type_caster_base<font color='#5555FF'>&lt;</font>type<font color='#5555FF'>&gt;</font>::<font color='#BB00BB'>cast_holder</font><font face='Lucida Console'>(</font>ptr, <font color='#5555FF'>&amp;</font>src<font face='Lucida Console'>)</font>;
    <b>}</b>

<font color='#0000FF'>protected</font>:
    <font color='#0000FF'>friend</font> <font color='#0000FF'>class</font> type_caster_generic;
    <font color='#0000FF'><u>void</u></font> <b><a name='check_holder_compat'></a>check_holder_compat</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>typeinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>default_holder<font face='Lucida Console'>)</font>
            <font color='#0000FF'>throw</font> <font color='#BB00BB'>cast_error</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>Unable to load a custom holder type from a default-holder instance</font>"<font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#0000FF'><u>bool</u></font> <b><a name='load_value'></a>load_value</b><font face='Lucida Console'>(</font>value_and_holder <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>v_h<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>v_h.<font color='#BB00BB'>holder_constructed</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
            value <font color='#5555FF'>=</font> v_h.<font color='#BB00BB'>value_ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
            holder <font color='#5555FF'>=</font> v_h.<font color='#0000FF'>template</font> holder<font color='#5555FF'>&lt;</font>holder_type<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
            <font color='#0000FF'>return</font> <font color='#979000'>true</font>;
        <b>}</b> <font color='#0000FF'>else</font> <b>{</b>
            <font color='#0000FF'>throw</font> <font color='#BB00BB'>cast_error</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>Unable to cast from non-held to held instance (T&amp; to Holder&lt;T&gt;) </font>"
<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>NDEBUG<font face='Lucida Console'>)</font>
                             "<font color='#CC0000'>(compile in debug mode for type information)</font>"<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#else</font>
                             "<font color='#CC0000'>of type '</font>" <font color='#5555FF'>+</font> type_id<font color='#5555FF'>&lt;</font>holder_type<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> "<font color='#CC0000'>''</font>"<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>
        <b>}</b>
    <b>}</b>

    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T <font color='#5555FF'>=</font> holder_type, detail::enable_if_t<font color='#5555FF'>&lt;</font><font color='#5555FF'>!</font>std::is_constructible<font color='#5555FF'>&lt;</font>T, <font color='#0000FF'>const</font> T <font color='#5555FF'>&amp;</font>, type<font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font>::value, <font color='#0000FF'><u>int</u></font><font color='#5555FF'>&gt;</font> <font color='#5555FF'>=</font> <font color='#979000'>0</font><font color='#5555FF'>&gt;</font>
    <font color='#0000FF'><u>bool</u></font> <font color='#BB00BB'>try_implicit_casts</font><font face='Lucida Console'>(</font>handle, <font color='#0000FF'><u>bool</u></font><font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> <font color='#979000'>false</font>; <b>}</b>

    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T <font color='#5555FF'>=</font> holder_type, detail::enable_if_t<font color='#5555FF'>&lt;</font>std::is_constructible<font color='#5555FF'>&lt;</font>T, <font color='#0000FF'>const</font> T <font color='#5555FF'>&amp;</font>, type<font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font>::value, <font color='#0000FF'><u>int</u></font><font color='#5555FF'>&gt;</font> <font color='#5555FF'>=</font> <font color='#979000'>0</font><font color='#5555FF'>&gt;</font>
    <font color='#0000FF'><u>bool</u></font> <font color='#BB00BB'>try_implicit_casts</font><font face='Lucida Console'>(</font>handle src, <font color='#0000FF'><u>bool</u></font> convert<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font><font color='#0000FF'>auto</font> <font color='#5555FF'>&amp;</font>cast : typeinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>implicit_casts<font face='Lucida Console'>)</font> <b>{</b>
            copyable_holder_caster <font color='#BB00BB'>sub_caster</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>cast.first<font face='Lucida Console'>)</font>;
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>sub_caster.<font color='#BB00BB'>load</font><font face='Lucida Console'>(</font>src, convert<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
                value <font color='#5555FF'>=</font> cast.<font color='#BB00BB'>second</font><font face='Lucida Console'>(</font>sub_caster.value<font face='Lucida Console'>)</font>;
                holder <font color='#5555FF'>=</font> <font color='#BB00BB'>holder_type</font><font face='Lucida Console'>(</font>sub_caster.holder, <font face='Lucida Console'>(</font>type <font color='#5555FF'>*</font><font face='Lucida Console'>)</font> value<font face='Lucida Console'>)</font>;
                <font color='#0000FF'>return</font> <font color='#979000'>true</font>;
            <b>}</b>
        <b>}</b>
        <font color='#0000FF'>return</font> <font color='#979000'>false</font>;
    <b>}</b>

    <font color='#0000FF'>static</font> <font color='#0000FF'><u>bool</u></font> <font color='#BB00BB'>try_direct_conversions</font><font face='Lucida Console'>(</font>handle<font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> <font color='#979000'>false</font>; <b>}</b>


    holder_type holder;
<b>}</b>;

<font color='#009900'>/// Specialize for the common std::shared_ptr, so users don't need to
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>class</font> <b><a name='type_caster'></a>type_caster</b><font color='#5555FF'>&lt;</font>std::shared_ptr<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> : <font color='#0000FF'>public</font> copyable_holder_caster<font color='#5555FF'>&lt;</font>T, std::shared_ptr<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <b>{</b> <b>}</b>;

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> type, <font color='#0000FF'>typename</font> holder_type<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>struct</font> <b><a name='move_only_holder_caster'></a>move_only_holder_caster</b> <b>{</b>
    <font color='#BB00BB'>static_assert</font><font face='Lucida Console'>(</font>std::is_base_of<font color='#5555FF'>&lt;</font>type_caster_base<font color='#5555FF'>&lt;</font>type<font color='#5555FF'>&gt;</font>, type_caster<font color='#5555FF'>&lt;</font>type<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>::value,
            "<font color='#CC0000'>Holder classes are only supported for custom types</font>"<font face='Lucida Console'>)</font>;

    <font color='#0000FF'>static</font> handle <font color='#BB00BB'>cast</font><font face='Lucida Console'>(</font>holder_type <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>src, return_value_policy, handle<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>auto</font> <font color='#5555FF'>*</font>ptr <font color='#5555FF'>=</font> holder_helper<font color='#5555FF'>&lt;</font>holder_type<font color='#5555FF'>&gt;</font>::<font color='#BB00BB'>get</font><font face='Lucida Console'>(</font>src<font face='Lucida Console'>)</font>;
        <font color='#0000FF'>return</font> type_caster_base<font color='#5555FF'>&lt;</font>type<font color='#5555FF'>&gt;</font>::<font color='#BB00BB'>cast_holder</font><font face='Lucida Console'>(</font>ptr, <font color='#5555FF'>&amp;</font>src<font face='Lucida Console'>)</font>;
    <b>}</b>
    <font color='#0000FF'>static</font> PYBIND11_DESCR <font color='#BB00BB'>name</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> type_caster_base<font color='#5555FF'>&lt;</font>type<font color='#5555FF'>&gt;</font>::<font color='#BB00BB'>name</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>; <b>}</b>
<b>}</b>;

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> type, <font color='#0000FF'>typename</font> deleter<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>class</font> <b><a name='type_caster'></a>type_caster</b><font color='#5555FF'>&lt;</font>std::unique_ptr<font color='#5555FF'>&lt;</font>type, deleter<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
    : <font color='#0000FF'>public</font> move_only_holder_caster<font color='#5555FF'>&lt;</font>type, std::unique_ptr<font color='#5555FF'>&lt;</font>type, deleter<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <b>{</b> <b>}</b>;

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> type, <font color='#0000FF'>typename</font> holder_type<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>using</font> type_caster_holder <font color='#5555FF'>=</font> conditional_t<font color='#5555FF'>&lt;</font>is_copy_constructible<font color='#5555FF'>&lt;</font>holder_type<font color='#5555FF'>&gt;</font>::value,
                                         copyable_holder_caster<font color='#5555FF'>&lt;</font>type, holder_type<font color='#5555FF'>&gt;</font>,
                                         move_only_holder_caster<font color='#5555FF'>&lt;</font>type, holder_type<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>;

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T, <font color='#0000FF'><u>bool</u></font> Value <font color='#5555FF'>=</font> <font color='#979000'>false</font><font color='#5555FF'>&gt;</font> <font color='#0000FF'>struct</font> <b><a name='always_construct_holder'></a>always_construct_holder</b> <b>{</b> <font color='#0000FF'>static</font> constexpr <font color='#0000FF'><u>bool</u></font> value <font color='#5555FF'>=</font> Value; <b>}</b>;

<font color='#009900'>/// Create a specialization for custom holder types (silently ignores std::shared_ptr)
</font><font color='#0000FF'>#define</font> PYBIND11_DECLARE_HOLDER_TYPE<font face='Lucida Console'>(</font>type, holder_type, ...<font face='Lucida Console'>)</font> \
    <font color='#0000FF'>namespace</font> pybind11 <b>{</b> <font color='#0000FF'>namespace</font> detail <b>{</b> \
    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> type<font color='#5555FF'>&gt;</font> \
    <font color='#0000FF'>struct</font> <b><a name='always_construct_holder'></a>always_construct_holder</b><font color='#5555FF'>&lt;</font>holder_type<font color='#5555FF'>&gt;</font> : always_construct_holder<font color='#5555FF'>&lt;</font><font color='#0000FF'><u>void</u></font>, ##__VA_ARGS__<font color='#5555FF'>&gt;</font>  <b>{</b> <b>}</b>; \
    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> type<font color='#5555FF'>&gt;</font> \
    <font color='#0000FF'>class</font> <b><a name='type_caster'></a>type_caster</b><font color='#5555FF'>&lt;</font>holder_type, enable_if_t<font color='#5555FF'>&lt;</font><font color='#5555FF'>!</font>is_shared_ptr<font color='#5555FF'>&lt;</font>holder_type<font color='#5555FF'>&gt;</font>::value<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> \
        : <font color='#0000FF'>public</font> type_caster_holder<font color='#5555FF'>&lt;</font>type, holder_type<font color='#5555FF'>&gt;</font> <b>{</b> <b>}</b>; \
    <b>}</b><b>}</b>

<font color='#009900'>// PYBIND11_DECLARE_HOLDER_TYPE holder types:
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> base, <font color='#0000FF'>typename</font> holder<font color='#5555FF'>&gt;</font> <font color='#0000FF'>struct</font> <b><a name='is_holder_type'></a>is_holder_type</b> :
    std::is_base_of<font color='#5555FF'>&lt;</font>detail::type_caster_holder<font color='#5555FF'>&lt;</font>base, holder<font color='#5555FF'>&gt;</font>, detail::type_caster<font color='#5555FF'>&lt;</font>holder<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <b>{</b><b>}</b>;
<font color='#009900'>// Specialization for always-supported unique_ptr holders:
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> base, <font color='#0000FF'>typename</font> deleter<font color='#5555FF'>&gt;</font> <font color='#0000FF'>struct</font> <b><a name='is_holder_type'></a>is_holder_type</b><font color='#5555FF'>&lt;</font>base, std::unique_ptr<font color='#5555FF'>&lt;</font>base, deleter<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> :
    std::true_type <b>{</b><b>}</b>;

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font> <font color='#0000FF'>struct</font> <b><a name='handle_type_name'></a>handle_type_name</b> <b>{</b> <font color='#0000FF'>static</font> PYBIND11_DESCR <font color='#BB00BB'>name</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> _<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>; <b>}</b> <b>}</b>;
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&gt;</font> <font color='#0000FF'>struct</font> <b><a name='handle_type_name'></a>handle_type_name</b><font color='#5555FF'>&lt;</font>bytes<font color='#5555FF'>&gt;</font> <b>{</b> <font color='#0000FF'>static</font> PYBIND11_DESCR <font color='#BB00BB'>name</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> <font color='#BB00BB'>_</font><font face='Lucida Console'>(</font>PYBIND11_BYTES_NAME<font face='Lucida Console'>)</font>; <b>}</b> <b>}</b>;
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&gt;</font> <font color='#0000FF'>struct</font> <b><a name='handle_type_name'></a>handle_type_name</b><font color='#5555FF'>&lt;</font>args<font color='#5555FF'>&gt;</font> <b>{</b> <font color='#0000FF'>static</font> PYBIND11_DESCR <font color='#BB00BB'>name</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> <font color='#BB00BB'>_</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>*args</font>"<font face='Lucida Console'>)</font>; <b>}</b> <b>}</b>;
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&gt;</font> <font color='#0000FF'>struct</font> <b><a name='handle_type_name'></a>handle_type_name</b><font color='#5555FF'>&lt;</font>kwargs<font color='#5555FF'>&gt;</font> <b>{</b> <font color='#0000FF'>static</font> PYBIND11_DESCR <font color='#BB00BB'>name</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> <font color='#BB00BB'>_</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>**kwargs</font>"<font face='Lucida Console'>)</font>; <b>}</b> <b>}</b>;

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> type<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>struct</font> <b><a name='pyobject_caster'></a>pyobject_caster</b> <b>{</b>
    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T <font color='#5555FF'>=</font> type, enable_if_t<font color='#5555FF'>&lt;</font>std::is_same<font color='#5555FF'>&lt;</font>T, handle<font color='#5555FF'>&gt;</font>::value, <font color='#0000FF'><u>int</u></font><font color='#5555FF'>&gt;</font> <font color='#5555FF'>=</font> <font color='#979000'>0</font><font color='#5555FF'>&gt;</font>
    <font color='#0000FF'><u>bool</u></font> <font color='#BB00BB'>load</font><font face='Lucida Console'>(</font>handle src, <font color='#0000FF'><u>bool</u></font> <font color='#009900'>/* convert */</font><font face='Lucida Console'>)</font> <b>{</b> value <font color='#5555FF'>=</font> src; <font color='#0000FF'>return</font> <font color='#0000FF'>static_cast</font><font color='#5555FF'>&lt;</font><font color='#0000FF'><u>bool</u></font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>value<font face='Lucida Console'>)</font>; <b>}</b>

    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T <font color='#5555FF'>=</font> type, enable_if_t<font color='#5555FF'>&lt;</font>std::is_base_of<font color='#5555FF'>&lt;</font>object, T<font color='#5555FF'>&gt;</font>::value, <font color='#0000FF'><u>int</u></font><font color='#5555FF'>&gt;</font> <font color='#5555FF'>=</font> <font color='#979000'>0</font><font color='#5555FF'>&gt;</font>
    <font color='#0000FF'><u>bool</u></font> <font color='#BB00BB'>load</font><font face='Lucida Console'>(</font>handle src, <font color='#0000FF'><u>bool</u></font> <font color='#009900'>/* convert */</font><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>isinstance<font color='#5555FF'>&lt;</font>type<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>src<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
            <font color='#0000FF'>return</font> <font color='#979000'>false</font>;
        value <font color='#5555FF'>=</font> reinterpret_borrow<font color='#5555FF'>&lt;</font>type<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>src<font face='Lucida Console'>)</font>;
        <font color='#0000FF'>return</font> <font color='#979000'>true</font>;
    <b>}</b>

    <font color='#0000FF'>static</font> handle <font color='#BB00BB'>cast</font><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> handle <font color='#5555FF'>&amp;</font>src, return_value_policy <font color='#009900'>/* policy */</font>, handle <font color='#009900'>/* parent */</font><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>return</font> src.<font color='#BB00BB'>inc_ref</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
    <b>}</b>
    <font color='#BB00BB'>PYBIND11_TYPE_CASTER</font><font face='Lucida Console'>(</font>type, handle_type_name<font color='#5555FF'>&lt;</font>type<font color='#5555FF'>&gt;</font>::<b><a name='name'></a>name</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
<b>}</b>;

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>class</font> <b><a name='type_caster'></a>type_caster</b><font color='#5555FF'>&lt;</font>T, enable_if_t<font color='#5555FF'>&lt;</font>is_pyobject<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::value<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> : <font color='#0000FF'>public</font> pyobject_caster<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font> <b>{</b> <b>}</b>;

<font color='#009900'>// Our conditions for enabling moving are quite restrictive:
</font><font color='#009900'>// At compile time:
</font><font color='#009900'>// - T needs to be a non-const, non-pointer, non-reference type
</font><font color='#009900'>// - type_caster&lt;T&gt;::operator T&amp;() must exist
</font><font color='#009900'>// - the type must be move constructible (obviously)
</font><font color='#009900'>// At run-time:
</font><font color='#009900'>// - if the type is non-copy-constructible, the object must be the sole owner of the type (i.e. it
</font><font color='#009900'>//   must have ref_count() == 1)h
</font><font color='#009900'>// If any of the above are not satisfied, we fall back to copying.
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font> <font color='#0000FF'>using</font> move_is_plain_type <font color='#5555FF'>=</font> satisfies_none_of<font color='#5555FF'>&lt;</font>T,
    std::is_void, std::is_pointer, std::is_reference, std::is_const
<font color='#5555FF'>&gt;</font>;
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T, <font color='#0000FF'>typename</font> SFINAE <font color='#5555FF'>=</font> <font color='#0000FF'><u>void</u></font><font color='#5555FF'>&gt;</font> <font color='#0000FF'>struct</font> <b><a name='move_always'></a>move_always</b> : std::false_type <b>{</b><b>}</b>;
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font> <font color='#0000FF'>struct</font> <b><a name='move_always'></a>move_always</b><font color='#5555FF'>&lt;</font>T, enable_if_t<font color='#5555FF'>&lt;</font>all_of<font color='#5555FF'>&lt;</font>
    move_is_plain_type<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>,
    negation<font color='#5555FF'>&lt;</font>is_copy_constructible<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>,
    std::is_move_constructible<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>,
    std::is_same<font color='#5555FF'>&lt;</font><font color='#BB00BB'>decltype</font><font face='Lucida Console'>(</font>std::declval<font color='#5555FF'>&lt;</font>make_caster<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>.<b><a name='operator'></a>operator</b> T<font color='#5555FF'>&amp;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>, T<font color='#5555FF'>&amp;</font><font color='#5555FF'>&gt;</font>
<font color='#5555FF'>&gt;</font>::value<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> : std::true_type <b>{</b><b>}</b>;
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T, <font color='#0000FF'>typename</font> SFINAE <font color='#5555FF'>=</font> <font color='#0000FF'><u>void</u></font><font color='#5555FF'>&gt;</font> <font color='#0000FF'>struct</font> <b><a name='move_if_unreferenced'></a>move_if_unreferenced</b> : std::false_type <b>{</b><b>}</b>;
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font> <font color='#0000FF'>struct</font> <b><a name='move_if_unreferenced'></a>move_if_unreferenced</b><font color='#5555FF'>&lt;</font>T, enable_if_t<font color='#5555FF'>&lt;</font>all_of<font color='#5555FF'>&lt;</font>
    move_is_plain_type<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>,
    negation<font color='#5555FF'>&lt;</font>move_always<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>,
    std::is_move_constructible<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>,
    std::is_same<font color='#5555FF'>&lt;</font><font color='#BB00BB'>decltype</font><font face='Lucida Console'>(</font>std::declval<font color='#5555FF'>&lt;</font>make_caster<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>.<b><a name='operator'></a>operator</b> T<font color='#5555FF'>&amp;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>, T<font color='#5555FF'>&amp;</font><font color='#5555FF'>&gt;</font>
<font color='#5555FF'>&gt;</font>::value<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> : std::true_type <b>{</b><b>}</b>;
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font> <font color='#0000FF'>using</font> move_never <font color='#5555FF'>=</font> none_of<font color='#5555FF'>&lt;</font>move_always<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>, move_if_unreferenced<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>;

<font color='#009900'>// Detect whether returning a `type` from a cast on type's type_caster is going to result in a
</font><font color='#009900'>// reference or pointer to a local variable of the type_caster.  Basically, only
</font><font color='#009900'>// non-reference/pointer `type`s and reference/pointers from a type_caster_generic are safe;
</font><font color='#009900'>// everything else returns a reference/pointer to a local variable.
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> type<font color='#5555FF'>&gt;</font> <font color='#0000FF'>using</font> cast_is_temporary_value_reference <font color='#5555FF'>=</font> bool_constant<font color='#5555FF'>&lt;</font>
    <font face='Lucida Console'>(</font>std::is_reference<font color='#5555FF'>&lt;</font>type<font color='#5555FF'>&gt;</font>::value <font color='#5555FF'>|</font><font color='#5555FF'>|</font> std::is_pointer<font color='#5555FF'>&lt;</font>type<font color='#5555FF'>&gt;</font>::value<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
    <font color='#5555FF'>!</font>std::is_base_of<font color='#5555FF'>&lt;</font>type_caster_generic, make_caster<font color='#5555FF'>&lt;</font>type<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>::value
<font color='#5555FF'>&gt;</font>;

<font color='#009900'>// When a value returned from a C++ function is being cast back to Python, we almost always want to
</font><font color='#009900'>// force `policy = move`, regardless of the return value policy the function/method was declared
</font><font color='#009900'>// with.  Some classes (most notably Eigen::Ref and related) need to avoid this, and so can do so by
</font><font color='#009900'>// specializing this struct.
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> Return, <font color='#0000FF'>typename</font> SFINAE <font color='#5555FF'>=</font> <font color='#0000FF'><u>void</u></font><font color='#5555FF'>&gt;</font> <font color='#0000FF'>struct</font> <b><a name='return_value_policy_override'></a>return_value_policy_override</b> <b>{</b>
    <font color='#0000FF'>static</font> return_value_policy <font color='#BB00BB'>policy</font><font face='Lucida Console'>(</font>return_value_policy p<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>return</font> <font color='#5555FF'>!</font>std::is_lvalue_reference<font color='#5555FF'>&lt;</font>Return<font color='#5555FF'>&gt;</font>::value <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#5555FF'>!</font>std::is_pointer<font color='#5555FF'>&lt;</font>Return<font color='#5555FF'>&gt;</font>::value
            ? return_value_policy::move : p;
    <b>}</b>
<b>}</b>;

<font color='#009900'>// Basic python -&gt; C++ casting; throws if casting fails
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T, <font color='#0000FF'>typename</font> SFINAE<font color='#5555FF'>&gt;</font> type_caster<font color='#5555FF'>&lt;</font>T, SFINAE<font color='#5555FF'>&gt;</font> <font color='#5555FF'>&amp;</font><font color='#BB00BB'>load_type</font><font face='Lucida Console'>(</font>type_caster<font color='#5555FF'>&lt;</font>T, SFINAE<font color='#5555FF'>&gt;</font> <font color='#5555FF'>&amp;</font>conv, <font color='#0000FF'>const</font> handle <font color='#5555FF'>&amp;</font>handle<font face='Lucida Console'>)</font> <b>{</b>
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>conv.<font color='#BB00BB'>load</font><font face='Lucida Console'>(</font>handle, <font color='#979000'>true</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>NDEBUG<font face='Lucida Console'>)</font>
        <font color='#0000FF'>throw</font> <font color='#BB00BB'>cast_error</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>Unable to cast Python instance to C++ type (compile in debug mode for details)</font>"<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#else</font>
        <font color='#0000FF'>throw</font> <font color='#BB00BB'>cast_error</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>Unable to cast Python instance of type </font>" <font color='#5555FF'>+</font>
            <font face='Lucida Console'>(</font>std::string<font face='Lucida Console'>)</font> <font color='#BB00BB'>str</font><font face='Lucida Console'>(</font>handle.<font color='#BB00BB'>get_type</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> "<font color='#CC0000'> to C++ type '</font>" <font color='#5555FF'>+</font> type_id<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> "<font color='#CC0000'>'</font>"<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>
    <b>}</b>
    <font color='#0000FF'>return</font> conv;
<b>}</b>
<font color='#009900'>// Wrapper around the above that also constructs and returns a type_caster
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font> make_caster<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font> <font color='#BB00BB'>load_type</font><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> handle <font color='#5555FF'>&amp;</font>handle<font face='Lucida Console'>)</font> <b>{</b>
    make_caster<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font> conv;
    <font color='#BB00BB'>load_type</font><font face='Lucida Console'>(</font>conv, handle<font face='Lucida Console'>)</font>;
    <font color='#0000FF'>return</font> conv;
<b>}</b>

<font color='#BB00BB'>NAMESPACE_END</font><font face='Lucida Console'>(</font>detail<font face='Lucida Console'>)</font>

<font color='#009900'>// pytype -&gt; C++ type
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T, detail::enable_if_t<font color='#5555FF'>&lt;</font><font color='#5555FF'>!</font>detail::is_pyobject<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::value, <font color='#0000FF'><u>int</u></font><font color='#5555FF'>&gt;</font> <font color='#5555FF'>=</font> <font color='#979000'>0</font><font color='#5555FF'>&gt;</font>
T <font color='#BB00BB'>cast</font><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> handle <font color='#5555FF'>&amp;</font>handle<font face='Lucida Console'>)</font> <b>{</b>
    <font color='#0000FF'>using</font> <font color='#0000FF'>namespace</font> detail;
    <font color='#BB00BB'>static_assert</font><font face='Lucida Console'>(</font><font color='#5555FF'>!</font>cast_is_temporary_value_reference<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::value,
            "<font color='#CC0000'>Unable to cast type to reference: value is local to type caster</font>"<font face='Lucida Console'>)</font>;
    <font color='#0000FF'>return</font> cast_op<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>load_type<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>handle<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#009900'>// pytype -&gt; pytype (calls converting constructor)
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T, detail::enable_if_t<font color='#5555FF'>&lt;</font>detail::is_pyobject<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::value, <font color='#0000FF'><u>int</u></font><font color='#5555FF'>&gt;</font> <font color='#5555FF'>=</font> <font color='#979000'>0</font><font color='#5555FF'>&gt;</font>
T <font color='#BB00BB'>cast</font><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> handle <font color='#5555FF'>&amp;</font>handle<font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> <font color='#BB00BB'>T</font><font face='Lucida Console'>(</font>reinterpret_borrow<font color='#5555FF'>&lt;</font>object<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>handle<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>; <b>}</b>

<font color='#009900'>// C++ type -&gt; py::object
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T, detail::enable_if_t<font color='#5555FF'>&lt;</font><font color='#5555FF'>!</font>detail::is_pyobject<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::value, <font color='#0000FF'><u>int</u></font><font color='#5555FF'>&gt;</font> <font color='#5555FF'>=</font> <font color='#979000'>0</font><font color='#5555FF'>&gt;</font>
object <font color='#BB00BB'>cast</font><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> T <font color='#5555FF'>&amp;</font>value, return_value_policy policy <font color='#5555FF'>=</font> return_value_policy::automatic_reference,
            handle parent <font color='#5555FF'>=</font> <b><a name='handle'></a>handle</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>policy <font color='#5555FF'>=</font><font color='#5555FF'>=</font> return_value_policy::automatic<font face='Lucida Console'>)</font>
        policy <font color='#5555FF'>=</font> std::is_pointer<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::value ? return_value_policy::take_ownership : return_value_policy::copy;
    <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>policy <font color='#5555FF'>=</font><font color='#5555FF'>=</font> return_value_policy::automatic_reference<font face='Lucida Console'>)</font>
        policy <font color='#5555FF'>=</font> std::is_pointer<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::value ? return_value_policy::reference : return_value_policy::copy;
    <font color='#0000FF'>return</font> reinterpret_steal<font color='#5555FF'>&lt;</font>object<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>detail::make_caster<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::<font color='#BB00BB'>cast</font><font face='Lucida Console'>(</font>value, policy, parent<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font> T handle::<font color='#BB00BB'>cast</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b> <font color='#0000FF'>return</font> pybind11::cast<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font color='#0000FF'>this</font><font face='Lucida Console'>)</font>; <b>}</b>
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&gt;</font> <font color='#0000FF'>inline</font> <font color='#0000FF'><u>void</u></font> handle::<font color='#BB00BB'>cast</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b> <font color='#0000FF'>return</font>; <b>}</b>

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font>
detail::enable_if_t<font color='#5555FF'>&lt;</font><font color='#5555FF'>!</font>detail::move_never<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::value, T<font color='#5555FF'>&gt;</font> <font color='#BB00BB'>move</font><font face='Lucida Console'>(</font>object <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>obj<font face='Lucida Console'>)</font> <b>{</b>
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>obj.<font color='#BB00BB'>ref_count</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>
<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>NDEBUG<font face='Lucida Console'>)</font>
        <font color='#0000FF'>throw</font> <font color='#BB00BB'>cast_error</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>Unable to cast Python instance to C++ rvalue: instance has multiple references</font>"
            "<font color='#CC0000'> (compile in debug mode for details)</font>"<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#else</font>
        <font color='#0000FF'>throw</font> <font color='#BB00BB'>cast_error</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>Unable to move from Python </font>" <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>std::string<font face='Lucida Console'>)</font> <font color='#BB00BB'>str</font><font face='Lucida Console'>(</font>obj.<font color='#BB00BB'>get_type</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>+</font>
                "<font color='#CC0000'> instance to C++ </font>" <font color='#5555FF'>+</font> type_id<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> "<font color='#CC0000'> instance: instance has multiple references</font>"<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

    <font color='#009900'>// Move into a temporary and return that, because the reference may be a local value of `conv`
</font>    T ret <font color='#5555FF'>=</font> std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font>detail::load_type<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>obj<font face='Lucida Console'>)</font>.<font color='#0000FF'>operator</font> T<font color='#5555FF'>&amp;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
    <font color='#0000FF'>return</font> ret;
<b>}</b>

<font color='#009900'>// Calling cast() on an rvalue calls pybind::cast with the object rvalue, which does:
</font><font color='#009900'>// - If we have to move (because T has no copy constructor), do it.  This will fail if the moved
</font><font color='#009900'>//   object has multiple references, but trying to copy will fail to compile.
</font><font color='#009900'>// - If both movable and copyable, check ref count: if 1, move; otherwise copy
</font><font color='#009900'>// - Otherwise (not movable), copy.
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font> detail::enable_if_t<font color='#5555FF'>&lt;</font>detail::move_always<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::value, T<font color='#5555FF'>&gt;</font> <font color='#BB00BB'>cast</font><font face='Lucida Console'>(</font>object <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>object<font face='Lucida Console'>)</font> <b>{</b>
    <font color='#0000FF'>return</font> move<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font>object<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
<b>}</b>
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font> detail::enable_if_t<font color='#5555FF'>&lt;</font>detail::move_if_unreferenced<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::value, T<font color='#5555FF'>&gt;</font> <font color='#BB00BB'>cast</font><font face='Lucida Console'>(</font>object <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>object<font face='Lucida Console'>)</font> <b>{</b>
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>object.<font color='#BB00BB'>ref_count</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>
        <font color='#0000FF'>return</font> cast<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>object<font face='Lucida Console'>)</font>;
    <font color='#0000FF'>else</font>
        <font color='#0000FF'>return</font> move<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font>object<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
<b>}</b>
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font> detail::enable_if_t<font color='#5555FF'>&lt;</font>detail::move_never<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::value, T<font color='#5555FF'>&gt;</font> <font color='#BB00BB'>cast</font><font face='Lucida Console'>(</font>object <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>object<font face='Lucida Console'>)</font> <b>{</b>
    <font color='#0000FF'>return</font> cast<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>object<font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font> T object::<font color='#BB00BB'>cast</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <font color='#5555FF'>&amp;</font> <b>{</b> <font color='#0000FF'>return</font> pybind11::cast<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font color='#0000FF'>this</font><font face='Lucida Console'>)</font>; <b>}</b>
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font> T object::<font color='#BB00BB'>cast</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <b>{</b> <font color='#0000FF'>return</font> pybind11::cast<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font color='#0000FF'>this</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>; <b>}</b>
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&gt;</font> <font color='#0000FF'>inline</font> <font color='#0000FF'><u>void</u></font> object::<font color='#BB00BB'>cast</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <font color='#5555FF'>&amp;</font> <b>{</b> <font color='#0000FF'>return</font>; <b>}</b>
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&gt;</font> <font color='#0000FF'>inline</font> <font color='#0000FF'><u>void</u></font> object::<font color='#BB00BB'>cast</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <b>{</b> <font color='#0000FF'>return</font>; <b>}</b>

<font color='#BB00BB'>NAMESPACE_BEGIN</font><font face='Lucida Console'>(</font>detail<font face='Lucida Console'>)</font>

<font color='#009900'>// Declared in pytypes.h:
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T, enable_if_t<font color='#5555FF'>&lt;</font><font color='#5555FF'>!</font>is_pyobject<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::value, <font color='#0000FF'><u>int</u></font><font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
object <font color='#BB00BB'>object_or_cast</font><font face='Lucida Console'>(</font>T <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>o<font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> pybind11::<font color='#BB00BB'>cast</font><font face='Lucida Console'>(</font>std::forward<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>o<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>; <b>}</b>

<font color='#0000FF'>struct</font> <b><a name='overload_unused'></a>overload_unused</b> <b>{</b><b>}</b>; <font color='#009900'>// Placeholder type for the unneeded (and dead code) static variable in the OVERLOAD_INT macro
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> ret_type<font color='#5555FF'>&gt;</font> <font color='#0000FF'>using</font> overload_caster_t <font color='#5555FF'>=</font> conditional_t<font color='#5555FF'>&lt;</font>
    cast_is_temporary_value_reference<font color='#5555FF'>&lt;</font>ret_type<font color='#5555FF'>&gt;</font>::value, make_caster<font color='#5555FF'>&lt;</font>ret_type<font color='#5555FF'>&gt;</font>, overload_unused<font color='#5555FF'>&gt;</font>;

<font color='#009900'>// Trampoline use: for reference/pointer types to value-converted values, we do a value cast, then
</font><font color='#009900'>// store the result in the given variable.  For other types, this is a no-op.
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font> enable_if_t<font color='#5555FF'>&lt;</font>cast_is_temporary_value_reference<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::value, T<font color='#5555FF'>&gt;</font> <font color='#BB00BB'>cast_ref</font><font face='Lucida Console'>(</font>object <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>o, make_caster<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font> <font color='#5555FF'>&amp;</font>caster<font face='Lucida Console'>)</font> <b>{</b>
    <font color='#0000FF'>return</font> cast_op<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font color='#BB00BB'>load_type</font><font face='Lucida Console'>(</font>caster, o<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
<b>}</b>
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font> enable_if_t<font color='#5555FF'>&lt;</font><font color='#5555FF'>!</font>cast_is_temporary_value_reference<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::value, T<font color='#5555FF'>&gt;</font> <font color='#BB00BB'>cast_ref</font><font face='Lucida Console'>(</font>object <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>, overload_unused <font color='#5555FF'>&amp;</font><font face='Lucida Console'>)</font> <b>{</b>
    <font color='#BB00BB'>pybind11_fail</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>Internal error: cast_ref fallback invoked</font>"<font face='Lucida Console'>)</font>; <b>}</b>

<font color='#009900'>// Trampoline use: Having a pybind11::cast with an invalid reference type is going to static_assert, even
</font><font color='#009900'>// though if it's in dead code, so we provide a "trampoline" to pybind11::cast that only does anything in
</font><font color='#009900'>// cases where pybind11::cast is valid.
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font> enable_if_t<font color='#5555FF'>&lt;</font><font color='#5555FF'>!</font>cast_is_temporary_value_reference<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::value, T<font color='#5555FF'>&gt;</font> <font color='#BB00BB'>cast_safe</font><font face='Lucida Console'>(</font>object <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>o<font face='Lucida Console'>)</font> <b>{</b>
    <font color='#0000FF'>return</font> pybind11::cast<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font>o<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>; <b>}</b>
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font> enable_if_t<font color='#5555FF'>&lt;</font>cast_is_temporary_value_reference<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::value, T<font color='#5555FF'>&gt;</font> <font color='#BB00BB'>cast_safe</font><font face='Lucida Console'>(</font>object <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font><font face='Lucida Console'>)</font> <b>{</b>
    <font color='#BB00BB'>pybind11_fail</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>Internal error: cast_safe fallback invoked</font>"<font face='Lucida Console'>)</font>; <b>}</b>
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&gt;</font> <font color='#0000FF'>inline</font> <font color='#0000FF'><u>void</u></font> cast_safe<font color='#5555FF'>&lt;</font><font color='#0000FF'><u>void</u></font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>object <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font><font face='Lucida Console'>)</font> <b>{</b><b>}</b>

<font color='#BB00BB'>NAMESPACE_END</font><font face='Lucida Console'>(</font>detail<font face='Lucida Console'>)</font>

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font>return_value_policy policy <font color='#5555FF'>=</font> return_value_policy::automatic_reference<font color='#5555FF'>&gt;</font>
tuple <font color='#BB00BB'>make_tuple</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> <font color='#BB00BB'>tuple</font><font face='Lucida Console'>(</font><font color='#979000'>0</font><font face='Lucida Console'>)</font>; <b>}</b>

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font>return_value_policy policy <font color='#5555FF'>=</font> return_value_policy::automatic_reference,
          <font color='#0000FF'>typename</font>... Args<font color='#5555FF'>&gt;</font> tuple <font color='#BB00BB'>make_tuple</font><font face='Lucida Console'>(</font>Args<font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>... args_<font face='Lucida Console'>)</font> <b>{</b>
    constexpr <font color='#0000FF'><u>size_t</u></font> size <font color='#5555FF'>=</font> <font color='#0000FF'>sizeof</font>...<font face='Lucida Console'>(</font>Args<font face='Lucida Console'>)</font>;
    std::array<font color='#5555FF'>&lt;</font>object, size<font color='#5555FF'>&gt;</font> args <b>{</b>
        <b>{</b> reinterpret_steal<font color='#5555FF'>&lt;</font>object<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>detail::make_caster<font color='#5555FF'>&lt;</font>Args<font color='#5555FF'>&gt;</font>::<font color='#BB00BB'>cast</font><font face='Lucida Console'>(</font>
            std::forward<font color='#5555FF'>&lt;</font>Args<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>args_<font face='Lucida Console'>)</font>, policy, nullptr<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>... <b>}</b>
    <b>}</b>;
    <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>size_t</u></font> i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> args.<font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>args[i]<font face='Lucida Console'>)</font> <b>{</b>
<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>NDEBUG<font face='Lucida Console'>)</font>
            <font color='#0000FF'>throw</font> <font color='#BB00BB'>cast_error</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>make_tuple(): unable to convert arguments to Python object (compile in debug mode for details)</font>"<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#else</font>
            std::array<font color='#5555FF'>&lt;</font>std::string, size<font color='#5555FF'>&gt;</font> argtypes <b>{</b> <b>{</b>type_id<font color='#5555FF'>&lt;</font>Args<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>...<b>}</b> <b>}</b>;
            <font color='#0000FF'>throw</font> <font color='#BB00BB'>cast_error</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>make_tuple(): unable to convert argument of type '</font>" <font color='#5555FF'>+</font>
                argtypes[i] <font color='#5555FF'>+</font> "<font color='#CC0000'>' to Python object</font>"<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>
        <b>}</b>
    <b>}</b>
    tuple <font color='#BB00BB'>result</font><font face='Lucida Console'>(</font>size<font face='Lucida Console'>)</font>;
    <font color='#0000FF'><u>int</u></font> counter <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
    <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font><font color='#0000FF'>auto</font> <font color='#5555FF'>&amp;</font>arg_value : args<font face='Lucida Console'>)</font>
        <font color='#BB00BB'>PyTuple_SET_ITEM</font><font face='Lucida Console'>(</font>result.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, counter<font color='#5555FF'>+</font><font color='#5555FF'>+</font>, arg_value.<font color='#BB00BB'>release</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
    <font color='#0000FF'>return</font> result;
<b>}</b>

<font color='#009900'>/// \ingroup annotations
</font><font color='#009900'>/// Annotation for arguments
</font><font color='#0000FF'>struct</font> <b><a name='arg'></a>arg</b> <b>{</b>
    <font color='#009900'>/// Constructs an argument with the name of the argument; if null or omitted, this is a positional argument.
</font>    constexpr <font color='#0000FF'>explicit</font> <font color='#BB00BB'>arg</font><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> <font color='#0000FF'><u>char</u></font> <font color='#5555FF'>*</font>name <font color='#5555FF'>=</font> nullptr<font face='Lucida Console'>)</font> : name<font face='Lucida Console'>(</font>name<font face='Lucida Console'>)</font>, flag_noconvert<font face='Lucida Console'>(</font><font color='#979000'>false</font><font face='Lucida Console'>)</font>, flag_none<font face='Lucida Console'>(</font><font color='#979000'>true</font><font face='Lucida Console'>)</font> <b>{</b> <b>}</b>
    <font color='#009900'>/// Assign a value to this argument
</font>    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font> arg_v <b><a name='operator'></a>operator</b><font color='#5555FF'>=</font><font face='Lucida Console'>(</font>T <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>value<font face='Lucida Console'>)</font> <font color='#0000FF'>const</font>;
    <font color='#009900'>/// Indicate that the type should not be converted in the type caster
</font>    arg <font color='#5555FF'>&amp;</font><font color='#BB00BB'>noconvert</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>bool</u></font> flag <font color='#5555FF'>=</font> <font color='#979000'>true</font><font face='Lucida Console'>)</font> <b>{</b> flag_noconvert <font color='#5555FF'>=</font> flag; <font color='#0000FF'>return</font> <font color='#5555FF'>*</font><font color='#0000FF'>this</font>; <b>}</b>
    <font color='#009900'>/// Indicates that the argument should/shouldn't allow None (e.g. for nullable pointer args)
</font>    arg <font color='#5555FF'>&amp;</font><font color='#BB00BB'>none</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>bool</u></font> flag <font color='#5555FF'>=</font> <font color='#979000'>true</font><font face='Lucida Console'>)</font> <b>{</b> flag_none <font color='#5555FF'>=</font> flag; <font color='#0000FF'>return</font> <font color='#5555FF'>*</font><font color='#0000FF'>this</font>; <b>}</b>

    <font color='#0000FF'>const</font> <font color='#0000FF'><u>char</u></font> <font color='#5555FF'>*</font>name; <font color='#009900'>///&lt; If non-null, this is a named kwargs argument
</font>    <font color='#0000FF'><u>bool</u></font> flag_noconvert : <font color='#979000'>1</font>; <font color='#009900'>///&lt; If set, do not allow conversion (requires a supporting type caster!)
</font>    <font color='#0000FF'><u>bool</u></font> flag_none : <font color='#979000'>1</font>; <font color='#009900'>///&lt; If set (the default), allow None to be passed to this argument
</font><b>}</b>;

<font color='#009900'>/// \ingroup annotations
</font><font color='#009900'>/// Annotation for arguments with values
</font><font color='#0000FF'>struct</font> <b><a name='arg_v'></a>arg_v</b> : arg <b>{</b>
<font color='#0000FF'>private</font>:
    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font>
    <font color='#BB00BB'>arg_v</font><font face='Lucida Console'>(</font>arg <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>base, T <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>x, <font color='#0000FF'>const</font> <font color='#0000FF'><u>char</u></font> <font color='#5555FF'>*</font>descr <font color='#5555FF'>=</font> nullptr<font face='Lucida Console'>)</font>
        : arg<font face='Lucida Console'>(</font>base<font face='Lucida Console'>)</font>,
          value<font face='Lucida Console'>(</font>reinterpret_steal<font color='#5555FF'>&lt;</font>object<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>
              detail::make_caster<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::cast<font face='Lucida Console'>(</font>x, return_value_policy::automatic, <b>{</b><b>}</b><font face='Lucida Console'>)</font>
          <font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>,
          <font color='#BB00BB'>descr</font><font face='Lucida Console'>(</font>descr<font face='Lucida Console'>)</font>
<font color='#0000FF'>#if</font> <font color='#5555FF'>!</font>defined<font face='Lucida Console'>(</font>NDEBUG<font face='Lucida Console'>)</font>
        , <font color='#BB00BB'>type</font><font face='Lucida Console'>(</font>type_id<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
<font color='#0000FF'>#endif</font>
    <b>{</b> <b>}</b>

<font color='#0000FF'>public</font>:
    <font color='#009900'>/// Direct construction with name, default, and description
</font>    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font>
    <font color='#BB00BB'>arg_v</font><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> <font color='#0000FF'><u>char</u></font> <font color='#5555FF'>*</font>name, T <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>x, <font color='#0000FF'>const</font> <font color='#0000FF'><u>char</u></font> <font color='#5555FF'>*</font>descr <font color='#5555FF'>=</font> nullptr<font face='Lucida Console'>)</font>
        : arg_v<font face='Lucida Console'>(</font>arg<font face='Lucida Console'>(</font>name<font face='Lucida Console'>)</font>, std::forward<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>x<font face='Lucida Console'>)</font>, descr<font face='Lucida Console'>)</font> <b>{</b> <b>}</b>

    <font color='#009900'>/// Called internally when invoking `py::arg("a") = value`
</font>    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font>
    <font color='#BB00BB'>arg_v</font><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> arg <font color='#5555FF'>&amp;</font>base, T <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>x, <font color='#0000FF'>const</font> <font color='#0000FF'><u>char</u></font> <font color='#5555FF'>*</font>descr <font color='#5555FF'>=</font> nullptr<font face='Lucida Console'>)</font>
        : arg_v<font face='Lucida Console'>(</font>arg<font face='Lucida Console'>(</font>base<font face='Lucida Console'>)</font>, std::forward<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>x<font face='Lucida Console'>)</font>, descr<font face='Lucida Console'>)</font> <b>{</b> <b>}</b>

    <font color='#009900'>/// Same as `arg::noconvert()`, but returns *this as arg_v&amp;, not arg&amp;
</font>    arg_v <font color='#5555FF'>&amp;</font><font color='#BB00BB'>noconvert</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>bool</u></font> flag <font color='#5555FF'>=</font> <font color='#979000'>true</font><font face='Lucida Console'>)</font> <b>{</b> arg::<font color='#BB00BB'>noconvert</font><font face='Lucida Console'>(</font>flag<font face='Lucida Console'>)</font>; <font color='#0000FF'>return</font> <font color='#5555FF'>*</font><font color='#0000FF'>this</font>; <b>}</b>

    <font color='#009900'>/// Same as `arg::nonone()`, but returns *this as arg_v&amp;, not arg&amp;
</font>    arg_v <font color='#5555FF'>&amp;</font><font color='#BB00BB'>none</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>bool</u></font> flag <font color='#5555FF'>=</font> <font color='#979000'>true</font><font face='Lucida Console'>)</font> <b>{</b> arg::<font color='#BB00BB'>none</font><font face='Lucida Console'>(</font>flag<font face='Lucida Console'>)</font>; <font color='#0000FF'>return</font> <font color='#5555FF'>*</font><font color='#0000FF'>this</font>; <b>}</b>

    <font color='#009900'>/// The default value
</font>    object value;
    <font color='#009900'>/// The (optional) description of the default value
</font>    <font color='#0000FF'>const</font> <font color='#0000FF'><u>char</u></font> <font color='#5555FF'>*</font>descr;
<font color='#0000FF'>#if</font> <font color='#5555FF'>!</font>defined<font face='Lucida Console'>(</font>NDEBUG<font face='Lucida Console'>)</font>
    <font color='#009900'>/// The C++ type name of the default value (only available when compiled in debug mode)
</font>    std::string type;
<font color='#0000FF'>#endif</font>
<b>}</b>;

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font>
arg_v arg::<b><a name='operator'></a>operator</b><font color='#5555FF'>=</font><font face='Lucida Console'>(</font>T <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>value<font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b> <font color='#0000FF'>return</font> <b>{</b>std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font color='#0000FF'>this</font><font face='Lucida Console'>)</font>, std::forward<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>value<font face='Lucida Console'>)</font><b>}</b>; <b>}</b>

<font color='#009900'>/// Alias for backward compatibility -- to be removed in version 2.0
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> <font color='#009900'>/*unused*/</font><font color='#5555FF'>&gt;</font> <font color='#0000FF'>using</font> arg_t <font color='#5555FF'>=</font> arg_v;

<font color='#0000FF'>inline</font> <font color='#0000FF'>namespace</font> literals <b>{</b>
<font color='#009900'>/** \rst
    String literal version of `arg`
 \endrst */</font>
constexpr arg <b><a name='operator'></a>operator</b>"<font color='#CC0000'></font>" <font color='#BB00BB'>_a</font><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> <font color='#0000FF'><u>char</u></font> <font color='#5555FF'>*</font>name, <font color='#0000FF'><u>size_t</u></font><font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> <font color='#BB00BB'>arg</font><font face='Lucida Console'>(</font>name<font face='Lucida Console'>)</font>; <b>}</b>
<b>}</b>

<font color='#BB00BB'>NAMESPACE_BEGIN</font><font face='Lucida Console'>(</font>detail<font face='Lucida Console'>)</font>

<font color='#009900'>// forward declaration (definition in attr.h)
</font><font color='#0000FF'>struct</font> function_record;

<font color='#009900'>/// Internal data associated with a single function call
</font><font color='#0000FF'>struct</font> <b><a name='function_call'></a>function_call</b> <b>{</b>
    <font color='#BB00BB'>function_call</font><font face='Lucida Console'>(</font>function_record <font color='#5555FF'>&amp;</font>f, handle p<font face='Lucida Console'>)</font>; <font color='#009900'>// Implementation in attr.h
</font>
    <font color='#009900'>/// The function data:
</font>    <font color='#0000FF'>const</font> function_record <font color='#5555FF'>&amp;</font>func;

    <font color='#009900'>/// Arguments passed to the function:
</font>    std::vector<font color='#5555FF'>&lt;</font>handle<font color='#5555FF'>&gt;</font> args;

    <font color='#009900'>/// The `convert` value the arguments should be loaded with
</font>    std::vector<font color='#5555FF'>&lt;</font><font color='#0000FF'><u>bool</u></font><font color='#5555FF'>&gt;</font> args_convert;

    <font color='#009900'>/// Extra references for the optional `py::args` and/or `py::kwargs` arguments (which, if
</font>    <font color='#009900'>/// present, are also in `args` but without a reference).
</font>    object args_ref, kwargs_ref;

    <font color='#009900'>/// The parent, if any
</font>    handle parent;

    <font color='#009900'>/// If this is a call to an initializer, this argument contains `self`
</font>    handle init_self;
<b>}</b>;


<font color='#009900'>/// Helper class which loads arguments for C++ functions called from Python
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font>... Args<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>class</font> <b><a name='argument_loader'></a>argument_loader</b> <b>{</b>
    <font color='#0000FF'>using</font> indices <font color='#5555FF'>=</font> make_index_sequence<font color='#5555FF'>&lt;</font><font color='#0000FF'>sizeof</font>...<font face='Lucida Console'>(</font>Args<font face='Lucida Console'>)</font><font color='#5555FF'>&gt;</font>;

    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> Arg<font color='#5555FF'>&gt;</font> <font color='#0000FF'>using</font> argument_is_args   <font color='#5555FF'>=</font> std::is_same<font color='#5555FF'>&lt;</font>intrinsic_t<font color='#5555FF'>&lt;</font>Arg<font color='#5555FF'>&gt;</font>, args<font color='#5555FF'>&gt;</font>;
    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> Arg<font color='#5555FF'>&gt;</font> <font color='#0000FF'>using</font> argument_is_kwargs <font color='#5555FF'>=</font> std::is_same<font color='#5555FF'>&lt;</font>intrinsic_t<font color='#5555FF'>&lt;</font>Arg<font color='#5555FF'>&gt;</font>, kwargs<font color='#5555FF'>&gt;</font>;
    <font color='#009900'>// Get args/kwargs argument positions relative to the end of the argument list:
</font>    <font color='#0000FF'>static</font> constexpr <font color='#0000FF'>auto</font> args_pos <font color='#5555FF'>=</font> constexpr_first<font color='#5555FF'>&lt;</font>argument_is_args, Args...<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>-</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font> <font color='#0000FF'>sizeof</font>...<font face='Lucida Console'>(</font>Args<font face='Lucida Console'>)</font>,
                        kwargs_pos <font color='#5555FF'>=</font> constexpr_first<font color='#5555FF'>&lt;</font>argument_is_kwargs, Args...<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>-</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font> <font color='#0000FF'>sizeof</font>...<font face='Lucida Console'>(</font>Args<font face='Lucida Console'>)</font>;

    <font color='#0000FF'>static</font> constexpr <font color='#0000FF'><u>bool</u></font> args_kwargs_are_last <font color='#5555FF'>=</font> kwargs_pos <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#5555FF'>-</font> <font color='#979000'>1</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> args_pos <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> kwargs_pos <font color='#5555FF'>-</font> <font color='#979000'>1</font>;

    <font color='#BB00BB'>static_assert</font><font face='Lucida Console'>(</font>args_kwargs_are_last, "<font color='#CC0000'>py::args/py::kwargs are only permitted as the last argument(s) of a function</font>"<font face='Lucida Console'>)</font>;

<font color='#0000FF'>public</font>:
    <font color='#0000FF'>static</font> constexpr <font color='#0000FF'><u>bool</u></font> has_kwargs <font color='#5555FF'>=</font> kwargs_pos <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font>;
    <font color='#0000FF'>static</font> constexpr <font color='#0000FF'><u>bool</u></font> has_args <font color='#5555FF'>=</font> args_pos <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font>;

    <font color='#0000FF'>static</font> PYBIND11_DESCR <font color='#BB00BB'>arg_names</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> detail::<font color='#BB00BB'>concat</font><font face='Lucida Console'>(</font>make_caster<font color='#5555FF'>&lt;</font>Args<font color='#5555FF'>&gt;</font>::<font color='#BB00BB'>name</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>...<font face='Lucida Console'>)</font>; <b>}</b>

    <font color='#0000FF'><u>bool</u></font> <font color='#BB00BB'>load_args</font><font face='Lucida Console'>(</font>function_call <font color='#5555FF'>&amp;</font>call<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>return</font> <font color='#BB00BB'>load_impl_sequence</font><font face='Lucida Console'>(</font>call, indices<b>{</b><b>}</b><font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> Return, <font color='#0000FF'>typename</font> Guard, <font color='#0000FF'>typename</font> Func<font color='#5555FF'>&gt;</font>
    enable_if_t<font color='#5555FF'>&lt;</font><font color='#5555FF'>!</font>std::is_void<font color='#5555FF'>&lt;</font>Return<font color='#5555FF'>&gt;</font>::value, Return<font color='#5555FF'>&gt;</font> <font color='#BB00BB'>call</font><font face='Lucida Console'>(</font>Func <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>f<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <b>{</b>
        <font color='#0000FF'>return</font> std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font color='#0000FF'>this</font><font face='Lucida Console'>)</font>.<font color='#0000FF'>template</font> call_impl<font color='#5555FF'>&lt;</font>Return<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>std::forward<font color='#5555FF'>&lt;</font>Func<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>f<font face='Lucida Console'>)</font>, indices<b>{</b><b>}</b>, Guard<b>{</b><b>}</b><font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> Return, <font color='#0000FF'>typename</font> Guard, <font color='#0000FF'>typename</font> Func<font color='#5555FF'>&gt;</font>
    enable_if_t<font color='#5555FF'>&lt;</font>std::is_void<font color='#5555FF'>&lt;</font>Return<font color='#5555FF'>&gt;</font>::value, void_type<font color='#5555FF'>&gt;</font> <font color='#BB00BB'>call</font><font face='Lucida Console'>(</font>Func <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>f<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <b>{</b>
        std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font color='#0000FF'>this</font><font face='Lucida Console'>)</font>.<font color='#0000FF'>template</font> call_impl<font color='#5555FF'>&lt;</font>Return<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>std::forward<font color='#5555FF'>&lt;</font>Func<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>f<font face='Lucida Console'>)</font>, indices<b>{</b><b>}</b>, Guard<b>{</b><b>}</b><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>return</font> <font color='#BB00BB'>void_type</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
    <b>}</b>

<font color='#0000FF'>private</font>:

    <font color='#0000FF'>static</font> <font color='#0000FF'><u>bool</u></font> <font color='#BB00BB'>load_impl_sequence</font><font face='Lucida Console'>(</font>function_call <font color='#5555FF'>&amp;</font>, index_sequence<font color='#5555FF'>&lt;</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> <font color='#979000'>true</font>; <b>}</b>

    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'><u>size_t</u></font>... Is<font color='#5555FF'>&gt;</font>
    <font color='#0000FF'><u>bool</u></font> <font color='#BB00BB'>load_impl_sequence</font><font face='Lucida Console'>(</font>function_call <font color='#5555FF'>&amp;</font>call, index_sequence<font color='#5555FF'>&lt;</font>Is...<font color='#5555FF'>&gt;</font><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>bool</u></font> r : <b>{</b>std::get<font color='#5555FF'>&lt;</font>Is<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>argcasters<font face='Lucida Console'>)</font>.<font color='#BB00BB'>load</font><font face='Lucida Console'>(</font>call.args[Is], call.args_convert[Is]<font face='Lucida Console'>)</font>...<b>}</b><font face='Lucida Console'>)</font>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>r<font face='Lucida Console'>)</font>
                <font color='#0000FF'>return</font> <font color='#979000'>false</font>;
        <font color='#0000FF'>return</font> <font color='#979000'>true</font>;
    <b>}</b>

    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> Return, <font color='#0000FF'>typename</font> Func, <font color='#0000FF'><u>size_t</u></font>... Is, <font color='#0000FF'>typename</font> Guard<font color='#5555FF'>&gt;</font>
    Return <font color='#BB00BB'>call_impl</font><font face='Lucida Console'>(</font>Func <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>f, index_sequence<font color='#5555FF'>&lt;</font>Is...<font color='#5555FF'>&gt;</font>, Guard <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>return</font> std::forward<font color='#5555FF'>&lt;</font>Func<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>f<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>cast_op<font color='#5555FF'>&lt;</font>Args<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font>std::get<font color='#5555FF'>&lt;</font>Is<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>argcasters<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>...<font face='Lucida Console'>)</font>;
    <b>}</b>

    std::tuple<font color='#5555FF'>&lt;</font>make_caster<font color='#5555FF'>&lt;</font>Args<font color='#5555FF'>&gt;</font>...<font color='#5555FF'>&gt;</font> argcasters;
<b>}</b>;

<font color='#009900'>/// Helper class which collects only positional arguments for a Python function call.
</font><font color='#009900'>/// A fancier version below can collect any argument, but this one is optimal for simple calls.
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font>return_value_policy policy<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>class</font> <b><a name='simple_collector'></a>simple_collector</b> <b>{</b>
<font color='#0000FF'>public</font>:
    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font>... Ts<font color='#5555FF'>&gt;</font>
    <font color='#0000FF'>explicit</font> <font color='#BB00BB'>simple_collector</font><font face='Lucida Console'>(</font>Ts <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>...values<font face='Lucida Console'>)</font>
        : m_args<font face='Lucida Console'>(</font>pybind11::make_tuple<font color='#5555FF'>&lt;</font>policy<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>std::forward<font color='#5555FF'>&lt;</font>Ts<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>values<font face='Lucida Console'>)</font>...<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b> <b>}</b>

    <font color='#0000FF'>const</font> tuple <font color='#5555FF'>&amp;</font><font color='#BB00BB'>args</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <font color='#5555FF'>&amp;</font> <b>{</b> <font color='#0000FF'>return</font> m_args; <b>}</b>
    dict <font color='#BB00BB'>kwargs</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b> <font color='#0000FF'>return</font> <b>{</b><b>}</b>; <b>}</b>

    tuple <font color='#BB00BB'>args</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <b>{</b> <font color='#0000FF'>return</font> std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font>m_args<font face='Lucida Console'>)</font>; <b>}</b>

    <font color='#009900'>/// Call a Python function and pass the collected arguments
</font>    object <font color='#BB00BB'>call</font><font face='Lucida Console'>(</font>PyObject <font color='#5555FF'>*</font>ptr<font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b>
        PyObject <font color='#5555FF'>*</font>result <font color='#5555FF'>=</font> <font color='#BB00BB'>PyObject_CallObject</font><font face='Lucida Console'>(</font>ptr, m_args.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>result<font face='Lucida Console'>)</font>
            <font color='#0000FF'>throw</font> <font color='#BB00BB'>error_already_set</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>return</font> reinterpret_steal<font color='#5555FF'>&lt;</font>object<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>result<font face='Lucida Console'>)</font>;
    <b>}</b>

<font color='#0000FF'>private</font>:
    tuple m_args;
<b>}</b>;

<font color='#009900'>/// Helper class which collects positional, keyword, * and ** arguments for a Python function call
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font>return_value_policy policy<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>class</font> <b><a name='unpacking_collector'></a>unpacking_collector</b> <b>{</b>
<font color='#0000FF'>public</font>:
    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font>... Ts<font color='#5555FF'>&gt;</font>
    <font color='#0000FF'>explicit</font> <font color='#BB00BB'>unpacking_collector</font><font face='Lucida Console'>(</font>Ts <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>...values<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#009900'>// Tuples aren't (easily) resizable so a list is needed for collection,
</font>        <font color='#009900'>// but the actual function call strictly requires a tuple.
</font>        <font color='#0000FF'>auto</font> args_list <font color='#5555FF'>=</font> <font color='#BB00BB'>list</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'><u>int</u></font> _[] <font color='#5555FF'>=</font> <b>{</b> <font color='#979000'>0</font>, <font face='Lucida Console'>(</font><font color='#BB00BB'>process</font><font face='Lucida Console'>(</font>args_list, std::forward<font color='#5555FF'>&lt;</font>Ts<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>values<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>, <font color='#979000'>0</font><font face='Lucida Console'>)</font>... <b>}</b>;
        <font color='#BB00BB'>ignore_unused</font><font face='Lucida Console'>(</font>_<font face='Lucida Console'>)</font>;

        m_args <font color='#5555FF'>=</font> std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font>args_list<font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#0000FF'>const</font> tuple <font color='#5555FF'>&amp;</font><font color='#BB00BB'>args</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <font color='#5555FF'>&amp;</font> <b>{</b> <font color='#0000FF'>return</font> m_args; <b>}</b>
    <font color='#0000FF'>const</font> dict <font color='#5555FF'>&amp;</font><font color='#BB00BB'>kwargs</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <font color='#5555FF'>&amp;</font> <b>{</b> <font color='#0000FF'>return</font> m_kwargs; <b>}</b>

    tuple <font color='#BB00BB'>args</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <b>{</b> <font color='#0000FF'>return</font> std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font>m_args<font face='Lucida Console'>)</font>; <b>}</b>
    dict <font color='#BB00BB'>kwargs</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <b>{</b> <font color='#0000FF'>return</font> std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font>m_kwargs<font face='Lucida Console'>)</font>; <b>}</b>

    <font color='#009900'>/// Call a Python function and pass the collected arguments
</font>    object <font color='#BB00BB'>call</font><font face='Lucida Console'>(</font>PyObject <font color='#5555FF'>*</font>ptr<font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b>
        PyObject <font color='#5555FF'>*</font>result <font color='#5555FF'>=</font> <font color='#BB00BB'>PyObject_Call</font><font face='Lucida Console'>(</font>ptr, m_args.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, m_kwargs.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>result<font face='Lucida Console'>)</font>
            <font color='#0000FF'>throw</font> <font color='#BB00BB'>error_already_set</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>return</font> reinterpret_steal<font color='#5555FF'>&lt;</font>object<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>result<font face='Lucida Console'>)</font>;
    <b>}</b>

<font color='#0000FF'>private</font>:
    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font>
    <font color='#0000FF'><u>void</u></font> <font color='#BB00BB'>process</font><font face='Lucida Console'>(</font>list <font color='#5555FF'>&amp;</font>args_list, T <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>x<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>auto</font> o <font color='#5555FF'>=</font> reinterpret_steal<font color='#5555FF'>&lt;</font>object<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>detail::make_caster<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::<font color='#BB00BB'>cast</font><font face='Lucida Console'>(</font>std::forward<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>x<font face='Lucida Console'>)</font>, policy, <b>{</b><b>}</b><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>o<font face='Lucida Console'>)</font> <b>{</b>
<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>NDEBUG<font face='Lucida Console'>)</font>
            <font color='#BB00BB'>argument_cast_error</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
<font color='#0000FF'>#else</font>
            <font color='#BB00BB'>argument_cast_error</font><font face='Lucida Console'>(</font>std::<font color='#BB00BB'>to_string</font><font face='Lucida Console'>(</font>args_list.<font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>, type_id<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>
        <b>}</b>
        args_list.<font color='#BB00BB'>append</font><font face='Lucida Console'>(</font>o<font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#0000FF'><u>void</u></font> <font color='#BB00BB'>process</font><font face='Lucida Console'>(</font>list <font color='#5555FF'>&amp;</font>args_list, detail::args_proxy ap<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font><font color='#0000FF'>const</font> <font color='#0000FF'>auto</font> <font color='#5555FF'>&amp;</font>a : ap<font face='Lucida Console'>)</font>
            args_list.<font color='#BB00BB'>append</font><font face='Lucida Console'>(</font>a<font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#0000FF'><u>void</u></font> <font color='#BB00BB'>process</font><font face='Lucida Console'>(</font>list <font color='#5555FF'>&amp;</font><font color='#009900'>/*args_list*/</font>, arg_v a<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>a.name<font face='Lucida Console'>)</font>
<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>NDEBUG<font face='Lucida Console'>)</font>
            <font color='#BB00BB'>nameless_argument_error</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
<font color='#0000FF'>#else</font>
            <font color='#BB00BB'>nameless_argument_error</font><font face='Lucida Console'>(</font>a.type<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>m_kwargs.<font color='#BB00BB'>contains</font><font face='Lucida Console'>(</font>a.name<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>NDEBUG<font face='Lucida Console'>)</font>
            <font color='#BB00BB'>multiple_values_error</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
<font color='#0000FF'>#else</font>
            <font color='#BB00BB'>multiple_values_error</font><font face='Lucida Console'>(</font>a.name<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>
        <b>}</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>a.value<font face='Lucida Console'>)</font> <b>{</b>
<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>NDEBUG<font face='Lucida Console'>)</font>
            <font color='#BB00BB'>argument_cast_error</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
<font color='#0000FF'>#else</font>
            <font color='#BB00BB'>argument_cast_error</font><font face='Lucida Console'>(</font>a.name, a.type<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>
        <b>}</b>
        m_kwargs[a.name] <font color='#5555FF'>=</font> a.value;
    <b>}</b>

    <font color='#0000FF'><u>void</u></font> <font color='#BB00BB'>process</font><font face='Lucida Console'>(</font>list <font color='#5555FF'>&amp;</font><font color='#009900'>/*args_list*/</font>, detail::kwargs_proxy kp<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>kp<font face='Lucida Console'>)</font>
            <font color='#0000FF'>return</font>;
        <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font><font color='#0000FF'>const</font> <font color='#0000FF'>auto</font> <font color='#5555FF'>&amp;</font>k : reinterpret_borrow<font color='#5555FF'>&lt;</font>dict<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>kp<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>m_kwargs.<font color='#BB00BB'>contains</font><font face='Lucida Console'>(</font>k.first<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>NDEBUG<font face='Lucida Console'>)</font>
                <font color='#BB00BB'>multiple_values_error</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
<font color='#0000FF'>#else</font>
                <font color='#BB00BB'>multiple_values_error</font><font face='Lucida Console'>(</font><font color='#BB00BB'>str</font><font face='Lucida Console'>(</font>k.first<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>
            <b>}</b>
            m_kwargs[k.first] <font color='#5555FF'>=</font> k.second;
        <b>}</b>
    <b>}</b>

    [[noreturn]] <font color='#0000FF'>static</font> <font color='#0000FF'><u>void</u></font> <font color='#BB00BB'>nameless_argument_error</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>throw</font> <font color='#BB00BB'>type_error</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>Got kwargs without a name; only named arguments </font>"
                         "<font color='#CC0000'>may be passed via py::arg() to a python function call. </font>"
                         "<font color='#CC0000'>(compile in debug mode for details)</font>"<font face='Lucida Console'>)</font>;
    <b>}</b>
    [[noreturn]] <font color='#0000FF'>static</font> <font color='#0000FF'><u>void</u></font> <font color='#BB00BB'>nameless_argument_error</font><font face='Lucida Console'>(</font>std::string type<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>throw</font> <font color='#BB00BB'>type_error</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>Got kwargs without a name of type '</font>" <font color='#5555FF'>+</font> type <font color='#5555FF'>+</font> "<font color='#CC0000'>'; only named </font>"
                         "<font color='#CC0000'>arguments may be passed via py::arg() to a python function call. </font>"<font face='Lucida Console'>)</font>;
    <b>}</b>
    [[noreturn]] <font color='#0000FF'>static</font> <font color='#0000FF'><u>void</u></font> <font color='#BB00BB'>multiple_values_error</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>throw</font> <font color='#BB00BB'>type_error</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>Got multiple values for keyword argument </font>"
                         "<font color='#CC0000'>(compile in debug mode for details)</font>"<font face='Lucida Console'>)</font>;
    <b>}</b>

    [[noreturn]] <font color='#0000FF'>static</font> <font color='#0000FF'><u>void</u></font> <font color='#BB00BB'>multiple_values_error</font><font face='Lucida Console'>(</font>std::string name<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>throw</font> <font color='#BB00BB'>type_error</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>Got multiple values for keyword argument '</font>" <font color='#5555FF'>+</font> name <font color='#5555FF'>+</font> "<font color='#CC0000'>'</font>"<font face='Lucida Console'>)</font>;
    <b>}</b>

    [[noreturn]] <font color='#0000FF'>static</font> <font color='#0000FF'><u>void</u></font> <font color='#BB00BB'>argument_cast_error</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>throw</font> <font color='#BB00BB'>cast_error</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>Unable to convert call argument to Python object </font>"
                         "<font color='#CC0000'>(compile in debug mode for details)</font>"<font face='Lucida Console'>)</font>;
    <b>}</b>

    [[noreturn]] <font color='#0000FF'>static</font> <font color='#0000FF'><u>void</u></font> <font color='#BB00BB'>argument_cast_error</font><font face='Lucida Console'>(</font>std::string name, std::string type<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>throw</font> <font color='#BB00BB'>cast_error</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>Unable to convert call argument '</font>" <font color='#5555FF'>+</font> name
                         <font color='#5555FF'>+</font> "<font color='#CC0000'>' of type '</font>" <font color='#5555FF'>+</font> type <font color='#5555FF'>+</font> "<font color='#CC0000'>' to Python object</font>"<font face='Lucida Console'>)</font>;
    <b>}</b>

<font color='#0000FF'>private</font>:
    tuple m_args;
    dict m_kwargs;
<b>}</b>;

<font color='#009900'>/// Collect only positional arguments for a Python function call
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font>return_value_policy policy, <font color='#0000FF'>typename</font>... Args,
          <font color='#0000FF'>typename</font> <font color='#5555FF'>=</font> enable_if_t<font color='#5555FF'>&lt;</font>all_of<font color='#5555FF'>&lt;</font>is_positional<font color='#5555FF'>&lt;</font>Args<font color='#5555FF'>&gt;</font>...<font color='#5555FF'>&gt;</font>::value<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
simple_collector<font color='#5555FF'>&lt;</font>policy<font color='#5555FF'>&gt;</font> <font color='#BB00BB'>collect_arguments</font><font face='Lucida Console'>(</font>Args <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>...args<font face='Lucida Console'>)</font> <b>{</b>
    <font color='#0000FF'>return</font> simple_collector<font color='#5555FF'>&lt;</font>policy<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>std::forward<font color='#5555FF'>&lt;</font>Args<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>args<font face='Lucida Console'>)</font>...<font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#009900'>/// Collect all arguments, including keywords and unpacking (only instantiated when needed)
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font>return_value_policy policy, <font color='#0000FF'>typename</font>... Args,
          <font color='#0000FF'>typename</font> <font color='#5555FF'>=</font> enable_if_t<font color='#5555FF'>&lt;</font><font color='#5555FF'>!</font>all_of<font color='#5555FF'>&lt;</font>is_positional<font color='#5555FF'>&lt;</font>Args<font color='#5555FF'>&gt;</font>...<font color='#5555FF'>&gt;</font>::value<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
unpacking_collector<font color='#5555FF'>&lt;</font>policy<font color='#5555FF'>&gt;</font> <font color='#BB00BB'>collect_arguments</font><font face='Lucida Console'>(</font>Args <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>...args<font face='Lucida Console'>)</font> <b>{</b>
    <font color='#009900'>// Following argument order rules for generalized unpacking according to PEP 448
</font>    <font color='#BB00BB'>static_assert</font><font face='Lucida Console'>(</font>
        constexpr_last<font color='#5555FF'>&lt;</font>is_positional, Args...<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font> constexpr_first<font color='#5555FF'>&lt;</font>is_keyword_or_ds, Args...<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>
        <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> constexpr_last<font color='#5555FF'>&lt;</font>is_s_unpacking, Args...<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font> constexpr_first<font color='#5555FF'>&lt;</font>is_ds_unpacking, Args...<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>,
        "<font color='#CC0000'>Invalid function call: positional args must precede keywords and ** unpacking; </font>"
        "<font color='#CC0000'>* unpacking must precede ** unpacking</font>"
    <font face='Lucida Console'>)</font>;
    <font color='#0000FF'>return</font> unpacking_collector<font color='#5555FF'>&lt;</font>policy<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>std::forward<font color='#5555FF'>&lt;</font>Args<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>args<font face='Lucida Console'>)</font>...<font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> Derived<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font>return_value_policy policy, <font color='#0000FF'>typename</font>... Args<font color='#5555FF'>&gt;</font>
object object_api<font color='#5555FF'>&lt;</font>Derived<font color='#5555FF'>&gt;</font>::<b><a name='operator'></a>operator</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>Args <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>...args<font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b>
    <font color='#0000FF'>return</font> detail::collect_arguments<font color='#5555FF'>&lt;</font>policy<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>std::forward<font color='#5555FF'>&lt;</font>Args<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>args<font face='Lucida Console'>)</font>...<font face='Lucida Console'>)</font>.<font color='#BB00BB'>call</font><font face='Lucida Console'>(</font><font color='#BB00BB'>derived</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> Derived<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font>return_value_policy policy, <font color='#0000FF'>typename</font>... Args<font color='#5555FF'>&gt;</font>
object object_api<font color='#5555FF'>&lt;</font>Derived<font color='#5555FF'>&gt;</font>::<font color='#BB00BB'>call</font><font face='Lucida Console'>(</font>Args <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>...args<font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b>
    <font color='#0000FF'>return</font> <font color='#0000FF'>operator</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font color='#5555FF'>&lt;</font>policy<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>std::forward<font color='#5555FF'>&lt;</font>Args<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>args<font face='Lucida Console'>)</font>...<font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#BB00BB'>NAMESPACE_END</font><font face='Lucida Console'>(</font>detail<font face='Lucida Console'>)</font>

<font color='#0000FF'>#define</font> PYBIND11_MAKE_OPAQUE<font face='Lucida Console'>(</font>Type<font face='Lucida Console'>)</font> \
    <font color='#0000FF'>namespace</font> pybind11 <b>{</b> <font color='#0000FF'>namespace</font> detail <b>{</b> \
        <font color='#0000FF'>template</font><font color='#5555FF'>&lt;</font><font color='#5555FF'>&gt;</font> <font color='#0000FF'>class</font> <b><a name='type_caster'></a>type_caster</b><font color='#5555FF'>&lt;</font>Type<font color='#5555FF'>&gt;</font> : <font color='#0000FF'>public</font> type_caster_base<font color='#5555FF'>&lt;</font>Type<font color='#5555FF'>&gt;</font> <b>{</b> <b>}</b>; \
    <b>}</b><b>}</b>

<font color='#BB00BB'>NAMESPACE_END</font><font face='Lucida Console'>(</font>PYBIND11_NAMESPACE<font face='Lucida Console'>)</font>

</pre></body></html>