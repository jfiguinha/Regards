<html><!-- Created using the cpp_pretty_printer from the dlib C++ library.  See http://dlib.net for updates. --><head><title>dlib C++ Library - rdbmp.c</title></head><body bgcolor='white'><pre>
<font color='#009900'>/*
 * rdbmp.c
 *
 * Copyright (C) 1994-1996, Thomas G. Lane.
 * Modified 2009-2010 by Guido Vollbeding.
 * This file is part of the Independent JPEG Group's software.
 * For conditions of distribution and use, see the accompanying README file.
 *
 * This file contains routines to read input images in Microsoft "BMP"
 * format (MS Windows 3.x, OS/2 1.x, and OS/2 2.x flavors).
 * Currently, only 8-bit and 24-bit images are supported, not 1-bit or
 * 4-bit (feeding such low-depth images into JPEG would be silly anyway).
 * Also, we don't support RLE-compressed files.
 *
 * These routines may need modification for non-Unix environments or
 * specialized applications.  As they stand, they assume input from
 * an ordinary stdio stream.  They further assume that reading begins
 * at the start of the file; start_input may need work if the
 * user interface has already read some data (e.g., to determine that
 * the file is indeed BMP format).
 *
 * This code contributed by James Arthur Boucher.
 */</font>

<font color='#0000FF'>#include</font> "<a style='text-decoration:none' href='cdjpeg.h.html'>cdjpeg.h</a>"		<font color='#009900'>/* Common decls for cjpeg/djpeg applications */</font>

<font color='#0000FF'>#ifdef</font> BMP_SUPPORTED


<font color='#009900'>/* Macros to deal with unsigned chars as efficiently as compiler allows */</font>

<font color='#0000FF'>#ifdef</font> HAVE_UNSIGNED_CHAR
<font color='#0000FF'>typedef</font> <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>char</u></font> U_CHAR;
<font color='#0000FF'>#define</font> UCH<font face='Lucida Console'>(</font>x<font face='Lucida Console'>)</font>	<font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font> <font face='Lucida Console'>(</font>x<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
<font color='#0000FF'>#else</font> <font color='#009900'>/* !HAVE_UNSIGNED_CHAR */</font>
<font color='#0000FF'>#ifdef</font> CHAR_IS_UNSIGNED
<font color='#0000FF'>typedef</font> <font color='#0000FF'><u>char</u></font> U_CHAR;
<font color='#0000FF'>#define</font> UCH<font face='Lucida Console'>(</font>x<font face='Lucida Console'>)</font>	<font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font> <font face='Lucida Console'>(</font>x<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
<font color='#0000FF'>#else</font>
<font color='#0000FF'>typedef</font> <font color='#0000FF'><u>char</u></font> U_CHAR;
<font color='#0000FF'>#define</font> UCH<font face='Lucida Console'>(</font>x<font face='Lucida Console'>)</font>	<font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font> <font face='Lucida Console'>(</font>x<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xFF</font><font face='Lucida Console'>)</font>
<font color='#0000FF'>#endif</font>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* HAVE_UNSIGNED_CHAR */</font>


<font color='#0000FF'>#define</font>	ReadOK<font face='Lucida Console'>(</font>file,buffer,len<font face='Lucida Console'>)</font>	<font face='Lucida Console'>(</font>JFREAD<font face='Lucida Console'>(</font>file,buffer,len<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>size_t</u></font><font face='Lucida Console'>)</font> <font face='Lucida Console'>(</font>len<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>


<font color='#009900'>/* Private version of data source object */</font>

<font color='#0000FF'>typedef</font> <font color='#0000FF'>struct</font> _bmp_source_struct <font color='#5555FF'>*</font> bmp_source_ptr;

<font color='#0000FF'>typedef</font> <font color='#0000FF'>struct</font> <b><a name='_bmp_source_struct'></a>_bmp_source_struct</b> <b>{</b>
  <font color='#0000FF'>struct</font> cjpeg_source_struct pub; <font color='#009900'>/* public fields */</font>

  j_compress_ptr cinfo;		<font color='#009900'>/* back link saves passing separate parm */</font>

  JSAMPARRAY colormap;		<font color='#009900'>/* BMP colormap (converted to my format) */</font>

  jvirt_sarray_ptr whole_image;	<font color='#009900'>/* Needed to reverse row order */</font>
  JDIMENSION source_row;	<font color='#009900'>/* Current source row number */</font>
  JDIMENSION row_width;		<font color='#009900'>/* Physical width of scanlines in file */</font>

  <font color='#0000FF'><u>int</u></font> bits_per_pixel;		<font color='#009900'>/* remembers 8- or 24-bit format */</font>
<b>}</b> bmp_source_struct;


<b><a name='LOCAL'></a>LOCAL</b><font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font>
<b><a name='read_byte'></a>read_byte</b> <font face='Lucida Console'>(</font>bmp_source_ptr sinfo<font face='Lucida Console'>)</font>
<font color='#009900'>/* Read next byte from BMP file */</font>
<b>{</b>
  <font color='#0000FF'>register</font> FILE <font color='#5555FF'>*</font>infile <font color='#5555FF'>=</font> sinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.input_file;
  <font color='#0000FF'>register</font> <font color='#0000FF'><u>int</u></font> c;

  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>c <font color='#5555FF'>=</font> <font color='#BB00BB'>getc</font><font face='Lucida Console'>(</font>infile<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> EOF<font face='Lucida Console'>)</font>
    <font color='#BB00BB'>ERREXIT</font><font face='Lucida Console'>(</font>sinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>cinfo, JERR_INPUT_EOF<font face='Lucida Console'>)</font>;
  <font color='#0000FF'>return</font> c;
<b>}</b>


<b><a name='LOCAL'></a>LOCAL</b><font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font><font face='Lucida Console'>)</font>
<b><a name='read_colormap'></a>read_colormap</b> <font face='Lucida Console'>(</font>bmp_source_ptr sinfo, <font color='#0000FF'><u>int</u></font> cmaplen, <font color='#0000FF'><u>int</u></font> mapentrysize<font face='Lucida Console'>)</font>
<font color='#009900'>/* Read the colormap from a BMP file */</font>
<b>{</b>
  <font color='#0000FF'><u>int</u></font> i;

  <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font>mapentrysize<font face='Lucida Console'>)</font> <b>{</b>
  <font color='#0000FF'>case</font> <font color='#979000'>3</font>:
    <font color='#009900'>/* BGR format (occurs in OS/2 files) */</font>
    <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> cmaplen; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font> <b>{</b>
      sinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colormap[<font color='#979000'>2</font>][i] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>JSAMPLE<font face='Lucida Console'>)</font> <font color='#BB00BB'>read_byte</font><font face='Lucida Console'>(</font>sinfo<font face='Lucida Console'>)</font>;
      sinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colormap[<font color='#979000'>1</font>][i] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>JSAMPLE<font face='Lucida Console'>)</font> <font color='#BB00BB'>read_byte</font><font face='Lucida Console'>(</font>sinfo<font face='Lucida Console'>)</font>;
      sinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colormap[<font color='#979000'>0</font>][i] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>JSAMPLE<font face='Lucida Console'>)</font> <font color='#BB00BB'>read_byte</font><font face='Lucida Console'>(</font>sinfo<font face='Lucida Console'>)</font>;
    <b>}</b>
    <font color='#0000FF'>break</font>;
  <font color='#0000FF'>case</font> <font color='#979000'>4</font>:
    <font color='#009900'>/* BGR0 format (occurs in MS Windows files) */</font>
    <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> cmaplen; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font> <b>{</b>
      sinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colormap[<font color='#979000'>2</font>][i] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>JSAMPLE<font face='Lucida Console'>)</font> <font color='#BB00BB'>read_byte</font><font face='Lucida Console'>(</font>sinfo<font face='Lucida Console'>)</font>;
      sinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colormap[<font color='#979000'>1</font>][i] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>JSAMPLE<font face='Lucida Console'>)</font> <font color='#BB00BB'>read_byte</font><font face='Lucida Console'>(</font>sinfo<font face='Lucida Console'>)</font>;
      sinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colormap[<font color='#979000'>0</font>][i] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>JSAMPLE<font face='Lucida Console'>)</font> <font color='#BB00BB'>read_byte</font><font face='Lucida Console'>(</font>sinfo<font face='Lucida Console'>)</font>;
      <font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font><font face='Lucida Console'>)</font> <font color='#BB00BB'>read_byte</font><font face='Lucida Console'>(</font>sinfo<font face='Lucida Console'>)</font>;
    <b>}</b>
    <font color='#0000FF'>break</font>;
  <font color='#0000FF'>default</font>:
    <font color='#BB00BB'>ERREXIT</font><font face='Lucida Console'>(</font>sinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>cinfo, JERR_BMP_BADCMAP<font face='Lucida Console'>)</font>;
    <font color='#0000FF'>break</font>;
  <b>}</b>
<b>}</b>


<font color='#009900'>/*
 * Read one row of pixels.
 * The image has been read into the whole_image array, but is otherwise
 * unprocessed.  We must read it out in top-to-bottom row order, and if
 * it is an 8-bit image, we must expand colormapped pixels to 24bit format.
 */</font>

<b><a name='METHODDEF'></a>METHODDEF</b><font face='Lucida Console'>(</font>JDIMENSION<font face='Lucida Console'>)</font>
<b><a name='get_8bit_row'></a>get_8bit_row</b> <font face='Lucida Console'>(</font>j_compress_ptr cinfo, cjpeg_source_ptr sinfo<font face='Lucida Console'>)</font>
<font color='#009900'>/* This version is for reading 8-bit colormap indexes */</font>
<b>{</b>
  bmp_source_ptr source <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>bmp_source_ptr<font face='Lucida Console'>)</font> sinfo;
  <font color='#0000FF'>register</font> JSAMPARRAY colormap <font color='#5555FF'>=</font> source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colormap;
  JSAMPARRAY image_ptr;
  <font color='#0000FF'>register</font> <font color='#0000FF'><u>int</u></font> t;
  <font color='#0000FF'>register</font> JSAMPROW inptr, outptr;
  <font color='#0000FF'>register</font> JDIMENSION col;

  <font color='#009900'>/* Fetch next row from virtual array */</font>
  source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>source_row<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
  image_ptr <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mem<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>access_virt_sarray<font face='Lucida Console'>)</font>
    <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>j_common_ptr<font face='Lucida Console'>)</font> cinfo, source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>whole_image,
     source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>source_row, <font face='Lucida Console'>(</font>JDIMENSION<font face='Lucida Console'>)</font> <font color='#979000'>1</font>, FALSE<font face='Lucida Console'>)</font>;

  <font color='#009900'>/* Expand the colormap indexes to real data */</font>
  inptr <font color='#5555FF'>=</font> image_ptr[<font color='#979000'>0</font>];
  outptr <font color='#5555FF'>=</font> source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.buffer[<font color='#979000'>0</font>];
  <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>col <font color='#5555FF'>=</font> cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>image_width; col <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font>; col<font color='#5555FF'>-</font><font color='#5555FF'>-</font><font face='Lucida Console'>)</font> <b>{</b>
    t <font color='#5555FF'>=</font> <font color='#BB00BB'>GETJSAMPLE</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>inptr<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>;
    <font color='#5555FF'>*</font>outptr<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> colormap[<font color='#979000'>0</font>][t];	<font color='#009900'>/* can omit GETJSAMPLE() safely */</font>
    <font color='#5555FF'>*</font>outptr<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> colormap[<font color='#979000'>1</font>][t];
    <font color='#5555FF'>*</font>outptr<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> colormap[<font color='#979000'>2</font>][t];
  <b>}</b>

  <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
<b>}</b>


<b><a name='METHODDEF'></a>METHODDEF</b><font face='Lucida Console'>(</font>JDIMENSION<font face='Lucida Console'>)</font>
<b><a name='get_24bit_row'></a>get_24bit_row</b> <font face='Lucida Console'>(</font>j_compress_ptr cinfo, cjpeg_source_ptr sinfo<font face='Lucida Console'>)</font>
<font color='#009900'>/* This version is for reading 24-bit pixels */</font>
<b>{</b>
  bmp_source_ptr source <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>bmp_source_ptr<font face='Lucida Console'>)</font> sinfo;
  JSAMPARRAY image_ptr;
  <font color='#0000FF'>register</font> JSAMPROW inptr, outptr;
  <font color='#0000FF'>register</font> JDIMENSION col;

  <font color='#009900'>/* Fetch next row from virtual array */</font>
  source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>source_row<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
  image_ptr <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mem<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>access_virt_sarray<font face='Lucida Console'>)</font>
    <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>j_common_ptr<font face='Lucida Console'>)</font> cinfo, source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>whole_image,
     source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>source_row, <font face='Lucida Console'>(</font>JDIMENSION<font face='Lucida Console'>)</font> <font color='#979000'>1</font>, FALSE<font face='Lucida Console'>)</font>;

  <font color='#009900'>/* Transfer data.  Note source values are in BGR order
   * (even though Microsoft's own documents say the opposite).
   */</font>
  inptr <font color='#5555FF'>=</font> image_ptr[<font color='#979000'>0</font>];
  outptr <font color='#5555FF'>=</font> source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.buffer[<font color='#979000'>0</font>];
  <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>col <font color='#5555FF'>=</font> cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>image_width; col <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font>; col<font color='#5555FF'>-</font><font color='#5555FF'>-</font><font face='Lucida Console'>)</font> <b>{</b>
    outptr[<font color='#979000'>2</font>] <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>inptr<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;	<font color='#009900'>/* can omit GETJSAMPLE() safely */</font>
    outptr[<font color='#979000'>1</font>] <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>inptr<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
    outptr[<font color='#979000'>0</font>] <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>inptr<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
    outptr <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>3</font>;
  <b>}</b>

  <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
<b>}</b>


<b><a name='METHODDEF'></a>METHODDEF</b><font face='Lucida Console'>(</font>JDIMENSION<font face='Lucida Console'>)</font>
<b><a name='get_32bit_row'></a>get_32bit_row</b> <font face='Lucida Console'>(</font>j_compress_ptr cinfo, cjpeg_source_ptr sinfo<font face='Lucida Console'>)</font>
<font color='#009900'>/* This version is for reading 32-bit pixels */</font>
<b>{</b>
  bmp_source_ptr source <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>bmp_source_ptr<font face='Lucida Console'>)</font> sinfo;
  JSAMPARRAY image_ptr;
  <font color='#0000FF'>register</font> JSAMPROW inptr, outptr;
  <font color='#0000FF'>register</font> JDIMENSION col;

  <font color='#009900'>/* Fetch next row from virtual array */</font>
  source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>source_row<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
  image_ptr <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mem<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>access_virt_sarray<font face='Lucida Console'>)</font>
    <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>j_common_ptr<font face='Lucida Console'>)</font> cinfo, source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>whole_image,
     source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>source_row, <font face='Lucida Console'>(</font>JDIMENSION<font face='Lucida Console'>)</font> <font color='#979000'>1</font>, FALSE<font face='Lucida Console'>)</font>;
  <font color='#009900'>/* Transfer data.  Note source values are in BGR order
   * (even though Microsoft's own documents say the opposite).
   */</font>
  inptr <font color='#5555FF'>=</font> image_ptr[<font color='#979000'>0</font>];
  outptr <font color='#5555FF'>=</font> source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.buffer[<font color='#979000'>0</font>];
  <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>col <font color='#5555FF'>=</font> cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>image_width; col <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font>; col<font color='#5555FF'>-</font><font color='#5555FF'>-</font><font face='Lucida Console'>)</font> <b>{</b>
    outptr[<font color='#979000'>2</font>] <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>inptr<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;	<font color='#009900'>/* can omit GETJSAMPLE() safely */</font>
    outptr[<font color='#979000'>1</font>] <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>inptr<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
    outptr[<font color='#979000'>0</font>] <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>inptr<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
    inptr<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;			<font color='#009900'>/* skip the 4th byte (Alpha channel) */</font>
    outptr <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>3</font>;
  <b>}</b>

  <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
<b>}</b>


<font color='#009900'>/*
 * This method loads the image into whole_image during the first call on
 * get_pixel_rows.  The get_pixel_rows pointer is then adjusted to call
 * get_8bit_row, get_24bit_row, or get_32bit_row on subsequent calls.
 */</font>

<b><a name='METHODDEF'></a>METHODDEF</b><font face='Lucida Console'>(</font>JDIMENSION<font face='Lucida Console'>)</font>
<b><a name='preload_image'></a>preload_image</b> <font face='Lucida Console'>(</font>j_compress_ptr cinfo, cjpeg_source_ptr sinfo<font face='Lucida Console'>)</font>
<b>{</b>
  bmp_source_ptr source <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>bmp_source_ptr<font face='Lucida Console'>)</font> sinfo;
  <font color='#0000FF'>register</font> FILE <font color='#5555FF'>*</font>infile <font color='#5555FF'>=</font> source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.input_file;
  <font color='#0000FF'>register</font> <font color='#0000FF'><u>int</u></font> c;
  <font color='#0000FF'>register</font> JSAMPROW out_ptr;
  JSAMPARRAY image_ptr;
  JDIMENSION row, col;
  cd_progress_ptr progress <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>cd_progress_ptr<font face='Lucida Console'>)</font> cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>progress;

  <font color='#009900'>/* Read the data into a virtual array in input-file row order. */</font>
  <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>row <font color='#5555FF'>=</font> <font color='#979000'>0</font>; row <font color='#5555FF'>&lt;</font> cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>image_height; row<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font> <b>{</b>
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>progress <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font> <b>{</b>
      progress<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.pass_counter <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>long</u></font><font face='Lucida Console'>)</font> row;
      progress<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.pass_limit <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>long</u></font><font face='Lucida Console'>)</font> cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>image_height;
      <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>progress<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.progress_monitor<font face='Lucida Console'>)</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>j_common_ptr<font face='Lucida Console'>)</font> cinfo<font face='Lucida Console'>)</font>;
    <b>}</b>
    image_ptr <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mem<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>access_virt_sarray<font face='Lucida Console'>)</font>
      <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>j_common_ptr<font face='Lucida Console'>)</font> cinfo, source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>whole_image,
       row, <font face='Lucida Console'>(</font>JDIMENSION<font face='Lucida Console'>)</font> <font color='#979000'>1</font>, TRUE<font face='Lucida Console'>)</font>;
    out_ptr <font color='#5555FF'>=</font> image_ptr[<font color='#979000'>0</font>];
    <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>col <font color='#5555FF'>=</font> source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_width; col <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font>; col<font color='#5555FF'>-</font><font color='#5555FF'>-</font><font face='Lucida Console'>)</font> <b>{</b>
      <font color='#009900'>/* inline copy of read_byte() for speed */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>c <font color='#5555FF'>=</font> <font color='#BB00BB'>getc</font><font face='Lucida Console'>(</font>infile<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> EOF<font face='Lucida Console'>)</font>
	<font color='#BB00BB'>ERREXIT</font><font face='Lucida Console'>(</font>cinfo, JERR_INPUT_EOF<font face='Lucida Console'>)</font>;
      <font color='#5555FF'>*</font>out_ptr<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>JSAMPLE<font face='Lucida Console'>)</font> c;
    <b>}</b>
  <b>}</b>
  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>progress <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
    progress<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>completed_extra_passes<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;

  <font color='#009900'>/* Set up to read from the virtual array in top-to-bottom order */</font>
  <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font>source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bits_per_pixel<font face='Lucida Console'>)</font> <b>{</b>
  <font color='#0000FF'>case</font> <font color='#979000'>8</font>:
    source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.get_pixel_rows <font color='#5555FF'>=</font> get_8bit_row;
    <font color='#0000FF'>break</font>;
  <font color='#0000FF'>case</font> <font color='#979000'>24</font>:
    source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.get_pixel_rows <font color='#5555FF'>=</font> get_24bit_row;
    <font color='#0000FF'>break</font>;
  <font color='#0000FF'>case</font> <font color='#979000'>32</font>:
    source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.get_pixel_rows <font color='#5555FF'>=</font> get_32bit_row;
    <font color='#0000FF'>break</font>;
  <font color='#0000FF'>default</font>:
    <font color='#BB00BB'>ERREXIT</font><font face='Lucida Console'>(</font>cinfo, JERR_BMP_BADDEPTH<font face='Lucida Console'>)</font>;
  <b>}</b>
  source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>source_row <font color='#5555FF'>=</font> cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>image_height;

  <font color='#009900'>/* And read the first row */</font>
  <font color='#0000FF'>return</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.get_pixel_rows<font face='Lucida Console'>)</font> <font face='Lucida Console'>(</font>cinfo, sinfo<font face='Lucida Console'>)</font>;
<b>}</b>


<font color='#009900'>/*
 * Read the file header; return image size and component count.
 */</font>

<b><a name='METHODDEF'></a>METHODDEF</b><font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font><font face='Lucida Console'>)</font>
<b><a name='start_input_bmp'></a>start_input_bmp</b> <font face='Lucida Console'>(</font>j_compress_ptr cinfo, cjpeg_source_ptr sinfo<font face='Lucida Console'>)</font>
<b>{</b>
  bmp_source_ptr source <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>bmp_source_ptr<font face='Lucida Console'>)</font> sinfo;
  U_CHAR bmpfileheader[<font color='#979000'>14</font>];
  U_CHAR bmpinfoheader[<font color='#979000'>64</font>];
<font color='#0000FF'>#define</font> GET_2B<font face='Lucida Console'>(</font>array,offset<font face='Lucida Console'>)</font>  <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font> UCH<font face='Lucida Console'>(</font>array[offset]<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> \
			       <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font> <font color='#BB00BB'>UCH</font><font face='Lucida Console'>(</font>array[offset<font color='#5555FF'>+</font><font color='#979000'>1</font>]<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
<font color='#0000FF'>#define</font> GET_4B<font face='Lucida Console'>(</font>array,offset<font face='Lucida Console'>)</font>  <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>INT32<font face='Lucida Console'>)</font> UCH<font face='Lucida Console'>(</font>array[offset]<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> \
			       <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>INT32<font face='Lucida Console'>)</font> <font color='#BB00BB'>UCH</font><font face='Lucida Console'>(</font>array[offset<font color='#5555FF'>+</font><font color='#979000'>1</font>]<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> \
			       <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>INT32<font face='Lucida Console'>)</font> <font color='#BB00BB'>UCH</font><font face='Lucida Console'>(</font>array[offset<font color='#5555FF'>+</font><font color='#979000'>2</font>]<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>16</font><font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> \
			       <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>INT32<font face='Lucida Console'>)</font> <font color='#BB00BB'>UCH</font><font face='Lucida Console'>(</font>array[offset<font color='#5555FF'>+</font><font color='#979000'>3</font>]<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>24</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
  INT32 bfOffBits;
  INT32 headerSize;
  INT32 biWidth;
  INT32 biHeight;
  <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> biPlanes;
  INT32 biCompression;
  INT32 biXPelsPerMeter,biYPelsPerMeter;
  INT32 biClrUsed <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
  <font color='#0000FF'><u>int</u></font> mapentrysize <font color='#5555FF'>=</font> <font color='#979000'>0</font>;		<font color='#009900'>/* 0 indicates no colormap */</font>
  INT32 bPad;
  JDIMENSION row_width;

  <font color='#009900'>/* Read and verify the bitmap file header */</font>
  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font> <font color='#BB00BB'>ReadOK</font><font face='Lucida Console'>(</font>source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.input_file, bmpfileheader, <font color='#979000'>14</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
    <font color='#BB00BB'>ERREXIT</font><font face='Lucida Console'>(</font>cinfo, JERR_INPUT_EOF<font face='Lucida Console'>)</font>;
  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>GET_2B</font><font face='Lucida Console'>(</font>bmpfileheader,<font color='#979000'>0</font><font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0x4D42</font><font face='Lucida Console'>)</font> <font color='#009900'>/* 'BM' */</font>
    <font color='#BB00BB'>ERREXIT</font><font face='Lucida Console'>(</font>cinfo, JERR_BMP_NOT<font face='Lucida Console'>)</font>;
  bfOffBits <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>INT32<font face='Lucida Console'>)</font> <font color='#BB00BB'>GET_4B</font><font face='Lucida Console'>(</font>bmpfileheader,<font color='#979000'>10</font><font face='Lucida Console'>)</font>;
  <font color='#009900'>/* We ignore the remaining fileheader fields */</font>

  <font color='#009900'>/* The infoheader might be 12 bytes (OS/2 1.x), 40 bytes (Windows),
   * or 64 bytes (OS/2 2.x).  Check the first 4 bytes to find out which.
   */</font>
  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font> <font color='#BB00BB'>ReadOK</font><font face='Lucida Console'>(</font>source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.input_file, bmpinfoheader, <font color='#979000'>4</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
    <font color='#BB00BB'>ERREXIT</font><font face='Lucida Console'>(</font>cinfo, JERR_INPUT_EOF<font face='Lucida Console'>)</font>;
  headerSize <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>INT32<font face='Lucida Console'>)</font> <font color='#BB00BB'>GET_4B</font><font face='Lucida Console'>(</font>bmpinfoheader,<font color='#979000'>0</font><font face='Lucida Console'>)</font>;
  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>headerSize <font color='#5555FF'>&lt;</font> <font color='#979000'>12</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> headerSize <font color='#5555FF'>&gt;</font> <font color='#979000'>64</font><font face='Lucida Console'>)</font>
    <font color='#BB00BB'>ERREXIT</font><font face='Lucida Console'>(</font>cinfo, JERR_BMP_BADHEADER<font face='Lucida Console'>)</font>;
  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font> <font color='#BB00BB'>ReadOK</font><font face='Lucida Console'>(</font>source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.input_file, bmpinfoheader<font color='#5555FF'>+</font><font color='#979000'>4</font>, headerSize<font color='#5555FF'>-</font><font color='#979000'>4</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
    <font color='#BB00BB'>ERREXIT</font><font face='Lucida Console'>(</font>cinfo, JERR_INPUT_EOF<font face='Lucida Console'>)</font>;

  <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font> headerSize<font face='Lucida Console'>)</font> <b>{</b>
  <font color='#0000FF'>case</font> <font color='#979000'>12</font>:
    <font color='#009900'>/* Decode OS/2 1.x header (Microsoft calls this a BITMAPCOREHEADER) */</font>
    biWidth <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>INT32<font face='Lucida Console'>)</font> <font color='#BB00BB'>GET_2B</font><font face='Lucida Console'>(</font>bmpinfoheader,<font color='#979000'>4</font><font face='Lucida Console'>)</font>;
    biHeight <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>INT32<font face='Lucida Console'>)</font> <font color='#BB00BB'>GET_2B</font><font face='Lucida Console'>(</font>bmpinfoheader,<font color='#979000'>6</font><font face='Lucida Console'>)</font>;
    biPlanes <font color='#5555FF'>=</font> <font color='#BB00BB'>GET_2B</font><font face='Lucida Console'>(</font>bmpinfoheader,<font color='#979000'>8</font><font face='Lucida Console'>)</font>;
    source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bits_per_pixel <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font> <font color='#BB00BB'>GET_2B</font><font face='Lucida Console'>(</font>bmpinfoheader,<font color='#979000'>10</font><font face='Lucida Console'>)</font>;

    <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font>source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bits_per_pixel<font face='Lucida Console'>)</font> <b>{</b>
    <font color='#0000FF'>case</font> <font color='#979000'>8</font>:			<font color='#009900'>/* colormapped image */</font>
      mapentrysize <font color='#5555FF'>=</font> <font color='#979000'>3</font>;		<font color='#009900'>/* OS/2 uses RGBTRIPLE colormap */</font>
      <font color='#BB00BB'>TRACEMS2</font><font face='Lucida Console'>(</font>cinfo, <font color='#979000'>1</font>, JTRC_BMP_OS2_MAPPED, <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font> biWidth, <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font> biHeight<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>break</font>;
    <font color='#0000FF'>case</font> <font color='#979000'>24</font>:			<font color='#009900'>/* RGB image */</font>
      <font color='#BB00BB'>TRACEMS2</font><font face='Lucida Console'>(</font>cinfo, <font color='#979000'>1</font>, JTRC_BMP_OS2, <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font> biWidth, <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font> biHeight<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>break</font>;
    <font color='#0000FF'>default</font>:
      <font color='#BB00BB'>ERREXIT</font><font face='Lucida Console'>(</font>cinfo, JERR_BMP_BADDEPTH<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>break</font>;
    <b>}</b>
    <font color='#0000FF'>break</font>;
  <font color='#0000FF'>case</font> <font color='#979000'>40</font>:
  <font color='#0000FF'>case</font> <font color='#979000'>64</font>:
    <font color='#009900'>/* Decode Windows 3.x header (Microsoft calls this a BITMAPINFOHEADER) */</font>
    <font color='#009900'>/* or OS/2 2.x header, which has additional fields that we ignore */</font>
    biWidth <font color='#5555FF'>=</font> <font color='#BB00BB'>GET_4B</font><font face='Lucida Console'>(</font>bmpinfoheader,<font color='#979000'>4</font><font face='Lucida Console'>)</font>;
    biHeight <font color='#5555FF'>=</font> <font color='#BB00BB'>GET_4B</font><font face='Lucida Console'>(</font>bmpinfoheader,<font color='#979000'>8</font><font face='Lucida Console'>)</font>;
    biPlanes <font color='#5555FF'>=</font> <font color='#BB00BB'>GET_2B</font><font face='Lucida Console'>(</font>bmpinfoheader,<font color='#979000'>12</font><font face='Lucida Console'>)</font>;
    source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bits_per_pixel <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font> <font color='#BB00BB'>GET_2B</font><font face='Lucida Console'>(</font>bmpinfoheader,<font color='#979000'>14</font><font face='Lucida Console'>)</font>;
    biCompression <font color='#5555FF'>=</font> <font color='#BB00BB'>GET_4B</font><font face='Lucida Console'>(</font>bmpinfoheader,<font color='#979000'>16</font><font face='Lucida Console'>)</font>;
    biXPelsPerMeter <font color='#5555FF'>=</font> <font color='#BB00BB'>GET_4B</font><font face='Lucida Console'>(</font>bmpinfoheader,<font color='#979000'>24</font><font face='Lucida Console'>)</font>;
    biYPelsPerMeter <font color='#5555FF'>=</font> <font color='#BB00BB'>GET_4B</font><font face='Lucida Console'>(</font>bmpinfoheader,<font color='#979000'>28</font><font face='Lucida Console'>)</font>;
    biClrUsed <font color='#5555FF'>=</font> <font color='#BB00BB'>GET_4B</font><font face='Lucida Console'>(</font>bmpinfoheader,<font color='#979000'>32</font><font face='Lucida Console'>)</font>;
    <font color='#009900'>/* biSizeImage, biClrImportant fields are ignored */</font>

    <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font>source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bits_per_pixel<font face='Lucida Console'>)</font> <b>{</b>
    <font color='#0000FF'>case</font> <font color='#979000'>8</font>:			<font color='#009900'>/* colormapped image */</font>
      mapentrysize <font color='#5555FF'>=</font> <font color='#979000'>4</font>;		<font color='#009900'>/* Windows uses RGBQUAD colormap */</font>
      <font color='#BB00BB'>TRACEMS2</font><font face='Lucida Console'>(</font>cinfo, <font color='#979000'>1</font>, JTRC_BMP_MAPPED, <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font> biWidth, <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font> biHeight<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>break</font>;
    <font color='#0000FF'>case</font> <font color='#979000'>24</font>:			<font color='#009900'>/* RGB image */</font>
      <font color='#BB00BB'>TRACEMS2</font><font face='Lucida Console'>(</font>cinfo, <font color='#979000'>1</font>, JTRC_BMP, <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font> biWidth, <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font> biHeight<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>break</font>;
    <font color='#0000FF'>case</font> <font color='#979000'>32</font>:			<font color='#009900'>/* RGB image + Alpha channel */</font>
      <font color='#BB00BB'>TRACEMS2</font><font face='Lucida Console'>(</font>cinfo, <font color='#979000'>1</font>, JTRC_BMP, <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font> biWidth, <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font> biHeight<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>break</font>;
    <font color='#0000FF'>default</font>:
      <font color='#BB00BB'>ERREXIT</font><font face='Lucida Console'>(</font>cinfo, JERR_BMP_BADDEPTH<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>break</font>;
    <b>}</b>
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>biCompression <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>ERREXIT</font><font face='Lucida Console'>(</font>cinfo, JERR_BMP_COMPRESSED<font face='Lucida Console'>)</font>;

    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>biXPelsPerMeter <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> biYPelsPerMeter <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <b>{</b>
      <font color='#009900'>/* Set JFIF density parameters from the BMP data */</font>
      cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>X_density <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>UINT16<font face='Lucida Console'>)</font> <font face='Lucida Console'>(</font>biXPelsPerMeter<font color='#5555FF'>/</font><font color='#979000'>100</font><font face='Lucida Console'>)</font>; <font color='#009900'>/* 100 cm per meter */</font>
      cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>Y_density <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>UINT16<font face='Lucida Console'>)</font> <font face='Lucida Console'>(</font>biYPelsPerMeter<font color='#5555FF'>/</font><font color='#979000'>100</font><font face='Lucida Console'>)</font>;
      cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>density_unit <font color='#5555FF'>=</font> <font color='#979000'>2</font>;	<font color='#009900'>/* dots/cm */</font>
    <b>}</b>
    <font color='#0000FF'>break</font>;
  <font color='#0000FF'>default</font>:
    <font color='#BB00BB'>ERREXIT</font><font face='Lucida Console'>(</font>cinfo, JERR_BMP_BADHEADER<font face='Lucida Console'>)</font>;
    <font color='#0000FF'>return</font>;
  <b>}</b>

  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>biWidth <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> biHeight <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
    <font color='#BB00BB'>ERREXIT</font><font face='Lucida Console'>(</font>cinfo, JERR_BMP_EMPTY<font face='Lucida Console'>)</font>;
  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>biPlanes <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>
    <font color='#BB00BB'>ERREXIT</font><font face='Lucida Console'>(</font>cinfo, JERR_BMP_BADPLANES<font face='Lucida Console'>)</font>;

  <font color='#009900'>/* Compute distance to bitmap data --- will adjust for colormap below */</font>
  bPad <font color='#5555FF'>=</font> bfOffBits <font color='#5555FF'>-</font> <font face='Lucida Console'>(</font>headerSize <font color='#5555FF'>+</font> <font color='#979000'>14</font><font face='Lucida Console'>)</font>;

  <font color='#009900'>/* Read the colormap, if any */</font>
  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>mapentrysize <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <b>{</b>
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>biClrUsed <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
      biClrUsed <font color='#5555FF'>=</font> <font color='#979000'>256</font>;		<font color='#009900'>/* assume it's 256 */</font>
    <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>biClrUsed <font color='#5555FF'>&gt;</font> <font color='#979000'>256</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>ERREXIT</font><font face='Lucida Console'>(</font>cinfo, JERR_BMP_BADCMAP<font face='Lucida Console'>)</font>;
    <font color='#009900'>/* Allocate space to store the colormap */</font>
    source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colormap <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mem<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>alloc_sarray<font face='Lucida Console'>)</font>
      <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>j_common_ptr<font face='Lucida Console'>)</font> cinfo, JPOOL_IMAGE,
       <font face='Lucida Console'>(</font>JDIMENSION<font face='Lucida Console'>)</font> biClrUsed, <font face='Lucida Console'>(</font>JDIMENSION<font face='Lucida Console'>)</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font>;
    <font color='#009900'>/* and read it from the file */</font>
    <font color='#BB00BB'>read_colormap</font><font face='Lucida Console'>(</font>source, <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font> biClrUsed, mapentrysize<font face='Lucida Console'>)</font>;
    <font color='#009900'>/* account for size of colormap */</font>
    bPad <font color='#5555FF'>-</font><font color='#5555FF'>=</font> biClrUsed <font color='#5555FF'>*</font> mapentrysize;
  <b>}</b>

  <font color='#009900'>/* Skip any remaining pad bytes */</font>
  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>bPad <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>			<font color='#009900'>/* incorrect bfOffBits value? */</font>
    <font color='#BB00BB'>ERREXIT</font><font face='Lucida Console'>(</font>cinfo, JERR_BMP_BADHEADER<font face='Lucida Console'>)</font>;
  <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>bPad <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <b>{</b>
    <font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font><font face='Lucida Console'>)</font> <font color='#BB00BB'>read_byte</font><font face='Lucida Console'>(</font>source<font face='Lucida Console'>)</font>;
  <b>}</b>

  <font color='#009900'>/* Compute row width in file, including padding to 4-byte boundary */</font>
  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bits_per_pixel <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>24</font><font face='Lucida Console'>)</font>
    row_width <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>JDIMENSION<font face='Lucida Console'>)</font> <font face='Lucida Console'>(</font>biWidth <font color='#5555FF'>*</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font>;
  <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bits_per_pixel <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>32</font><font face='Lucida Console'>)</font>
    row_width <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>JDIMENSION<font face='Lucida Console'>)</font> <font face='Lucida Console'>(</font>biWidth <font color='#5555FF'>*</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font>;
  <font color='#0000FF'>else</font>
    row_width <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>JDIMENSION<font face='Lucida Console'>)</font> biWidth;
  <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>row_width <font color='#5555FF'>&amp;</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> row_width<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
  source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_width <font color='#5555FF'>=</font> row_width;

  <font color='#009900'>/* Allocate space for inversion array, prepare for preload pass */</font>
  source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>whole_image <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mem<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>request_virt_sarray<font face='Lucida Console'>)</font>
    <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>j_common_ptr<font face='Lucida Console'>)</font> cinfo, JPOOL_IMAGE, FALSE,
     row_width, <font face='Lucida Console'>(</font>JDIMENSION<font face='Lucida Console'>)</font> biHeight, <font face='Lucida Console'>(</font>JDIMENSION<font face='Lucida Console'>)</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;
  source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.get_pixel_rows <font color='#5555FF'>=</font> preload_image;
  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>progress <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font> <b>{</b>
    cd_progress_ptr progress <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>cd_progress_ptr<font face='Lucida Console'>)</font> cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>progress;
    progress<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>total_extra_passes<font color='#5555FF'>+</font><font color='#5555FF'>+</font>; <font color='#009900'>/* count file input as separate pass */</font>
  <b>}</b>

  <font color='#009900'>/* Allocate one-row buffer for returned data */</font>
  source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.buffer <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mem<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>alloc_sarray<font face='Lucida Console'>)</font>
    <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>j_common_ptr<font face='Lucida Console'>)</font> cinfo, JPOOL_IMAGE,
     <font face='Lucida Console'>(</font>JDIMENSION<font face='Lucida Console'>)</font> <font face='Lucida Console'>(</font>biWidth <font color='#5555FF'>*</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font>, <font face='Lucida Console'>(</font>JDIMENSION<font face='Lucida Console'>)</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;
  source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.buffer_height <font color='#5555FF'>=</font> <font color='#979000'>1</font>;

  cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>in_color_space <font color='#5555FF'>=</font> JCS_RGB;
  cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>input_components <font color='#5555FF'>=</font> <font color='#979000'>3</font>;
  cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>data_precision <font color='#5555FF'>=</font> <font color='#979000'>8</font>;
  cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>image_width <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>JDIMENSION<font face='Lucida Console'>)</font> biWidth;
  cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>image_height <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>JDIMENSION<font face='Lucida Console'>)</font> biHeight;
<b>}</b>


<font color='#009900'>/*
 * Finish up at the end of the file.
 */</font>

<b><a name='METHODDEF'></a>METHODDEF</b><font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font><font face='Lucida Console'>)</font>
<b><a name='finish_input_bmp'></a>finish_input_bmp</b> <font face='Lucida Console'>(</font>j_compress_ptr cinfo, cjpeg_source_ptr sinfo<font face='Lucida Console'>)</font>
<b>{</b>
  <font color='#009900'>/* no work */</font>
<b>}</b>


<font color='#009900'>/*
 * The module selection routine for BMP format input.
 */</font>

<b><a name='GLOBAL'></a>GLOBAL</b><font face='Lucida Console'>(</font>cjpeg_source_ptr<font face='Lucida Console'>)</font>
<b><a name='jinit_read_bmp'></a>jinit_read_bmp</b> <font face='Lucida Console'>(</font>j_compress_ptr cinfo<font face='Lucida Console'>)</font>
<b>{</b>
  bmp_source_ptr source;

  <font color='#009900'>/* Create module interface object */</font>
  source <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>bmp_source_ptr<font face='Lucida Console'>)</font>
      <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mem<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>alloc_small<font face='Lucida Console'>)</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>j_common_ptr<font face='Lucida Console'>)</font> cinfo, JPOOL_IMAGE,
				  <font color='#BB00BB'>SIZEOF</font><font face='Lucida Console'>(</font>bmp_source_struct<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
  source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>cinfo <font color='#5555FF'>=</font> cinfo;	<font color='#009900'>/* make back link for subroutines */</font>
  <font color='#009900'>/* Fill in method ptrs, except get_pixel_rows which start_input sets */</font>
  source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.start_input <font color='#5555FF'>=</font> start_input_bmp;
  source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.finish_input <font color='#5555FF'>=</font> finish_input_bmp;

  <font color='#0000FF'>return</font> <font face='Lucida Console'>(</font>cjpeg_source_ptr<font face='Lucida Console'>)</font> source;
<b>}</b>

<font color='#0000FF'>#endif</font> <font color='#009900'>/* BMP_SUPPORTED */</font>

</pre></body></html>