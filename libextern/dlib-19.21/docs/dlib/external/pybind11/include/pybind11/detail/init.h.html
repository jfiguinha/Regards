<html><!-- Created using the cpp_pretty_printer from the dlib C++ library.  See http://dlib.net for updates. --><head><title>dlib C++ Library - init.h</title></head><body bgcolor='white'><pre>
<font color='#009900'>/*
    pybind11/detail/init.h: init factory function implementation and support code.

    Copyright (c) 2017 Jason Rhinelander &lt;jason@imaginary.ca&gt;

    All rights reserved. Use of this source code is governed by a
    BSD-style license that can be found in the LICENSE file.
*/</font>

<font color='#0000FF'>#pragma</font> once

<font color='#0000FF'>#include</font> "<a style='text-decoration:none' href='class.h.html'>class.h</a>"

<b><a name='NAMESPACE_BEGIN'></a>NAMESPACE_BEGIN</b><font face='Lucida Console'>(</font>PYBIND11_NAMESPACE<font face='Lucida Console'>)</font>
<b><a name='NAMESPACE_BEGIN'></a>NAMESPACE_BEGIN</b><font face='Lucida Console'>(</font>detail<font face='Lucida Console'>)</font>

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&gt;</font>
<font color='#0000FF'>class</font> <b><a name='type_caster'></a>type_caster</b><font color='#5555FF'>&lt;</font>value_and_holder<font color='#5555FF'>&gt;</font> <b>{</b>
<font color='#0000FF'>public</font>:
    <font color='#0000FF'><u>bool</u></font> <b><a name='load'></a>load</b><font face='Lucida Console'>(</font>handle h, <font color='#0000FF'><u>bool</u></font><font face='Lucida Console'>)</font> <b>{</b>
        value <font color='#5555FF'>=</font> <font color='#0000FF'>reinterpret_cast</font><font color='#5555FF'>&lt;</font>value_and_holder <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>h.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>return</font> <font color='#979000'>true</font>;
    <b>}</b>

    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font><font color='#5555FF'>&gt;</font> <font color='#0000FF'>using</font> cast_op_type <font color='#5555FF'>=</font> value_and_holder <font color='#5555FF'>&amp;</font>;
    <b><a name='operator'></a>operator</b> value_and_holder <font color='#5555FF'>&amp;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> <font color='#5555FF'>*</font>value; <b>}</b>
    <font color='#0000FF'>static</font> PYBIND11_DESCR <b><a name='name'></a>name</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> <font color='#BB00BB'>type_descr</font><font face='Lucida Console'>(</font>_<font color='#5555FF'>&lt;</font>value_and_holder<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>; <b>}</b>

<font color='#0000FF'>private</font>:
    value_and_holder <font color='#5555FF'>*</font>value <font color='#5555FF'>=</font> nullptr;
<b>}</b>;

<b><a name='NAMESPACE_BEGIN'></a>NAMESPACE_BEGIN</b><font face='Lucida Console'>(</font>initimpl<font face='Lucida Console'>)</font>

<font color='#0000FF'>inline</font> <font color='#0000FF'><u>void</u></font> <b><a name='no_nullptr'></a>no_nullptr</b><font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font>ptr<font face='Lucida Console'>)</font> <b>{</b>
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>ptr<font face='Lucida Console'>)</font> <font color='#0000FF'>throw</font> <font color='#BB00BB'>type_error</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>pybind11::init(): factory function returned nullptr</font>"<font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#009900'>// Implementing functions for all forms of py::init&lt;...&gt; and py::init(...)
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> Class<font color='#5555FF'>&gt;</font> <font color='#0000FF'>using</font> Cpp <font color='#5555FF'>=</font> <font color='#0000FF'>typename</font> Class::type;
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> Class<font color='#5555FF'>&gt;</font> <font color='#0000FF'>using</font> Alias <font color='#5555FF'>=</font> <font color='#0000FF'>typename</font> Class::type_alias;
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> Class<font color='#5555FF'>&gt;</font> <font color='#0000FF'>using</font> Holder <font color='#5555FF'>=</font> <font color='#0000FF'>typename</font> Class::holder_type;

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> Class<font color='#5555FF'>&gt;</font> <font color='#0000FF'>using</font> is_alias_constructible <font color='#5555FF'>=</font> std::is_constructible<font color='#5555FF'>&lt;</font>Alias<font color='#5555FF'>&lt;</font>Class<font color='#5555FF'>&gt;</font>, Cpp<font color='#5555FF'>&lt;</font>Class<font color='#5555FF'>&gt;</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font><font color='#5555FF'>&gt;</font>;

<font color='#009900'>// Takes a Cpp pointer and returns true if it actually is a polymorphic Alias instance.
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> Class, enable_if_t<font color='#5555FF'>&lt;</font>Class::has_alias, <font color='#0000FF'><u>int</u></font><font color='#5555FF'>&gt;</font> <font color='#5555FF'>=</font> <font color='#979000'>0</font><font color='#5555FF'>&gt;</font>
<font color='#0000FF'><u>bool</u></font> <b><a name='is_alias'></a>is_alias</b><font face='Lucida Console'>(</font>Cpp<font color='#5555FF'>&lt;</font>Class<font color='#5555FF'>&gt;</font> <font color='#5555FF'>*</font>ptr<font face='Lucida Console'>)</font> <b>{</b>
    <font color='#0000FF'>return</font> <font color='#0000FF'>dynamic_cast</font><font color='#5555FF'>&lt;</font>Alias<font color='#5555FF'>&lt;</font>Class<font color='#5555FF'>&gt;</font> <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>ptr<font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> nullptr;
<b>}</b>
<font color='#009900'>// Failing fallback version of the above for a no-alias class (always returns false)
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> <font color='#009900'>/*Class*/</font><font color='#5555FF'>&gt;</font>
constexpr <font color='#0000FF'><u>bool</u></font> <b><a name='is_alias'></a>is_alias</b><font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font><font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> <font color='#979000'>false</font>; <b>}</b>

<font color='#009900'>// Constructs and returns a new object; if the given arguments don't map to a constructor, we fall
</font><font color='#009900'>// back to brace aggregate initiailization so that for aggregate initialization can be used with
</font><font color='#009900'>// py::init, e.g.  `py::init&lt;int, int&gt;` to initialize a `struct T { int a; int b; }`.  For
</font><font color='#009900'>// non-aggregate types, we need to use an ordinary T(...) constructor (invoking as `T{...}` usually
</font><font color='#009900'>// works, but will not do the expected thing when `T` has an `initializer_list&lt;T&gt;` constructor).
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> Class, <font color='#0000FF'>typename</font>... Args, detail::enable_if_t<font color='#5555FF'>&lt;</font>std::is_constructible<font color='#5555FF'>&lt;</font>Class, Args...<font color='#5555FF'>&gt;</font>::value, <font color='#0000FF'><u>int</u></font><font color='#5555FF'>&gt;</font> <font color='#5555FF'>=</font> <font color='#979000'>0</font><font color='#5555FF'>&gt;</font>
<font color='#0000FF'>inline</font> Class <font color='#5555FF'>*</font><b><a name='construct_or_initialize'></a>construct_or_initialize</b><font face='Lucida Console'>(</font>Args <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>...args<font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> <font color='#0000FF'>new</font> <font color='#BB00BB'>Class</font><font face='Lucida Console'>(</font>std::forward<font color='#5555FF'>&lt;</font>Args<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>args<font face='Lucida Console'>)</font>...<font face='Lucida Console'>)</font>; <b>}</b>
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> Class, <font color='#0000FF'>typename</font>... Args, detail::enable_if_t<font color='#5555FF'>&lt;</font><font color='#5555FF'>!</font>std::is_constructible<font color='#5555FF'>&lt;</font>Class, Args...<font color='#5555FF'>&gt;</font>::value, <font color='#0000FF'><u>int</u></font><font color='#5555FF'>&gt;</font> <font color='#5555FF'>=</font> <font color='#979000'>0</font><font color='#5555FF'>&gt;</font>
<font color='#0000FF'>inline</font> Class <font color='#5555FF'>*</font><b><a name='construct_or_initialize'></a>construct_or_initialize</b><font face='Lucida Console'>(</font>Args <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>...args<font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> <font color='#0000FF'>new</font> Class<b>{</b>std::forward<font color='#5555FF'>&lt;</font>Args<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>args<font face='Lucida Console'>)</font>...<b>}</b>; <b>}</b>

<font color='#009900'>// Attempts to constructs an alias using a `Alias(Cpp &amp;&amp;)` constructor.  This allows types with
</font><font color='#009900'>// an alias to provide only a single Cpp factory function as long as the Alias can be
</font><font color='#009900'>// constructed from an rvalue reference of the base Cpp type.  This means that Alias classes
</font><font color='#009900'>// can, when appropriate, simply define a `Alias(Cpp &amp;&amp;)` constructor rather than needing to
</font><font color='#009900'>// inherit all the base class constructors.
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> Class<font color='#5555FF'>&gt;</font>
<font color='#0000FF'><u>void</u></font> <b><a name='construct_alias_from_cpp'></a>construct_alias_from_cpp</b><font face='Lucida Console'>(</font>std::true_type <font color='#009900'>/*is_alias_constructible*/</font>,
                              value_and_holder <font color='#5555FF'>&amp;</font>v_h, Cpp<font color='#5555FF'>&lt;</font>Class<font color='#5555FF'>&gt;</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>base<font face='Lucida Console'>)</font> <b>{</b>
    v_h.<font color='#BB00BB'>value_ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#0000FF'>new</font> Alias<font color='#5555FF'>&lt;</font>Class<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font>base<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
<b>}</b>
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> Class<font color='#5555FF'>&gt;</font>
[[noreturn]] <font color='#0000FF'><u>void</u></font> <b><a name='construct_alias_from_cpp'></a>construct_alias_from_cpp</b><font face='Lucida Console'>(</font>std::false_type <font color='#009900'>/*!is_alias_constructible*/</font>,
                                           value_and_holder <font color='#5555FF'>&amp;</font>, Cpp<font color='#5555FF'>&lt;</font>Class<font color='#5555FF'>&gt;</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font><font face='Lucida Console'>)</font> <b>{</b>
    <font color='#0000FF'>throw</font> <font color='#BB00BB'>type_error</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>pybind11::init(): unable to convert returned instance to required </font>"
                     "<font color='#CC0000'>alias class: no `Alias&lt;Class&gt;(Class &amp;&amp;)` constructor available</font>"<font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#009900'>// Error-generating fallback for factories that don't match one of the below construction
</font><font color='#009900'>// mechanisms.
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> Class<font color='#5555FF'>&gt;</font>
<font color='#0000FF'><u>void</u></font> <b><a name='construct'></a>construct</b><font face='Lucida Console'>(</font>...<font face='Lucida Console'>)</font> <b>{</b>
    <font color='#BB00BB'>static_assert</font><font face='Lucida Console'>(</font><font color='#5555FF'>!</font>std::is_same<font color='#5555FF'>&lt;</font>Class, Class<font color='#5555FF'>&gt;</font>::value <font color='#009900'>/* always false */</font>,
            "<font color='#CC0000'>pybind11::init(): init function must return a compatible pointer, </font>"
            "<font color='#CC0000'>holder, or value</font>"<font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#009900'>// Pointer return v1: the factory function returns a class pointer for a registered class.
</font><font color='#009900'>// If we don't need an alias (because this class doesn't have one, or because the final type is
</font><font color='#009900'>// inherited on the Python side) we can simply take over ownership.  Otherwise we need to try to
</font><font color='#009900'>// construct an Alias from the returned base instance.
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> Class<font color='#5555FF'>&gt;</font>
<font color='#0000FF'><u>void</u></font> <b><a name='construct'></a>construct</b><font face='Lucida Console'>(</font>value_and_holder <font color='#5555FF'>&amp;</font>v_h, Cpp<font color='#5555FF'>&lt;</font>Class<font color='#5555FF'>&gt;</font> <font color='#5555FF'>*</font>ptr, <font color='#0000FF'><u>bool</u></font> need_alias<font face='Lucida Console'>)</font> <b>{</b>
    <font color='#BB00BB'>no_nullptr</font><font face='Lucida Console'>(</font>ptr<font face='Lucida Console'>)</font>;
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>Class::has_alias <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> need_alias <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#5555FF'>!</font>is_alias<font color='#5555FF'>&lt;</font>Class<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>ptr<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#009900'>// We're going to try to construct an alias by moving the cpp type.  Whether or not
</font>        <font color='#009900'>// that succeeds, we still need to destroy the original cpp pointer (either the
</font>        <font color='#009900'>// moved away leftover, if the alias construction works, or the value itself if we
</font>        <font color='#009900'>// throw an error), but we can't just call `delete ptr`: it might have a special
</font>        <font color='#009900'>// deleter, or might be shared_from_this.  So we construct a holder around it as if
</font>        <font color='#009900'>// it was a normal instance, then steal the holder away into a local variable; thus
</font>        <font color='#009900'>// the holder and destruction happens when we leave the C++ scope, and the holder
</font>        <font color='#009900'>// class gets to handle the destruction however it likes.
</font>        v_h.<font color='#BB00BB'>value_ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> ptr;
        v_h.<font color='#BB00BB'>set_instance_registered</font><font face='Lucida Console'>(</font><font color='#979000'>true</font><font face='Lucida Console'>)</font>; <font color='#009900'>// To prevent init_instance from registering it
</font>        v_h.type<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font><font color='#BB00BB'>init_instance</font><font face='Lucida Console'>(</font>v_h.inst, nullptr<font face='Lucida Console'>)</font>; <font color='#009900'>// Set up the holder
</font>        Holder<font color='#5555FF'>&lt;</font>Class<font color='#5555FF'>&gt;</font> <font color='#BB00BB'>temp_holder</font><font face='Lucida Console'>(</font>std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font>v_h.holder<font color='#5555FF'>&lt;</font>Holder<font color='#5555FF'>&lt;</font>Class<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>; <font color='#009900'>// Steal the holder
</font>        v_h.type<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font><font color='#BB00BB'>dealloc</font><font face='Lucida Console'>(</font>v_h<font face='Lucida Console'>)</font>; <font color='#009900'>// Destroys the moved-out holder remains, resets value ptr to null
</font>        v_h.<font color='#BB00BB'>set_instance_registered</font><font face='Lucida Console'>(</font><font color='#979000'>false</font><font face='Lucida Console'>)</font>;

        construct_alias_from_cpp<font color='#5555FF'>&lt;</font>Class<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>is_alias_constructible<font color='#5555FF'>&lt;</font>Class<font color='#5555FF'>&gt;</font><b>{</b><b>}</b>, v_h, std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>ptr<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
    <b>}</b> <font color='#0000FF'>else</font> <b>{</b>
        <font color='#009900'>// Otherwise the type isn't inherited, so we don't need an Alias
</font>        v_h.<font color='#BB00BB'>value_ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> ptr;
    <b>}</b>
<b>}</b>

<font color='#009900'>// Pointer return v2: a factory that always returns an alias instance ptr.  We simply take over
</font><font color='#009900'>// ownership of the pointer.
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> Class, enable_if_t<font color='#5555FF'>&lt;</font>Class::has_alias, <font color='#0000FF'><u>int</u></font><font color='#5555FF'>&gt;</font> <font color='#5555FF'>=</font> <font color='#979000'>0</font><font color='#5555FF'>&gt;</font>
<font color='#0000FF'><u>void</u></font> <b><a name='construct'></a>construct</b><font face='Lucida Console'>(</font>value_and_holder <font color='#5555FF'>&amp;</font>v_h, Alias<font color='#5555FF'>&lt;</font>Class<font color='#5555FF'>&gt;</font> <font color='#5555FF'>*</font>alias_ptr, <font color='#0000FF'><u>bool</u></font><font face='Lucida Console'>)</font> <b>{</b>
    <font color='#BB00BB'>no_nullptr</font><font face='Lucida Console'>(</font>alias_ptr<font face='Lucida Console'>)</font>;
    v_h.<font color='#BB00BB'>value_ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#0000FF'>static_cast</font><font color='#5555FF'>&lt;</font>Cpp<font color='#5555FF'>&lt;</font>Class<font color='#5555FF'>&gt;</font> <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>alias_ptr<font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#009900'>// Holder return: copy its pointer, and move or copy the returned holder into the new instance's
</font><font color='#009900'>// holder.  This also handles types like std::shared_ptr&lt;T&gt; and std::unique_ptr&lt;T&gt; where T is a
</font><font color='#009900'>// derived type (through those holder's implicit conversion from derived class holder constructors).
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> Class<font color='#5555FF'>&gt;</font>
<font color='#0000FF'><u>void</u></font> <b><a name='construct'></a>construct</b><font face='Lucida Console'>(</font>value_and_holder <font color='#5555FF'>&amp;</font>v_h, Holder<font color='#5555FF'>&lt;</font>Class<font color='#5555FF'>&gt;</font> holder, <font color='#0000FF'><u>bool</u></font> need_alias<font face='Lucida Console'>)</font> <b>{</b>
    <font color='#0000FF'>auto</font> <font color='#5555FF'>*</font>ptr <font color='#5555FF'>=</font> holder_helper<font color='#5555FF'>&lt;</font>Holder<font color='#5555FF'>&lt;</font>Class<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>::<font color='#BB00BB'>get</font><font face='Lucida Console'>(</font>holder<font face='Lucida Console'>)</font>;
    <font color='#009900'>// If we need an alias, check that the held pointer is actually an alias instance
</font>    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>Class::has_alias <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> need_alias <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#5555FF'>!</font>is_alias<font color='#5555FF'>&lt;</font>Class<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>ptr<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
        <font color='#0000FF'>throw</font> <font color='#BB00BB'>type_error</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>pybind11::init(): construction failed: returned holder-wrapped instance </font>"
                         "<font color='#CC0000'>is not an alias instance</font>"<font face='Lucida Console'>)</font>;

    v_h.<font color='#BB00BB'>value_ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> ptr;
    v_h.type<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font><font color='#BB00BB'>init_instance</font><font face='Lucida Console'>(</font>v_h.inst, <font color='#5555FF'>&amp;</font>holder<font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#009900'>// return-by-value version 1: returning a cpp class by value.  If the class has an alias and an
</font><font color='#009900'>// alias is required the alias must have an `Alias(Cpp &amp;&amp;)` constructor so that we can construct
</font><font color='#009900'>// the alias from the base when needed (i.e. because of Python-side inheritance).  When we don't
</font><font color='#009900'>// need it, we simply move-construct the cpp value into a new instance.
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> Class<font color='#5555FF'>&gt;</font>
<font color='#0000FF'><u>void</u></font> <b><a name='construct'></a>construct</b><font face='Lucida Console'>(</font>value_and_holder <font color='#5555FF'>&amp;</font>v_h, Cpp<font color='#5555FF'>&lt;</font>Class<font color='#5555FF'>&gt;</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>result, <font color='#0000FF'><u>bool</u></font> need_alias<font face='Lucida Console'>)</font> <b>{</b>
    <font color='#BB00BB'>static_assert</font><font face='Lucida Console'>(</font>std::is_move_constructible<font color='#5555FF'>&lt;</font>Cpp<font color='#5555FF'>&lt;</font>Class<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>::value,
        "<font color='#CC0000'>pybind11::init() return-by-value factory function requires a movable class</font>"<font face='Lucida Console'>)</font>;
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>Class::has_alias <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> need_alias<font face='Lucida Console'>)</font>
        construct_alias_from_cpp<font color='#5555FF'>&lt;</font>Class<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>is_alias_constructible<font color='#5555FF'>&lt;</font>Class<font color='#5555FF'>&gt;</font><b>{</b><b>}</b>, v_h, std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font>result<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
    <font color='#0000FF'>else</font>
        v_h.<font color='#BB00BB'>value_ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#0000FF'>new</font> Cpp<font color='#5555FF'>&lt;</font>Class<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font>result<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#009900'>// return-by-value version 2: returning a value of the alias type itself.  We move-construct an
</font><font color='#009900'>// Alias instance (even if no the python-side inheritance is involved).  The is intended for
</font><font color='#009900'>// cases where Alias initialization is always desired.
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> Class<font color='#5555FF'>&gt;</font>
<font color='#0000FF'><u>void</u></font> <b><a name='construct'></a>construct</b><font face='Lucida Console'>(</font>value_and_holder <font color='#5555FF'>&amp;</font>v_h, Alias<font color='#5555FF'>&lt;</font>Class<font color='#5555FF'>&gt;</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>result, <font color='#0000FF'><u>bool</u></font><font face='Lucida Console'>)</font> <b>{</b>
    <font color='#BB00BB'>static_assert</font><font face='Lucida Console'>(</font>std::is_move_constructible<font color='#5555FF'>&lt;</font>Alias<font color='#5555FF'>&lt;</font>Class<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>::value,
        "<font color='#CC0000'>pybind11::init() return-by-alias-value factory function requires a movable alias class</font>"<font face='Lucida Console'>)</font>;
    v_h.<font color='#BB00BB'>value_ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#0000FF'>new</font> Alias<font color='#5555FF'>&lt;</font>Class<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font>result<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#009900'>// Implementing class for py::init&lt;...&gt;()
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font>... Args<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>struct</font> <b><a name='constructor'></a>constructor</b> <b>{</b>
    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> Class, <font color='#0000FF'>typename</font>... Extra, enable_if_t<font color='#5555FF'>&lt;</font><font color='#5555FF'>!</font>Class::has_alias, <font color='#0000FF'><u>int</u></font><font color='#5555FF'>&gt;</font> <font color='#5555FF'>=</font> <font color='#979000'>0</font><font color='#5555FF'>&gt;</font>
    <font color='#0000FF'>static</font> <font color='#0000FF'><u>void</u></font> <b><a name='execute'></a>execute</b><font face='Lucida Console'>(</font>Class <font color='#5555FF'>&amp;</font>cl, <font color='#0000FF'>const</font> Extra<font color='#5555FF'>&amp;</font>... extra<font face='Lucida Console'>)</font> <b>{</b>
        cl.<font color='#BB00BB'>def</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>__init__</font>", []<font face='Lucida Console'>(</font>value_and_holder <font color='#5555FF'>&amp;</font>v_h, Args... args<font face='Lucida Console'>)</font> <b>{</b>
            v_h.<font color='#BB00BB'>value_ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> construct_or_initialize<font color='#5555FF'>&lt;</font>Cpp<font color='#5555FF'>&lt;</font>Class<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>std::forward<font color='#5555FF'>&lt;</font>Args<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>args<font face='Lucida Console'>)</font>...<font face='Lucida Console'>)</font>;
        <b>}</b>, <font color='#BB00BB'>is_new_style_constructor</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, extra...<font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> Class, <font color='#0000FF'>typename</font>... Extra,
              enable_if_t<font color='#5555FF'>&lt;</font>Class::has_alias <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                          std::is_constructible<font color='#5555FF'>&lt;</font>Cpp<font color='#5555FF'>&lt;</font>Class<font color='#5555FF'>&gt;</font>, Args...<font color='#5555FF'>&gt;</font>::value, <font color='#0000FF'><u>int</u></font><font color='#5555FF'>&gt;</font> <font color='#5555FF'>=</font> <font color='#979000'>0</font><font color='#5555FF'>&gt;</font>
    <font color='#0000FF'>static</font> <font color='#0000FF'><u>void</u></font> <b><a name='execute'></a>execute</b><font face='Lucida Console'>(</font>Class <font color='#5555FF'>&amp;</font>cl, <font color='#0000FF'>const</font> Extra<font color='#5555FF'>&amp;</font>... extra<font face='Lucida Console'>)</font> <b>{</b>
        cl.<font color='#BB00BB'>def</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>__init__</font>", []<font face='Lucida Console'>(</font>value_and_holder <font color='#5555FF'>&amp;</font>v_h, Args... args<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>Py_TYPE</font><font face='Lucida Console'>(</font>v_h.inst<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> v_h.type<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>type<font face='Lucida Console'>)</font>
                v_h.<font color='#BB00BB'>value_ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> construct_or_initialize<font color='#5555FF'>&lt;</font>Cpp<font color='#5555FF'>&lt;</font>Class<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>std::forward<font color='#5555FF'>&lt;</font>Args<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>args<font face='Lucida Console'>)</font>...<font face='Lucida Console'>)</font>;
            <font color='#0000FF'>else</font>
                v_h.<font color='#BB00BB'>value_ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> construct_or_initialize<font color='#5555FF'>&lt;</font>Alias<font color='#5555FF'>&lt;</font>Class<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>std::forward<font color='#5555FF'>&lt;</font>Args<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>args<font face='Lucida Console'>)</font>...<font face='Lucida Console'>)</font>;
        <b>}</b>, <font color='#BB00BB'>is_new_style_constructor</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, extra...<font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> Class, <font color='#0000FF'>typename</font>... Extra,
              enable_if_t<font color='#5555FF'>&lt;</font>Class::has_alias <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                          <font color='#5555FF'>!</font>std::is_constructible<font color='#5555FF'>&lt;</font>Cpp<font color='#5555FF'>&lt;</font>Class<font color='#5555FF'>&gt;</font>, Args...<font color='#5555FF'>&gt;</font>::value, <font color='#0000FF'><u>int</u></font><font color='#5555FF'>&gt;</font> <font color='#5555FF'>=</font> <font color='#979000'>0</font><font color='#5555FF'>&gt;</font>
    <font color='#0000FF'>static</font> <font color='#0000FF'><u>void</u></font> <b><a name='execute'></a>execute</b><font face='Lucida Console'>(</font>Class <font color='#5555FF'>&amp;</font>cl, <font color='#0000FF'>const</font> Extra<font color='#5555FF'>&amp;</font>... extra<font face='Lucida Console'>)</font> <b>{</b>
        cl.<font color='#BB00BB'>def</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>__init__</font>", []<font face='Lucida Console'>(</font>value_and_holder <font color='#5555FF'>&amp;</font>v_h, Args... args<font face='Lucida Console'>)</font> <b>{</b>
            v_h.<font color='#BB00BB'>value_ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> construct_or_initialize<font color='#5555FF'>&lt;</font>Alias<font color='#5555FF'>&lt;</font>Class<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>std::forward<font color='#5555FF'>&lt;</font>Args<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>args<font face='Lucida Console'>)</font>...<font face='Lucida Console'>)</font>;
        <b>}</b>, <font color='#BB00BB'>is_new_style_constructor</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, extra...<font face='Lucida Console'>)</font>;
    <b>}</b>
<b>}</b>;

<font color='#009900'>// Implementing class for py::init_alias&lt;...&gt;()
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font>... Args<font color='#5555FF'>&gt;</font> <font color='#0000FF'>struct</font> <b><a name='alias_constructor'></a>alias_constructor</b> <b>{</b>
    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> Class, <font color='#0000FF'>typename</font>... Extra,
              enable_if_t<font color='#5555FF'>&lt;</font>Class::has_alias <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> std::is_constructible<font color='#5555FF'>&lt;</font>Alias<font color='#5555FF'>&lt;</font>Class<font color='#5555FF'>&gt;</font>, Args...<font color='#5555FF'>&gt;</font>::value, <font color='#0000FF'><u>int</u></font><font color='#5555FF'>&gt;</font> <font color='#5555FF'>=</font> <font color='#979000'>0</font><font color='#5555FF'>&gt;</font>
    <font color='#0000FF'>static</font> <font color='#0000FF'><u>void</u></font> <b><a name='execute'></a>execute</b><font face='Lucida Console'>(</font>Class <font color='#5555FF'>&amp;</font>cl, <font color='#0000FF'>const</font> Extra<font color='#5555FF'>&amp;</font>... extra<font face='Lucida Console'>)</font> <b>{</b>
        cl.<font color='#BB00BB'>def</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>__init__</font>", []<font face='Lucida Console'>(</font>value_and_holder <font color='#5555FF'>&amp;</font>v_h, Args... args<font face='Lucida Console'>)</font> <b>{</b>
            v_h.<font color='#BB00BB'>value_ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> construct_or_initialize<font color='#5555FF'>&lt;</font>Alias<font color='#5555FF'>&lt;</font>Class<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>std::forward<font color='#5555FF'>&lt;</font>Args<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>args<font face='Lucida Console'>)</font>...<font face='Lucida Console'>)</font>;
        <b>}</b>, <font color='#BB00BB'>is_new_style_constructor</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, extra...<font face='Lucida Console'>)</font>;
    <b>}</b>
<b>}</b>;

<font color='#009900'>// Implementation class for py::init(Func) and py::init(Func, AliasFunc)
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> CFunc, <font color='#0000FF'>typename</font> AFunc <font color='#5555FF'>=</font> <b><a name='void_type'></a>void_type</b> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>,
          <font color='#0000FF'>typename</font> <font color='#5555FF'>=</font> function_signature_t<font color='#5555FF'>&lt;</font>CFunc<font color='#5555FF'>&gt;</font>, <font color='#0000FF'>typename</font> <font color='#5555FF'>=</font> function_signature_t<font color='#5555FF'>&lt;</font>AFunc<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
<font color='#0000FF'>struct</font> factory;

<font color='#009900'>// Specialization for py::init(Func)
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> Func, <font color='#0000FF'>typename</font> Return, <font color='#0000FF'>typename</font>... Args<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>struct</font> <b><a name='factory'></a>factory</b><font color='#5555FF'>&lt;</font>Func, <b><a name='void_type'></a>void_type</b> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, <b><a name='Return'></a>Return</b><font face='Lucida Console'>(</font>Args...<font face='Lucida Console'>)</font><font color='#5555FF'>&gt;</font> <b>{</b>
    remove_reference_t<font color='#5555FF'>&lt;</font>Func<font color='#5555FF'>&gt;</font> class_factory;

    <font color='#BB00BB'>factory</font><font face='Lucida Console'>(</font>Func <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>f<font face='Lucida Console'>)</font> : <font color='#BB00BB'>class_factory</font><font face='Lucida Console'>(</font>std::forward<font color='#5555FF'>&lt;</font>Func<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>f<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b> <b>}</b>

    <font color='#009900'>// The given class either has no alias or has no separate alias factory;
</font>    <font color='#009900'>// this always constructs the class itself.  If the class is registered with an alias
</font>    <font color='#009900'>// type and an alias instance is needed (i.e. because the final type is a Python class
</font>    <font color='#009900'>// inheriting from the C++ type) the returned value needs to either already be an alias
</font>    <font color='#009900'>// instance, or the alias needs to be constructible from a `Class &amp;&amp;` argument.
</font>    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> Class, <font color='#0000FF'>typename</font>... Extra<font color='#5555FF'>&gt;</font>
    <font color='#0000FF'><u>void</u></font> <font color='#BB00BB'>execute</font><font face='Lucida Console'>(</font>Class <font color='#5555FF'>&amp;</font>cl, <font color='#0000FF'>const</font> Extra <font color='#5555FF'>&amp;</font>...extra<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <b>{</b>
        <font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>PYBIND11_CPP14<font face='Lucida Console'>)</font>
        cl.<font color='#BB00BB'>def</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>__init__</font>", [func <font color='#5555FF'>=</font> std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font>class_factory<font face='Lucida Console'>)</font>]
        <font color='#0000FF'>#else</font>
        <font color='#0000FF'>auto</font> <font color='#5555FF'>&amp;</font>func <font color='#5555FF'>=</font> class_factory;
        cl.<font color='#BB00BB'>def</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>__init__</font>", [func]
        <font color='#0000FF'>#endif</font>
        <font face='Lucida Console'>(</font>value_and_holder <font color='#5555FF'>&amp;</font>v_h, Args... args<font face='Lucida Console'>)</font> <b>{</b>
            construct<font color='#5555FF'>&lt;</font>Class<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>v_h, <font color='#BB00BB'>func</font><font face='Lucida Console'>(</font>std::forward<font color='#5555FF'>&lt;</font>Args<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>args<font face='Lucida Console'>)</font>...<font face='Lucida Console'>)</font>,
                             <font color='#BB00BB'>Py_TYPE</font><font face='Lucida Console'>(</font>v_h.inst<font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> v_h.type<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>type<font face='Lucida Console'>)</font>;
        <b>}</b>, <font color='#BB00BB'>is_new_style_constructor</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, extra...<font face='Lucida Console'>)</font>;
    <b>}</b>
<b>}</b>;

<font color='#009900'>// Specialization for py::init(Func, AliasFunc)
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> CFunc, <font color='#0000FF'>typename</font> AFunc,
          <font color='#0000FF'>typename</font> CReturn, <font color='#0000FF'>typename</font>... CArgs, <font color='#0000FF'>typename</font> AReturn, <font color='#0000FF'>typename</font>... AArgs<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>struct</font> <b><a name='factory'></a>factory</b><font color='#5555FF'>&lt;</font>CFunc, AFunc, <font color='#BB00BB'>CReturn</font><font face='Lucida Console'>(</font>CArgs...<font face='Lucida Console'>)</font>, <font color='#BB00BB'>AReturn</font><font face='Lucida Console'>(</font>AArgs...<font face='Lucida Console'>)</font><font color='#5555FF'>&gt;</font> <b>{</b>
    <font color='#BB00BB'>static_assert</font><font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font>...<font face='Lucida Console'>(</font>CArgs<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#0000FF'>sizeof</font>...<font face='Lucida Console'>(</font>AArgs<font face='Lucida Console'>)</font>,
                  "<font color='#CC0000'>pybind11::init(class_factory, alias_factory): class and alias factories </font>"
                  "<font color='#CC0000'>must have identical argument signatures</font>"<font face='Lucida Console'>)</font>;
    <font color='#BB00BB'>static_assert</font><font face='Lucida Console'>(</font>all_of<font color='#5555FF'>&lt;</font>std::is_same<font color='#5555FF'>&lt;</font>CArgs, AArgs<font color='#5555FF'>&gt;</font>...<font color='#5555FF'>&gt;</font>::value,
                  "<font color='#CC0000'>pybind11::init(class_factory, alias_factory): class and alias factories </font>"
                  "<font color='#CC0000'>must have identical argument signatures</font>"<font face='Lucida Console'>)</font>;

    remove_reference_t<font color='#5555FF'>&lt;</font>CFunc<font color='#5555FF'>&gt;</font> class_factory;
    remove_reference_t<font color='#5555FF'>&lt;</font>AFunc<font color='#5555FF'>&gt;</font> alias_factory;

    <font color='#BB00BB'>factory</font><font face='Lucida Console'>(</font>CFunc <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>c, AFunc <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>a<font face='Lucida Console'>)</font>
        : <font color='#BB00BB'>class_factory</font><font face='Lucida Console'>(</font>std::forward<font color='#5555FF'>&lt;</font>CFunc<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>c<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>, <font color='#BB00BB'>alias_factory</font><font face='Lucida Console'>(</font>std::forward<font color='#5555FF'>&lt;</font>AFunc<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>a<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b> <b>}</b>

    <font color='#009900'>// The class factory is called when the `self` type passed to `__init__` is the direct
</font>    <font color='#009900'>// class (i.e. not inherited), the alias factory when `self` is a Python-side subtype.
</font>    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> Class, <font color='#0000FF'>typename</font>... Extra<font color='#5555FF'>&gt;</font>
    <font color='#0000FF'><u>void</u></font> <font color='#BB00BB'>execute</font><font face='Lucida Console'>(</font>Class <font color='#5555FF'>&amp;</font>cl, <font color='#0000FF'>const</font> Extra<font color='#5555FF'>&amp;</font>... extra<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <b>{</b>
        <font color='#BB00BB'>static_assert</font><font face='Lucida Console'>(</font>Class::has_alias, "<font color='#CC0000'>The two-argument version of `py::init()` can </font>"
                                        "<font color='#CC0000'>only be used if the class has an alias</font>"<font face='Lucida Console'>)</font>;
        <font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>PYBIND11_CPP14<font face='Lucida Console'>)</font>
        cl.<font color='#BB00BB'>def</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>__init__</font>", [class_func <font color='#5555FF'>=</font> std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font>class_factory<font face='Lucida Console'>)</font>, alias_func <font color='#5555FF'>=</font> std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font>alias_factory<font face='Lucida Console'>)</font>]
        <font color='#0000FF'>#else</font>
        <font color='#0000FF'>auto</font> <font color='#5555FF'>&amp;</font>class_func <font color='#5555FF'>=</font> class_factory;
        <font color='#0000FF'>auto</font> <font color='#5555FF'>&amp;</font>alias_func <font color='#5555FF'>=</font> alias_factory;
        cl.<font color='#BB00BB'>def</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>__init__</font>", [class_func, alias_func]
        <font color='#0000FF'>#endif</font>
        <font face='Lucida Console'>(</font>value_and_holder <font color='#5555FF'>&amp;</font>v_h, CArgs... args<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>Py_TYPE</font><font face='Lucida Console'>(</font>v_h.inst<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> v_h.type<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>type<font face='Lucida Console'>)</font>
                <font color='#009900'>// If the instance type equals the registered type we don't have inheritance, so
</font>                <font color='#009900'>// don't need the alias and can construct using the class function:
</font>                construct<font color='#5555FF'>&lt;</font>Class<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>v_h, <font color='#BB00BB'>class_func</font><font face='Lucida Console'>(</font>std::forward<font color='#5555FF'>&lt;</font>CArgs<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>args<font face='Lucida Console'>)</font>...<font face='Lucida Console'>)</font>, <font color='#979000'>false</font><font face='Lucida Console'>)</font>;
            <font color='#0000FF'>else</font>
                construct<font color='#5555FF'>&lt;</font>Class<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>v_h, <font color='#BB00BB'>alias_func</font><font face='Lucida Console'>(</font>std::forward<font color='#5555FF'>&lt;</font>CArgs<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>args<font face='Lucida Console'>)</font>...<font face='Lucida Console'>)</font>, <font color='#979000'>true</font><font face='Lucida Console'>)</font>;
        <b>}</b>, <font color='#BB00BB'>is_new_style_constructor</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, extra...<font face='Lucida Console'>)</font>;
    <b>}</b>
<b>}</b>;

<font color='#009900'>/// Set just the C++ state. Same as `__init__`.
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> Class, <font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font>
<font color='#0000FF'><u>void</u></font> <font color='#BB00BB'>setstate</font><font face='Lucida Console'>(</font>value_and_holder <font color='#5555FF'>&amp;</font>v_h, T <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>result, <font color='#0000FF'><u>bool</u></font> need_alias<font face='Lucida Console'>)</font> <b>{</b>
    construct<font color='#5555FF'>&lt;</font>Class<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>v_h, std::forward<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>result<font face='Lucida Console'>)</font>, need_alias<font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#009900'>/// Set both the C++ and Python states
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> Class, <font color='#0000FF'>typename</font> T, <font color='#0000FF'>typename</font> O,
          enable_if_t<font color='#5555FF'>&lt;</font>std::is_convertible<font color='#5555FF'>&lt;</font>O, handle<font color='#5555FF'>&gt;</font>::value, <font color='#0000FF'><u>int</u></font><font color='#5555FF'>&gt;</font> <font color='#5555FF'>=</font> <font color='#979000'>0</font><font color='#5555FF'>&gt;</font>
<font color='#0000FF'><u>void</u></font> <font color='#BB00BB'>setstate</font><font face='Lucida Console'>(</font>value_and_holder <font color='#5555FF'>&amp;</font>v_h, std::pair<font color='#5555FF'>&lt;</font>T, O<font color='#5555FF'>&gt;</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>result, <font color='#0000FF'><u>bool</u></font> need_alias<font face='Lucida Console'>)</font> <b>{</b>
    construct<font color='#5555FF'>&lt;</font>Class<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>v_h, std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font>result.first<font face='Lucida Console'>)</font>, need_alias<font face='Lucida Console'>)</font>;
    <font color='#BB00BB'>setattr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>PyObject <font color='#5555FF'>*</font><font face='Lucida Console'>)</font> v_h.inst, "<font color='#CC0000'>__dict__</font>", result.second<font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#009900'>/// Implementation for py::pickle(GetState, SetState)
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> Get, <font color='#0000FF'>typename</font> Set,
          <font color='#0000FF'>typename</font> <font color='#5555FF'>=</font> function_signature_t<font color='#5555FF'>&lt;</font>Get<font color='#5555FF'>&gt;</font>, <font color='#0000FF'>typename</font> <font color='#5555FF'>=</font> function_signature_t<font color='#5555FF'>&lt;</font>Set<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
<font color='#0000FF'>struct</font> pickle_factory;

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> Get, <font color='#0000FF'>typename</font> Set,
          <font color='#0000FF'>typename</font> RetState, <font color='#0000FF'>typename</font> Self, <font color='#0000FF'>typename</font> NewInstance, <font color='#0000FF'>typename</font> ArgState<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>struct</font> <b><a name='pickle_factory'></a>pickle_factory</b><font color='#5555FF'>&lt;</font>Get, Set, <font color='#BB00BB'>RetState</font><font face='Lucida Console'>(</font>Self<font face='Lucida Console'>)</font>, <font color='#BB00BB'>NewInstance</font><font face='Lucida Console'>(</font>ArgState<font face='Lucida Console'>)</font><font color='#5555FF'>&gt;</font> <b>{</b>
    <font color='#BB00BB'>static_assert</font><font face='Lucida Console'>(</font>std::is_same<font color='#5555FF'>&lt;</font>intrinsic_t<font color='#5555FF'>&lt;</font>RetState<font color='#5555FF'>&gt;</font>, intrinsic_t<font color='#5555FF'>&lt;</font>ArgState<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>::value,
                  "<font color='#CC0000'>The type returned by `__getstate__` must be the same </font>"
                  "<font color='#CC0000'>as the argument accepted by `__setstate__`</font>"<font face='Lucida Console'>)</font>;

    remove_reference_t<font color='#5555FF'>&lt;</font>Get<font color='#5555FF'>&gt;</font> get;
    remove_reference_t<font color='#5555FF'>&lt;</font>Set<font color='#5555FF'>&gt;</font> set;

    <font color='#BB00BB'>pickle_factory</font><font face='Lucida Console'>(</font>Get get, Set set<font face='Lucida Console'>)</font>
        : <font color='#BB00BB'>get</font><font face='Lucida Console'>(</font>std::forward<font color='#5555FF'>&lt;</font>Get<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>get<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>, <font color='#BB00BB'>set</font><font face='Lucida Console'>(</font>std::forward<font color='#5555FF'>&lt;</font>Set<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>set<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b> <b>}</b>

    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> Class, <font color='#0000FF'>typename</font>... Extra<font color='#5555FF'>&gt;</font>
    <font color='#0000FF'><u>void</u></font> <font color='#BB00BB'>execute</font><font face='Lucida Console'>(</font>Class <font color='#5555FF'>&amp;</font>cl, <font color='#0000FF'>const</font> Extra <font color='#5555FF'>&amp;</font>...extra<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <b>{</b>
        cl.<font color='#BB00BB'>def</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>__getstate__</font>", std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font>get<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>PYBIND11_CPP14<font face='Lucida Console'>)</font>
        cl.<font color='#BB00BB'>def</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>__setstate__</font>", [func <font color='#5555FF'>=</font> std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font>set<font face='Lucida Console'>)</font>]
<font color='#0000FF'>#else</font>
        <font color='#0000FF'>auto</font> <font color='#5555FF'>&amp;</font>func <font color='#5555FF'>=</font> set;
        cl.<font color='#BB00BB'>def</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>__setstate__</font>", [func]
<font color='#0000FF'>#endif</font>
        <font face='Lucida Console'>(</font>value_and_holder <font color='#5555FF'>&amp;</font>v_h, ArgState state<font face='Lucida Console'>)</font> <b>{</b>
            setstate<font color='#5555FF'>&lt;</font>Class<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>v_h, <font color='#BB00BB'>func</font><font face='Lucida Console'>(</font>std::forward<font color='#5555FF'>&lt;</font>ArgState<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>state<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>,
                            <font color='#BB00BB'>Py_TYPE</font><font face='Lucida Console'>(</font>v_h.inst<font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> v_h.type<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>type<font face='Lucida Console'>)</font>;
        <b>}</b>, <font color='#BB00BB'>is_new_style_constructor</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, extra...<font face='Lucida Console'>)</font>;
    <b>}</b>
<b>}</b>;

<font color='#BB00BB'>NAMESPACE_END</font><font face='Lucida Console'>(</font>initimpl<font face='Lucida Console'>)</font>
<font color='#BB00BB'>NAMESPACE_END</font><font face='Lucida Console'>(</font>detail<font face='Lucida Console'>)</font>
<font color='#BB00BB'>NAMESPACE_END</font><font face='Lucida Console'>(</font>pybind11<font face='Lucida Console'>)</font>

</pre></body></html>