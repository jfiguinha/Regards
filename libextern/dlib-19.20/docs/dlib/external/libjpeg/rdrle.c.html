<html><!-- Created using the cpp_pretty_printer from the dlib C++ library.  See http://dlib.net for updates. --><head><title>dlib C++ Library - rdrle.c</title></head><body bgcolor='white'><pre>
<font color='#009900'>/*
 * rdrle.c
 *
 * Copyright (C) 1991-1996, Thomas G. Lane.
 * This file is part of the Independent JPEG Group's software.
 * For conditions of distribution and use, see the accompanying README file.
 *
 * This file contains routines to read input images in Utah RLE format.
 * The Utah Raster Toolkit library is required (version 3.1 or later).
 *
 * These routines may need modification for non-Unix environments or
 * specialized applications.  As they stand, they assume input from
 * an ordinary stdio stream.  They further assume that reading begins
 * at the start of the file; start_input may need work if the
 * user interface has already read some data (e.g., to determine that
 * the file is indeed RLE format).
 *
 * Based on code contributed by Mike Lijewski,
 * with updates from Robert Hutchinson.
 */</font>

<font color='#0000FF'>#include</font> "<a style='text-decoration:none' href='cdjpeg.h.html'>cdjpeg.h</a>"		<font color='#009900'>/* Common decls for cjpeg/djpeg applications */</font>

<font color='#0000FF'>#ifdef</font> RLE_SUPPORTED

<font color='#009900'>/* rle.h is provided by the Utah Raster Toolkit. */</font>

<font color='#0000FF'>#include</font> <font color='#5555FF'>&lt;</font>rle.h<font color='#5555FF'>&gt;</font>

<font color='#009900'>/*
 * We assume that JSAMPLE has the same representation as rle_pixel,
 * to wit, "unsigned char".  Hence we can't cope with 12- or 16-bit samples.
 */</font>

<font color='#0000FF'>#if</font> BITS_IN_JSAMPLE <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>8</font>
  Sorry, <font color='#0000FF'>this</font> code only copes with <font color='#979000'>8</font><font color='#5555FF'>-</font>bit JSAMPLEs. <font color='#009900'>/* deliberate syntax err */</font>
<font color='#0000FF'>#endif</font>

<font color='#009900'>/*
 * We support the following types of RLE files:
 *   
 *   GRAYSCALE   - 8 bits, no colormap
 *   MAPPEDGRAY  - 8 bits, 1 channel colomap
 *   PSEUDOCOLOR - 8 bits, 3 channel colormap
 *   TRUECOLOR   - 24 bits, 3 channel colormap
 *   DIRECTCOLOR - 24 bits, no colormap
 *
 * For now, we ignore any alpha channel in the image.
 */</font>

<font color='#0000FF'>typedef</font> <font color='#0000FF'>enum</font>
  <b>{</b> GRAYSCALE, MAPPEDGRAY, PSEUDOCOLOR, TRUECOLOR, DIRECTCOLOR <b>}</b> rle_kind;


<font color='#009900'>/*
 * Since RLE stores scanlines bottom-to-top, we have to invert the image
 * to conform to JPEG's top-to-bottom order.  To do this, we read the
 * incoming image into a virtual array on the first get_pixel_rows call,
 * then fetch the required row from the virtual array on subsequent calls.
 */</font>

<font color='#0000FF'>typedef</font> <font color='#0000FF'>struct</font> _rle_source_struct <font color='#5555FF'>*</font> rle_source_ptr;

<font color='#0000FF'>typedef</font> <font color='#0000FF'>struct</font> <b><a name='_rle_source_struct'></a>_rle_source_struct</b> <b>{</b>
  <font color='#0000FF'>struct</font> cjpeg_source_struct pub; <font color='#009900'>/* public fields */</font>

  rle_kind visual;              <font color='#009900'>/* actual type of input file */</font>
  jvirt_sarray_ptr image;       <font color='#009900'>/* virtual array to hold the image */</font>
  JDIMENSION row;		<font color='#009900'>/* current row # in the virtual array */</font>
  rle_hdr header;               <font color='#009900'>/* Input file information */</font>
  rle_pixel<font color='#5555FF'>*</font><font color='#5555FF'>*</font> rle_row;          <font color='#009900'>/* holds a row returned by rle_getrow() */</font>

<b>}</b> rle_source_struct;


<font color='#009900'>/*
 * Read the file header; return image size and component count.
 */</font>

<b><a name='METHODDEF'></a>METHODDEF</b><font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font><font face='Lucida Console'>)</font>
<b><a name='start_input_rle'></a>start_input_rle</b> <font face='Lucida Console'>(</font>j_compress_ptr cinfo, cjpeg_source_ptr sinfo<font face='Lucida Console'>)</font>
<b>{</b>
  rle_source_ptr source <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>rle_source_ptr<font face='Lucida Console'>)</font> sinfo;
  JDIMENSION width, height;
<font color='#0000FF'>#ifdef</font> PROGRESS_REPORT
  cd_progress_ptr progress <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>cd_progress_ptr<font face='Lucida Console'>)</font> cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>progress;
<font color='#0000FF'>#endif</font>

  <font color='#009900'>/* Use RLE library routine to get the header info */</font>
  source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>header <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font color='#BB00BB'>rle_hdr_init</font><font face='Lucida Console'>(</font>NULL<font face='Lucida Console'>)</font>;
  source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>header.rle_file <font color='#5555FF'>=</font> source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.input_file;
  <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>rle_get_setup</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font><font face='Lucida Console'>(</font>source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>header<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
  <font color='#0000FF'>case</font> RLE_SUCCESS:
    <font color='#009900'>/* A-OK */</font>
    <font color='#0000FF'>break</font>;
  <font color='#0000FF'>case</font> RLE_NOT_RLE:
    <font color='#BB00BB'>ERREXIT</font><font face='Lucida Console'>(</font>cinfo, JERR_RLE_NOT<font face='Lucida Console'>)</font>;
    <font color='#0000FF'>break</font>;
  <font color='#0000FF'>case</font> RLE_NO_SPACE:
    <font color='#BB00BB'>ERREXIT</font><font face='Lucida Console'>(</font>cinfo, JERR_RLE_MEM<font face='Lucida Console'>)</font>;
    <font color='#0000FF'>break</font>;
  <font color='#0000FF'>case</font> RLE_EMPTY:
    <font color='#BB00BB'>ERREXIT</font><font face='Lucida Console'>(</font>cinfo, JERR_RLE_EMPTY<font face='Lucida Console'>)</font>;
    <font color='#0000FF'>break</font>;
  <font color='#0000FF'>case</font> RLE_EOF:
    <font color='#BB00BB'>ERREXIT</font><font face='Lucida Console'>(</font>cinfo, JERR_RLE_EOF<font face='Lucida Console'>)</font>;
    <font color='#0000FF'>break</font>;
  <font color='#0000FF'>default</font>:
    <font color='#BB00BB'>ERREXIT</font><font face='Lucida Console'>(</font>cinfo, JERR_RLE_BADERROR<font face='Lucida Console'>)</font>;
    <font color='#0000FF'>break</font>;
  <b>}</b>

  <font color='#009900'>/* Figure out what we have, set private vars and return values accordingly */</font>
  
  width  <font color='#5555FF'>=</font> source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>header.xmax <font color='#5555FF'>-</font> source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>header.xmin <font color='#5555FF'>+</font> <font color='#979000'>1</font>;
  height <font color='#5555FF'>=</font> source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>header.ymax <font color='#5555FF'>-</font> source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>header.ymin <font color='#5555FF'>+</font> <font color='#979000'>1</font>;
  source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>header.xmin <font color='#5555FF'>=</font> <font color='#979000'>0</font>;		<font color='#009900'>/* realign horizontally */</font>
  source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>header.xmax <font color='#5555FF'>=</font> width<font color='#5555FF'>-</font><font color='#979000'>1</font>;

  cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>image_width      <font color='#5555FF'>=</font> width;
  cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>image_height     <font color='#5555FF'>=</font> height;
  cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>data_precision   <font color='#5555FF'>=</font> <font color='#979000'>8</font>;  <font color='#009900'>/* we can only handle 8 bit data */</font>

  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>header.ncolors <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>1</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>header.ncmap <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <b>{</b>
    source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>visual     <font color='#5555FF'>=</font> GRAYSCALE;
    <font color='#BB00BB'>TRACEMS2</font><font face='Lucida Console'>(</font>cinfo, <font color='#979000'>1</font>, JTRC_RLE_GRAY, width, height<font face='Lucida Console'>)</font>;
  <b>}</b> <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>header.ncolors <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>1</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>header.ncmap <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <b>{</b>
    source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>visual     <font color='#5555FF'>=</font> MAPPEDGRAY;
    <font color='#BB00BB'>TRACEMS3</font><font face='Lucida Console'>(</font>cinfo, <font color='#979000'>1</font>, JTRC_RLE_MAPGRAY, width, height,
             <font color='#979000'>1</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>header.cmaplen<font face='Lucida Console'>)</font>;
  <b>}</b> <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>header.ncolors <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>1</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>header.ncmap <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font> <b>{</b>
    source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>visual     <font color='#5555FF'>=</font> PSEUDOCOLOR;
    <font color='#BB00BB'>TRACEMS3</font><font face='Lucida Console'>(</font>cinfo, <font color='#979000'>1</font>, JTRC_RLE_MAPPED, width, height,
	     <font color='#979000'>1</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>header.cmaplen<font face='Lucida Console'>)</font>;
  <b>}</b> <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>header.ncolors <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>3</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>header.ncmap <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font> <b>{</b>
    source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>visual     <font color='#5555FF'>=</font> TRUECOLOR;
    <font color='#BB00BB'>TRACEMS3</font><font face='Lucida Console'>(</font>cinfo, <font color='#979000'>1</font>, JTRC_RLE_FULLMAP, width, height,
	     <font color='#979000'>1</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>header.cmaplen<font face='Lucida Console'>)</font>;
  <b>}</b> <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>header.ncolors <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>3</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>header.ncmap <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <b>{</b>
    source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>visual     <font color='#5555FF'>=</font> DIRECTCOLOR;
    <font color='#BB00BB'>TRACEMS2</font><font face='Lucida Console'>(</font>cinfo, <font color='#979000'>1</font>, JTRC_RLE, width, height<font face='Lucida Console'>)</font>;
  <b>}</b> <font color='#0000FF'>else</font>
    <font color='#BB00BB'>ERREXIT</font><font face='Lucida Console'>(</font>cinfo, JERR_RLE_UNSUPPORTED<font face='Lucida Console'>)</font>;
  
  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>visual <font color='#5555FF'>=</font><font color='#5555FF'>=</font> GRAYSCALE <font color='#5555FF'>|</font><font color='#5555FF'>|</font> source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>visual <font color='#5555FF'>=</font><font color='#5555FF'>=</font> MAPPEDGRAY<font face='Lucida Console'>)</font> <b>{</b>
    cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>in_color_space   <font color='#5555FF'>=</font> JCS_GRAYSCALE;
    cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>input_components <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
  <b>}</b> <font color='#0000FF'>else</font> <b>{</b>
    cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>in_color_space   <font color='#5555FF'>=</font> JCS_RGB;
    cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>input_components <font color='#5555FF'>=</font> <font color='#979000'>3</font>;
  <b>}</b>

  <font color='#009900'>/*
   * A place to hold each scanline while it's converted.
   * (GRAYSCALE scanlines don't need converting)
   */</font>
  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>visual <font color='#5555FF'>!</font><font color='#5555FF'>=</font> GRAYSCALE<font face='Lucida Console'>)</font> <b>{</b>
    source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rle_row <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>rle_pixel<font color='#5555FF'>*</font><font color='#5555FF'>*</font><font face='Lucida Console'>)</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mem<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>alloc_sarray<font face='Lucida Console'>)</font>
      <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>j_common_ptr<font face='Lucida Console'>)</font> cinfo, JPOOL_IMAGE,
       <font face='Lucida Console'>(</font>JDIMENSION<font face='Lucida Console'>)</font> width, <font face='Lucida Console'>(</font>JDIMENSION<font face='Lucida Console'>)</font> cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>input_components<font face='Lucida Console'>)</font>;
  <b>}</b>

  <font color='#009900'>/* request a virtual array to hold the image */</font>
  source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>image <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mem<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>request_virt_sarray<font face='Lucida Console'>)</font>
    <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>j_common_ptr<font face='Lucida Console'>)</font> cinfo, JPOOL_IMAGE, FALSE,
     <font face='Lucida Console'>(</font>JDIMENSION<font face='Lucida Console'>)</font> <font face='Lucida Console'>(</font>width <font color='#5555FF'>*</font> source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>header.ncolors<font face='Lucida Console'>)</font>,
     <font face='Lucida Console'>(</font>JDIMENSION<font face='Lucida Console'>)</font> height, <font face='Lucida Console'>(</font>JDIMENSION<font face='Lucida Console'>)</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;

<font color='#0000FF'>#ifdef</font> PROGRESS_REPORT
  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>progress <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font> <b>{</b>
    <font color='#009900'>/* count file input as separate pass */</font>
    progress<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>total_extra_passes<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
  <b>}</b>
<font color='#0000FF'>#endif</font>

  source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.buffer_height <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
<b>}</b>


<font color='#009900'>/*
 * Read one row of pixels.
 * Called only after load_image has read the image into the virtual array.
 * Used for GRAYSCALE, MAPPEDGRAY, TRUECOLOR, and DIRECTCOLOR images.
 */</font>

<b><a name='METHODDEF'></a>METHODDEF</b><font face='Lucida Console'>(</font>JDIMENSION<font face='Lucida Console'>)</font>
<b><a name='get_rle_row'></a>get_rle_row</b> <font face='Lucida Console'>(</font>j_compress_ptr cinfo, cjpeg_source_ptr sinfo<font face='Lucida Console'>)</font>
<b>{</b>
  rle_source_ptr source <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>rle_source_ptr<font face='Lucida Console'>)</font> sinfo;

  source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
  source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.buffer <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mem<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>access_virt_sarray<font face='Lucida Console'>)</font>
    <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>j_common_ptr<font face='Lucida Console'>)</font> cinfo, source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>image, source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row, <font face='Lucida Console'>(</font>JDIMENSION<font face='Lucida Console'>)</font> <font color='#979000'>1</font>, FALSE<font face='Lucida Console'>)</font>;

  <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
<b>}</b>

<font color='#009900'>/*
 * Read one row of pixels.
 * Called only after load_image has read the image into the virtual array.
 * Used for PSEUDOCOLOR images.
 */</font>

<b><a name='METHODDEF'></a>METHODDEF</b><font face='Lucida Console'>(</font>JDIMENSION<font face='Lucida Console'>)</font>
<b><a name='get_pseudocolor_row'></a>get_pseudocolor_row</b> <font face='Lucida Console'>(</font>j_compress_ptr cinfo, cjpeg_source_ptr sinfo<font face='Lucida Console'>)</font>
<b>{</b>
  rle_source_ptr source <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>rle_source_ptr<font face='Lucida Console'>)</font> sinfo;
  JSAMPROW src_row, dest_row;
  JDIMENSION col;
  rle_map <font color='#5555FF'>*</font>colormap;
  <font color='#0000FF'><u>int</u></font> val;

  colormap <font color='#5555FF'>=</font> source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>header.cmap;
  dest_row <font color='#5555FF'>=</font> source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.buffer[<font color='#979000'>0</font>];
  source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
  src_row <font color='#5555FF'>=</font> <font color='#5555FF'>*</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mem<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>access_virt_sarray<font face='Lucida Console'>)</font>
    <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>j_common_ptr<font face='Lucida Console'>)</font> cinfo, source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>image, source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row, <font face='Lucida Console'>(</font>JDIMENSION<font face='Lucida Console'>)</font> <font color='#979000'>1</font>, FALSE<font face='Lucida Console'>)</font>;

  <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>col <font color='#5555FF'>=</font> cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>image_width; col <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font>; col<font color='#5555FF'>-</font><font color='#5555FF'>-</font><font face='Lucida Console'>)</font> <b>{</b>
    val <font color='#5555FF'>=</font> <font color='#BB00BB'>GETJSAMPLE</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>src_row<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>;
    <font color='#5555FF'>*</font>dest_row<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>JSAMPLE<font face='Lucida Console'>)</font> <font face='Lucida Console'>(</font>colormap[val      ] <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>;
    <font color='#5555FF'>*</font>dest_row<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>JSAMPLE<font face='Lucida Console'>)</font> <font face='Lucida Console'>(</font>colormap[val <font color='#5555FF'>+</font> <font color='#979000'>256</font>] <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>;
    <font color='#5555FF'>*</font>dest_row<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>JSAMPLE<font face='Lucida Console'>)</font> <font face='Lucida Console'>(</font>colormap[val <font color='#5555FF'>+</font> <font color='#979000'>512</font>] <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>;
  <b>}</b>

  <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
<b>}</b>


<font color='#009900'>/*
 * Load the image into a virtual array.  We have to do this because RLE
 * files start at the lower left while the JPEG standard has them starting
 * in the upper left.  This is called the first time we want to get a row
 * of input.  What we do is load the RLE data into the array and then call
 * the appropriate routine to read one row from the array.  Before returning,
 * we set source-&gt;pub.get_pixel_rows so that subsequent calls go straight to
 * the appropriate row-reading routine.
 */</font>

<b><a name='METHODDEF'></a>METHODDEF</b><font face='Lucida Console'>(</font>JDIMENSION<font face='Lucida Console'>)</font>
<b><a name='load_image'></a>load_image</b> <font face='Lucida Console'>(</font>j_compress_ptr cinfo, cjpeg_source_ptr sinfo<font face='Lucida Console'>)</font>
<b>{</b>
  rle_source_ptr source <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>rle_source_ptr<font face='Lucida Console'>)</font> sinfo;
  JDIMENSION row, col;
  JSAMPROW  scanline, red_ptr, green_ptr, blue_ptr;
  rle_pixel <font color='#5555FF'>*</font><font color='#5555FF'>*</font>rle_row;
  rle_map <font color='#5555FF'>*</font>colormap;
  <font color='#0000FF'><u>char</u></font> channel;
<font color='#0000FF'>#ifdef</font> PROGRESS_REPORT
  cd_progress_ptr progress <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>cd_progress_ptr<font face='Lucida Console'>)</font> cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>progress;
<font color='#0000FF'>#endif</font>

  colormap <font color='#5555FF'>=</font> source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>header.cmap;
  rle_row <font color='#5555FF'>=</font> source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rle_row;

  <font color='#009900'>/* Read the RLE data into our virtual array.
   * We assume here that (a) rle_pixel is represented the same as JSAMPLE,
   * and (b) we are not on a machine where FAR pointers differ from regular.
   */</font>
  <font color='#BB00BB'>RLE_CLR_BIT</font><font face='Lucida Console'>(</font>source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>header, RLE_ALPHA<font face='Lucida Console'>)</font>; <font color='#009900'>/* don't read the alpha channel */</font>

<font color='#0000FF'>#ifdef</font> PROGRESS_REPORT
  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>progress <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font> <b>{</b>
    progress<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.pass_limit <font color='#5555FF'>=</font> cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>image_height;
    progress<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.pass_counter <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
    <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>progress<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.progress_monitor<font face='Lucida Console'>)</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>j_common_ptr<font face='Lucida Console'>)</font> cinfo<font face='Lucida Console'>)</font>;
  <b>}</b>
<font color='#0000FF'>#endif</font>

  <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font>source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>visual<font face='Lucida Console'>)</font> <b>{</b>

  <font color='#0000FF'>case</font> GRAYSCALE:
  <font color='#0000FF'>case</font> PSEUDOCOLOR:
    <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>row <font color='#5555FF'>=</font> <font color='#979000'>0</font>; row <font color='#5555FF'>&lt;</font> cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>image_height; row<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font> <b>{</b>
      rle_row <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>rle_pixel <font color='#5555FF'>*</font><font color='#5555FF'>*</font><font face='Lucida Console'>)</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mem<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>access_virt_sarray<font face='Lucida Console'>)</font>
         <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>j_common_ptr<font face='Lucida Console'>)</font> cinfo, source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>image, row, <font face='Lucida Console'>(</font>JDIMENSION<font face='Lucida Console'>)</font> <font color='#979000'>1</font>, TRUE<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>rle_getrow</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>header, rle_row<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#ifdef</font> PROGRESS_REPORT
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>progress <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font> <b>{</b>
        progress<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.pass_counter<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
        <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>progress<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.progress_monitor<font face='Lucida Console'>)</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>j_common_ptr<font face='Lucida Console'>)</font> cinfo<font face='Lucida Console'>)</font>;
      <b>}</b>
<font color='#0000FF'>#endif</font>
    <b>}</b>
    <font color='#0000FF'>break</font>;

  <font color='#0000FF'>case</font> MAPPEDGRAY:
  <font color='#0000FF'>case</font> TRUECOLOR:
    <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>row <font color='#5555FF'>=</font> <font color='#979000'>0</font>; row <font color='#5555FF'>&lt;</font> cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>image_height; row<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font> <b>{</b>
      scanline <font color='#5555FF'>=</font> <font color='#5555FF'>*</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mem<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>access_virt_sarray<font face='Lucida Console'>)</font>
        <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>j_common_ptr<font face='Lucida Console'>)</font> cinfo, source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>image, row, <font face='Lucida Console'>(</font>JDIMENSION<font face='Lucida Console'>)</font> <font color='#979000'>1</font>, TRUE<font face='Lucida Console'>)</font>;
      rle_row <font color='#5555FF'>=</font> source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rle_row;
      <font color='#BB00BB'>rle_getrow</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>header, rle_row<font face='Lucida Console'>)</font>;

      <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>col <font color='#5555FF'>=</font> <font color='#979000'>0</font>; col <font color='#5555FF'>&lt;</font> cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>image_width; col<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>channel <font color='#5555FF'>=</font> <font color='#979000'>0</font>; channel <font color='#5555FF'>&lt;</font> source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>header.ncolors; channel<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font> <b>{</b>
          <font color='#5555FF'>*</font>scanline<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>JSAMPLE<font face='Lucida Console'>)</font>
            <font face='Lucida Console'>(</font>colormap[<font color='#BB00BB'>GETJSAMPLE</font><font face='Lucida Console'>(</font>rle_row[channel][col]<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> <font color='#979000'>256</font> <font color='#5555FF'>*</font> channel] <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>;
        <b>}</b>
      <b>}</b>

<font color='#0000FF'>#ifdef</font> PROGRESS_REPORT
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>progress <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font> <b>{</b>
        progress<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.pass_counter<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
        <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>progress<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.progress_monitor<font face='Lucida Console'>)</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>j_common_ptr<font face='Lucida Console'>)</font> cinfo<font face='Lucida Console'>)</font>;
      <b>}</b>
<font color='#0000FF'>#endif</font>
    <b>}</b>
    <font color='#0000FF'>break</font>;

  <font color='#0000FF'>case</font> DIRECTCOLOR:
    <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>row <font color='#5555FF'>=</font> <font color='#979000'>0</font>; row <font color='#5555FF'>&lt;</font> cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>image_height; row<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font> <b>{</b>
      scanline <font color='#5555FF'>=</font> <font color='#5555FF'>*</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mem<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>access_virt_sarray<font face='Lucida Console'>)</font>
        <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>j_common_ptr<font face='Lucida Console'>)</font> cinfo, source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>image, row, <font face='Lucida Console'>(</font>JDIMENSION<font face='Lucida Console'>)</font> <font color='#979000'>1</font>, TRUE<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>rle_getrow</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>header, rle_row<font face='Lucida Console'>)</font>;

      red_ptr   <font color='#5555FF'>=</font> rle_row[<font color='#979000'>0</font>];
      green_ptr <font color='#5555FF'>=</font> rle_row[<font color='#979000'>1</font>];
      blue_ptr  <font color='#5555FF'>=</font> rle_row[<font color='#979000'>2</font>];

      <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>col <font color='#5555FF'>=</font> cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>image_width; col <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font>; col<font color='#5555FF'>-</font><font color='#5555FF'>-</font><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#5555FF'>*</font>scanline<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>red_ptr<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
        <font color='#5555FF'>*</font>scanline<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>green_ptr<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
        <font color='#5555FF'>*</font>scanline<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>blue_ptr<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
      <b>}</b>

<font color='#0000FF'>#ifdef</font> PROGRESS_REPORT
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>progress <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font> <b>{</b>
        progress<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.pass_counter<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
        <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>progress<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.progress_monitor<font face='Lucida Console'>)</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>j_common_ptr<font face='Lucida Console'>)</font> cinfo<font face='Lucida Console'>)</font>;
      <b>}</b>
<font color='#0000FF'>#endif</font>
    <b>}</b>
  <b>}</b>

<font color='#0000FF'>#ifdef</font> PROGRESS_REPORT
  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>progress <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
    progress<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>completed_extra_passes<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
<font color='#0000FF'>#endif</font>

  <font color='#009900'>/* Set up to call proper row-extraction routine in future */</font>
  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>visual <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PSEUDOCOLOR<font face='Lucida Console'>)</font> <b>{</b>
    source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.buffer <font color='#5555FF'>=</font> source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rle_row;
    source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.get_pixel_rows <font color='#5555FF'>=</font> get_pseudocolor_row;
  <b>}</b> <font color='#0000FF'>else</font> <b>{</b>
    source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.get_pixel_rows <font color='#5555FF'>=</font> get_rle_row;
  <b>}</b>
  source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row <font color='#5555FF'>=</font> cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>image_height;

  <font color='#009900'>/* And fetch the topmost (bottommost) row */</font>
  <font color='#0000FF'>return</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.get_pixel_rows<font face='Lucida Console'>)</font> <font face='Lucida Console'>(</font>cinfo, sinfo<font face='Lucida Console'>)</font>;   
<b>}</b>


<font color='#009900'>/*
 * Finish up at the end of the file.
 */</font>

<b><a name='METHODDEF'></a>METHODDEF</b><font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font><font face='Lucida Console'>)</font>
<b><a name='finish_input_rle'></a>finish_input_rle</b> <font face='Lucida Console'>(</font>j_compress_ptr cinfo, cjpeg_source_ptr sinfo<font face='Lucida Console'>)</font>
<b>{</b>
  <font color='#009900'>/* no work */</font>
<b>}</b>


<font color='#009900'>/*
 * The module selection routine for RLE format input.
 */</font>

<b><a name='GLOBAL'></a>GLOBAL</b><font face='Lucida Console'>(</font>cjpeg_source_ptr<font face='Lucida Console'>)</font>
<b><a name='jinit_read_rle'></a>jinit_read_rle</b> <font face='Lucida Console'>(</font>j_compress_ptr cinfo<font face='Lucida Console'>)</font>
<b>{</b>
  rle_source_ptr source;

  <font color='#009900'>/* Create module interface object */</font>
  source <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>rle_source_ptr<font face='Lucida Console'>)</font>
      <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mem<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>alloc_small<font face='Lucida Console'>)</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>j_common_ptr<font face='Lucida Console'>)</font> cinfo, JPOOL_IMAGE,
                                  <font color='#BB00BB'>SIZEOF</font><font face='Lucida Console'>(</font>rle_source_struct<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
  <font color='#009900'>/* Fill in method ptrs */</font>
  source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.start_input <font color='#5555FF'>=</font> start_input_rle;
  source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.finish_input <font color='#5555FF'>=</font> finish_input_rle;
  source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.get_pixel_rows <font color='#5555FF'>=</font> load_image;

  <font color='#0000FF'>return</font> <font face='Lucida Console'>(</font>cjpeg_source_ptr<font face='Lucida Console'>)</font> source;
<b>}</b>

<font color='#0000FF'>#endif</font> <font color='#009900'>/* RLE_SUPPORTED */</font>

</pre></body></html>